## これは何?

- Icebergテーブルを実運用で使う上で、データコピー戦略(Data Copy Strategy)をどう設計するかについてのメモ。

## refs:

- https://chatgpt.com/g/g-p-6972148d77a08191a994cf59618df7b3-icebergtehurunituitediao-cha/c/69747347-3e70-8324-b34f-522a2afbff50

## 雑多めも

- 前提: 「prod -> devに反映」と言っても「何を重視するか」で思想やアプローチが変わりそう。
  - 再現性 (prodと同じ入力でデバッグしたい)
  - 安全性 (devで壊してもprodに影響しない)
  - 機密性 (prodの個人情報などをdevに持ってきたくない)
  - コスト (コピーでS3料金増える/スキャンコスト増えるのは避けたい)
  - 鮮度 (どれくらい最新まで寄せたいか)
- 考えられそうなアプローチ:
  - (1) 「devはprodの"同一スナップショット"を参照する」思想 (ゼロコピーっぽい)
    - アプローチ:
      - devカタログに、prodテーブルと同じdata locationを向ける
      - もしくはprodテーブルの特定スナップショットIDを固定参照。
    - メリット:
      - 処理が高速(コピーなしなので)
      - コスト最小 (データを複製しないので)
      - 再現性が高い (prodと全く同じデータを参照できる)
    - デメリット:
      - devから書き込みできる設定だと事故る可能性あり。なのでdevはread-onlyにするのが無難。
        - なので、**dev環境で書き込みやスキーマ進化などを動作確認したい場合には向かない。**
    - 向いてるケース:
      - prodデータでの調査・デバッグ・検証が主目的
      - dev環境ではread-onlyで十分
  - (2) 「devはprodのコピーだけど、毎回"ある時点"を同期する」思想 (スナップショット複製)
    - アプローチ:
      - 日次/手動でprod -> devへフルコピー(CTAS / Deep copy)
      - Icebergのスナップショットを基準に差分コピー。
    - メリット:
      - devで書き込みやスキーマ進化の動作確認ができる
      - prodとdevを環境として切り分けしやすい。
    - デメリット:
      - devへの反映にかかる時間が長い (フルコピー or 差分コピーの処理時間)
      - コピーにかかるストレージコストやスキャンコストが増える
    - 向いてるケース:
      - dev環境での書き込みやスキーマ進化の動作確認がしたい
      - データの持ち出し(devに置く)が許容される
  - (3) 「devはprodの"差分だけ"追随する」思想 (増分同期)
    - アプローチ:
      - 前回同期したsnapshot id を記録しておき、以降の追加分だけ取り込む。
    - メリット:
      - フルコピーよりは高速・低コスト
      - devで書き込みやスキーマ進化の動作確認ができる
      - devの鮮度を上げやすい(高頻度のsyncも可能)
    - デメリット:
      - Icebergの更新は append だけじゃなくて rewrite/overwrite/compaction も起きる
        - → “差分だけ見て追随” が難しくなることがある。
      - 実装・運用がちょい複雑。
    - 向いてるケース
      - prodの書き込みがほぼappendのみで、overwrite/rewriteがあまり起きない(ex. イベントログ系テーブル)
      - devを頻繁に最新寄せしたいが、コストは抑えたい。
