# リンク

- https://fastapi.tiangolo.com/ja/tutorial/
- https://fastapi.tiangolo.com/ja/tutorial/first-steps/

# 最初のステップ

最もシンプルなFastAPIファイルは以下。

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/")
async def root():
    return {"message": "Hello World"}
```

これをmain.pyにコピーし、以下のコマンドでライブサーバーを実行する。

```
uvicorn main:app --reload
```

`uvicorn main:app`コマンドの意味は以下：

- `main`: `main.py`ファイル。
- `app`: `main.py`内部で作られるobject(`app = FastAPI()`の様に記述される)。
- `--reload`:コードの変更時にサーバーを再起動させる。開発用。

その出力には、次のような行がある：

```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

この行はローカルマシンでアプリが提供されているURLを示している。

## チェック

ブラウザで、http://127.0.0.1:8000 を開く。
次のようなJSONレスポンスが表示される:

## 対話型APIドキュメント

次に、http://127.0.0.1:8000/docs にアクセスする。
自動生成された対話的APIドキュメントが表示される(Swagger UIで提供)

## 他のAPIドキュメント

次に、http://127.0.0.1:8000/redoc にアクセスする。
先ほどとは異なる、自動生成された対話的APIドキュメントが表示される (ReDocによって提供):

## OpenAPI

FastAPIは、APIを定義するためのOpenAPI標準規格を使用して、すべてのAPIの「スキーマ」を生成する。

- 「スキーマ」
  - 「スキーマ」は定義または説明です。実装コードではなく、単なる抽象的な説明(方法論??)
- API「スキーマ」：
  - ここでは、OpenAPIはAPIのスキーマ定義の方法を規定する仕様。
  - このスキーマ定義はAPIパス、受け取り可能なパラメータなどが含まれる。
- データ「スキーマ」：
  - 「スキーマ」という用語は、JSONコンテンツなどの一部のデータの形状を指す場合もある。
  - そのような場合、スキーマはJSON属性とそれらが持つデータ型などを意味する。

OpenAPIはAPIのためのAPIスキーマを定義する。
そして、そのスキーマはJSONデータスキーマの標準規格に準拠したJSONスキーマを利用するAPIによって送受されるデータの定義（または「スキーマ」）を含んでいる。

## `oepnapi.json`を確認

素のOpenAPIスキーマがどのようなものか興味がある場合、FastAPIはすべてのAPIの説明を含むJSON（スキーマ）を自動的に生成する。

次の場所で直接確認できる：http://127.0.0.1:8000/openapi.json

以下の様なJSONが表示される：

```json
{
    "openapi": "3.0.2",
    "info": {
        "title": "FastAPI",
        "version": "0.1.0"
    },
    "paths": {
        "/items/": {
            "get": {
                "responses": {
                    "200": {
                        "description": "Successful Response",
                        "content": {
                            "application/json": {



...

```

## OpenAPIの目的

OpenAPIスキーマは、FastAPIに含まれている2つの**インタラクティブなドキュメントシステムの動力源**。

そして、OpenAPIに基づいた代替案が数十通りある。
FastAPIで構築されたアプリケーションに、これらの選択肢を簡単に追加できる。

また、APIと通信するクライアント用のコードを自動的に生成するために使用することもできる。たとえば、フロントエンド、モバイル、またはIoTアプリケーション。

# ステップ毎の要約(main.pyの解説)

## Step 1: `FastAPI`をImport

FastAPIは、APIの全ての機能を提供するPythonクラス。

- FastAPIはStarletteを直接継承するクラス。
- FastAPIでも、Starletteの全ての機能を利用可能。

## Step 2:`FastAPI`のインスタンスを生成。

- `app`変数が`FastAPI`クラスのインスタンスになる。
- これが、全てのAPIを作成する為の主要なポイントになる。
- **この`app`は、コマンドで`uvicorn`が参照するものと同じ**。

例えば、以下のようなアプリを作成した場合...

```python
from fastapi import FastAPI

my_awesome_api = FastAPI()


@my_awesome_api.get("/")
async def root():
    return {"message": "Hello World"}
```

そして、それをmain.pyファイルにおき、次のように`uvicorn`を呼び出す。

```
uvicorn main:my_awesome_api --reload
```

## Step 3：path operationを作成

### パス

ここでの「パス」とは、最初の`/`から始まるURLの最後の部分を指す。
従って、次の様なURLでは：

```
https://example.com/items/foo
```

...パスは次の様になる。

```
/items/foo
```

- 情報: **「パス」は一般に、「エンドポイント」または「ルート」**とも呼ばれる！

APIを構築する際、「パス」は「concerns(関心事?)」と「resources(リソース)」を分離するための主要な方法である。

### Operation

ここでの「オペレーション」とは、HTTPの「メソッド」の1つを指す。
以下の様なものの1つ：

- POST
- GET
- PUT
- DELETE

更によりエキゾチックなもの：

- OPTIONS
- HEAD
- PATCH
- TRACE

HTTPプロトコルでは、**これらの「メソッド」の1つ(または複数)を使用して、各パスにアクセス**出来る。

APIを構築する時は、通常、これらの特定のHTTPメソッドを使用して、特定のアクションを実行する。
通常は以下を使用する：

- POST
  - データの作成
- GET
  - データの読み取り
- PUT
  - データの更新
- DELETE
  - データの削除

従って、OpenAPIでは、各HTTPメソッドは「オペレーション」と呼ばれる。

### Path Operation デコレータを定義

```python
# ...略

@app.get("/") # ここ！！
async def root():
    return {"message": "Hello World"}
```

`@app.get('/')`は、直下の関数が、下記のリクエストの処理を担当する事をFastAPIに伝える！

- パス: `/`
- オペレーション：`get()`

`@decorator`について：

- pythonにおける`@something`シンタックスは、デコレータと呼ばれる！
- 「デコレータ」は関数の上に置く。
  - 可愛らしい装飾的な帽子のようなもの。
  - (この用語の由来はおそらくそこ！)
- 「デコレータ」は直下の関数を受け取り、それを使って何かを行う。
  - 今回の場合、このデコレータは直下の関数がオペレーション`get`をパス`/`に対応させる事をFastAPIに通知する！
  - これが「Path Operation Decorator」

他のオペレーションも使用できる：

- `@app.post()`
- `@app.put()`
- `@app.delete()`

また、よりエキゾチックなものも使用できる。

- `@app.options()`
- `@app.head()`
- `@app.patch()`
- `@app.trace()`

豆知識：

- 各オペレーション(HTTPメソッド)は自由に使用できる。
- FastAPIは特定の意味付けを強制しない。
- ここでの情報は、要件ではなくガイドライン(＝強制しないけどオススメはある!)として提示される。
  - 例えば、GraphQLを使用する場合、通常は`POST`オペレーションのみを使用して全てのアクションを実行する。

## Step 4. パスオペレーションを定義

以下は「パスオペレーション関数」である：

- パスは'/'
- オペレーションはget
- 関数：デコレータの直下(`@app.get('/')`の直下)にある関数。

```python
# ...略

@app.get("/")
async def root(): # ここ！！
    return {"message": "Hello World"}
```

これは、Pythonの関数。

この関数は、`GET`オペレーションを使ったURL「`/`」へのリクエストを受け取る度に、FastAPIによって呼び出される。

この場合、この関数は`async`関数である。

`async def`の代わりに、通常の関数として定義する事もできる。

```python
# ...略

@app.get("/")
def root(): # ここ！
    return {"message": "Hello World"}
```

違いは、非同期処理にするか否か？？
https://fastapi.tiangolo.com/ja/async/#in-a-hurry 参照

## Step 5. コンテンツの返信

```python
# ...略

@app.get("/")
async def root():
    return {"message": "Hello World"} # ここ！！
```

dict, list, str, int等を返す事ができる。
Pydanticモデル(?)を返すこともできる(アトで詳しく！)

JSONに自動的に変換されるオブジェクトやモデルは他にもたくさんある(ORMなど)。

# まとめ

- FastAPIをImport
- appインスタンスを生成
- パスオペレーションデコレータを記述(@app.get("/"))
- パスオペレーション関数を定義(上記のdef root():　...のように)
- 開発サーバを起動(`uvicorn main:app --reload`)
