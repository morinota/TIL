# クエリパラメータと文字列の検証

FastAPI ではパラメータの追加情報とバリデーションを宣言することができます。

以下のアプリケーションを例にしてみましょう:

```python
from typing import Union

from fastapi import FastAPI

app = FastAPI()


@app.get("/items/")
async def read_items(q: Union[str, None] = None):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results
```

クエリパラメータ q は Optional[str] 型で、None を許容する str 型を意味しており、デフォルトは None です。そのため、FastAPIはそれが必須ではないと理解します。

# バリデーションの追加

qはオプショナルですが、もし値が渡されてきた場合には、50文字を超えないことを強制してみましょう。

## `Query`のインポート

そのために、まずは`fastapi`から`Query`をインポートします:

```python
from typing import Union

from fastapi import FastAPI, Query

```

## デフォルト値として`Query`を使用。

パラメータのデフォルト値として使用し、パラメータmax_lengthを50に設定します:

```python
app = FastAPI()


@app.get("/items/")
async def read_items(q: Union[str, None] = Query(default=None, max_length=50)): # ここ！
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results
```

- ちなみに

  - `Union[str, None]`は、データ型がstrかNoneって意味？？
    - 「str or int」のように「いくつかのある型のうちいずれか」にマッチすればOKという型ヒント！

- 情報
  - FastAPIは以下の部分を気にすることを覚えておいてください:
  - ` = None`
  - `= Query(default=None)`
  -

そして、さらに多くのパラメータをQueryに渡すことができます。この場合、文字列に適用される、max_lengthパラメータを指定します。

```python
q: Union[str, None] = Query(default=None, max_length=50)
```

これにより、データを検証し、データが有効でない場合は明確なエラーを表示し、OpenAPIスキーマの　path operation にパラメータを記載します。

## バリデーションを更に追加する。

パラメータ`min_length`も追加することができます:

```python
q: Union[str, None] = Query(default=None, min_length=3, max_length=50)
```

## 正規表現の追加

パラメータが一致するべき正規表現を定義することができます:

```python
q: Union[str, None] = Query(
        default=None, min_length=3, max_length=50, regex="^fixedquery$"
    )
```

この特定の正規表現は受け取ったパラメータの値をチェックします:

- `^`: は、これ以降の文字で始まり、これより以前には文字はありません。
- `fixedquery`: は、正確なfixedqueryを持っています.
- `$`: で終わる場合、fixedquery以降には文字はありません.

- もしこれらすべての 正規表現のアイデアについて迷っていても、心配しないでください。多くの人にとって難しい話題です。正規表現を必要としなくても、まだ、多くのことができます。
- しかし、あなたがそれらを必要とし、学ぶときにはすでに、 FastAPIで直接それらを使用することができます。

## デフォルト値

第一引数にNoneを渡して、デフォルト値として使用するのと同じように、他の値を渡すこともできます。
クエリパラメータqのmin_lengthを3とし、デフォルト値をfixedqueryとしてみましょう:

```python
async def read_items(q: str = Query(default="fixedquery", min_length=3)):
```

- 備考
  - デフォルト値を指定すると、パラメータは任意になる。

## 必須にする

これ以上、バリデーションやメタデータを宣言する必要のない場合は、デフォルト値を指定しないだけでクエリパラメータqを必須にすることができます:

```python
q: str
```

そのため、`Query`を使用して必須の値を宣言する必要がある場合は、第一引数に`...`を使用することができます:

```python
q: str = Query(min_length=3)
```

- 情報
  - これまで`...`を見た事ががない方へ: これは特殊な単一値です。Pythonの一部であり、"Ellipsis"と呼ばれています。

これは FastAPI にこのパラメータが必須であることを知らせます。

## クエリパラメータのリスト/複数の値

クエリパラメータを明示的に`Query`で宣言した場合、値のリストを受け取るように宣言したり、複数の値を受け取るように宣言したりすることもできます。

例えば、URL内に複数回出現するクエリパラメータqを宣言するには以下のように書きます:

```python
@app.get("/items/")
async def read_items(q: Union[List[str], None] = Query(default=None)):
    query_items = {"q": q}
    return query_items
```

そして、URLは以下:

```
http://localhost:8000/items/?q=foo&q=bar
```

複数のクエリパラメータの値`q`（`foo`と`bar`）をpath operation関数内で関数パラメータ`q`としてPythonの`list`を受け取ることになります。

そのため、このURLのレスポンスは以下のようになります:

```json
{
  "q": ["foo", "bar"]
}
```

- 豆知識
  - 上述の例のように、**`list`型のクエリパラメータを宣言するには明示的に`Query`を使用する必要が**あります。そうしない場合、リクエストボディと解釈されます。

### デフォルト値を持つ、クエリパラメータのリスト/複数の値

また、値が指定されていない場合はデフォルトのlistを定義することもできます。
`async def read_items(q: List[str] = Query(default=["foo", "bar"])):`

以下のURLを開くと:
`http://localhost:8000/items/`

`q`のデフォルトは: `["foo", "bar"] `となり、レスポンスは前の例と同様になります:

## より多くのメタデータを宣言する。

パラメータに関する情報をさらに追加することができます。

その情報は、生成されたOpenAPIに含まれ、ドキュメントのユーザーインターフェースや外部のツールで使用されます。

- `title`を追加できます:
- `description`を追加できます:

```python
q: Union[str, None] = Query(
        default=None,
        title="Query string",
        description="Query string for the items to search in the database that have a good match",
        min_length=3,
    )
```

## エイリアスパラメータ

- パラメータにitem-queryを指定するとします.
  - `http://127.0.0.1:8000/items/?item-query=foobaritems`
- しかし、item-queryは有効なPythonの変数名ではありません。
- 最も近いのはitem_queryでしょう。
- しかし、どうしてもitem-queryと正確に一致している必要があるとします...
- それならば、aliasを宣言することができます。エイリアスはパラメータの値を見つけるのに使用されます:

```python
async def read_items(q: Union[str, None] = Query(default=None, alias="item-query")):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results
```

## 非推奨パラメータ

さて、このパラメータが気に入らなくなったとしましょう

それを使っているクライアントがいるので、しばらくは残しておく必要がありますが、ドキュメントには非推奨と明記しておきたいです。

その場合、`Query`にパラメータ`deprecated=True`を渡します:

```python
    q: Union[str, None] = Query(
        default=None,
        alias="item-query",
        title="Query string",
        description="Query string for the items to search in the database that have a good match",
        min_length=3,
        max_length=50,
        regex="^fixedquery$",
        deprecated=True,
    )

```

# まとめ
`Query`を用いて、パラメータに追加のバリデーションとメタデータを宣言することができます。

一般的なバリデーションとメタデータ:
- `alias`
- `title`
- `description`
- `deprecated`

文字列のためのバリデーション:
- `min_length`
- `max_length`
- `regex`

この例では、strの値のバリデーションを宣言する方法を見てきました。

数値のような他の型のバリデーションを宣言する方法は次の章を参照してください。F
