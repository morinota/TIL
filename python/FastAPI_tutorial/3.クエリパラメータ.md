# クエリパラメータ

- パスパラメータではない関数パラメータを宣言すると、それらは自動的に "クエリ" パラメータとして解釈されます。
  - クエリはURL内で ? の後に続くキーとバリューの組で、 & で区切られています。
- 例えば、以下の様なURL内で`http://127.0.0.1:8000/items/?skip=0&limit=10`の場合、
  - クエリパラメータは
  - `skip`: 値は `0`
  - `limit`: 値は `10`
- これらはURLの一部なので、「自然に」文字列になります。
  - しかしPythonの型を宣言すると (上記の例では int として)、その型に変換されバリデーションが行われます。
- パスパラメータに適用される処理と完全に同様な処理がクエリパラメータにも施されます:
  - エディターサポート (明らかに)
  - データ「解析」
  - データバリデーション
  - 自動ドキュメント生成

## デフォルト

- クエリパラメータはパスの固定部分ではないので、オプショナルとしたり、デフォルト値をもつことができます。
  - 上述の例では、skip=0 と limit=10 というデフォルト値を持っています
- したがって、URL`http://127.0.0.1:8000/items/`にアクセスすることは...。
  - URL`http://127.0.0.1:8000/items/?skip=0&limit=10`にアクセスする事と同等になる。
- しかし例えば、`http://127.0.0.1:8000/items/?skip=20`にアクセスすると...
  - 関数内のクエリパラメータは以下の様になる：
  - `skip=20`: URL内にセットしたため
  - `limit=10`: デフォルト値

## オプショナルなパラメータ

- 同様に、デフォルト値を `None` とすることで、オプショナルなクエリパラメータを宣言できます:
  - 以下の場合、関数パラメータ q はオプショナルとなり、デフォルトでは None になります。

```python
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: Union[str, None] = None):
    if q:
        return {"item_id": item_id, "q": q}
    return {"item_id": item_id}
```

- 確認：
  - パスパラメータ item_id はパスパラメータであり、q はそれとは違ってクエリパラメータであると判別できるほどFastAPI が賢いということにも注意してください。
- 備考：
  - FastAPIは、= Noneがあるおかげで、qがオプショナルだとわかります。
  - Optional[str] のOptional はFastAPIでは使用されていません（FastAPIはstrの部分のみ使用します）。
    - _引数をOptionalとして設定するための表記法？？_
    - しかし、Optional[str] はエディタがコードのエラーを見つけるのを助けてくれます。

## クエリパラメータの型変換

bool 型も宣言できます。

## 複数のパスパラメータとクエリパラメータ

複数のパスパラメータとクエリパラメータを同時に宣言できます。FastAPIは互いを区別できます。

そして特定の順序で宣言しなくてもよいです。

名前で判別されます:

```python
app = FastAPI()


@app.get("/users/{user_id}/items/{item_id}")
async def read_user_item(
    user_id: int, item_id: str, q: Union[str, None] = None, short: bool = False
):
    item = {"item_id": item_id, "owner_id": user_id}
    if q:
        item.update({"q": q})
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

## 必須のクエリパラメータ

- パスパラメータ以外のパラメータ (今のところ、クエリパラメータのみ説明しました) の**デフォルト値を宣言した場合、そのパラメータは必須ではなくなる**。
- 特定の値を与えずにただオプショナルにしたい場合はデフォルト値を None にして下さい。
- しかし**クエリパラメータを必須にしたい場合は、ただデフォルト値を宣言しなければよい**。

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/items/{item_id}")
async def read_user_item(item_id: str, needy: str):
    item = {"item_id": item_id, "needy": needy}
    return item
```

ここで、クエリパラメータ `needy` は `str` 型の必須のクエリパラメータ。
例えばURL`http://127.0.0.1:8000/items/foo-item`をブラウザで開くと:
...必須のクエリパラメータ `needy` を加えなかったので、以下の様なエラーが表示されます:

```json
{
  "detail": [
    {
      "loc": ["query", "needy"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

`needy` は必須のパラメータなので、URLにセットする必要があります:
`http://127.0.0.1:8000/items/foo-item?needy=sooooneedy`

そして当然、あるパラメータを必須に、別のパラメータにデフォルト値を設定し、また別のパラメータをオプショナルにできます:

```python
@app.get("/items/{item_id}")
async def read_user_item(
    item_id: str, needy: str, skip: int = 0, limit: Union[int, None] = None
):
    item = {"item_id": item_id, "needy": needy, "skip": skip, "limit": limit}
    return item
```

この場合、3つのクエリパラメータがある：
- `needy`、必須の `str` 。
- `skip`、デフォルト値を 0 とする `int` 。
- `limit`、オプショナルな `int` 。

- 豆知識
  - パスパラメータと同様に、クエリパラメータに対しても`Enum`を使用して、取り得るパラメータの値を制限する事ができる。
