****# イントロダクション

## 空間情報(クロスセクション含む)の自己相関の理解が浅い話

## 空間的な自己相関が存在する

## 今回想定する例題

今回はヘドニック回帰(hedonic Regression)(＝基本的な線形回帰??)を例題として取り上げているが、紹介する手法群は様々な問題に適用可能。

- Hednic理論：
  - ミクロ経済学の理論。
  - 「品質によって財やサービスの値段が変わる。そうした品質の違いを前提に、需要と供給を考えましょう」みたいな理論。
- ヘドニック回帰：
  - ｙ(財やサービスの価格)、X(財やサービスの品質・特徴を表す変数)の関係を回帰分析で表すこと？
  - yはリンゴでも住宅でもOK!価格なら！

以下の章では、自己相関構造のモデル化に関わる基本的な問題を議論し、最も一般的に使用されている手法を比較対照する。

# 空間的自己相関のモデル化方法

空間的自己相関のモデル化には、一般的に2種類の方法がある。

- 1. (誤差項を生成する)プロセス自体をモデル化する方法。
  - 地理学者geographers(Cliff and Ord, 1981)の研究に基づく。
  - **重み行列weight matrix**を使用する必要がある。
  - Spatial Econometricsの文献では、より一般的なアプローチ。
- 2. 誤差項の共分散行列を直接モデル化する方法。
  - 地質学者geologistsの研究に基づく。

# 空間的自己相関のモデリング方法①：(誤差項を生成する)プロセス自体をモデル化する方法

このアプローチでは、誤差項を生成するプロセスを明示的にモデル化する。このプロセスにおける最もシンプルなモデルは以下。

$$
Y = X \beta + \mathbf{u} \tag{1.a}
$$

$$
\mathbf{u} = \lambda W \mathbf{u} + \mathbf{\epsilon} \\
(\epsilon_i \sim Norm(\mu = 0, \sigma^2))
\tag{1.b}
$$

- $\mathbf{u}$が$\mathbf{u}$自体によって影響を受ける、すなわち自己相関を持つ事を表す。
- 重み行列Wの主対角成分は0。つまり自分自身とは関係しない！他の要素と関係する！
- $u_i$が$\sum_{j=1}{W_{ij} u_j}$に依存する！
- これが上述した、"「誤差項ベクトルを生成するプロセス」をモデル化している"という意味！

## モデル式の解説:

- 回帰式(1.a)：
  - Y：住宅の販売価格を示すベクトル$\in \mathbb{R}^{N\times 1}$
  - X：住宅の特徴を表す行列$\in \mathbb{R}^{N \times K}$($K$は説明変数の数)
  - $\mathbf{u}$：空間的に相関する撹乱項ベクトル。$\in \mathbb{R}^{N\times 1}$
  - $\beta$：未知の回帰係数を示すベクトル $\in \mathbb{R}^{N\times 1}$
- 誤差項の相関関係を生成するプロセスを表す(1.b)
  - $\mathbf{\epsilon}$：各要素が独立した同一の一次元正規分布に従う誤差項ベクトル。
  - $\lambda$：未知の空間的自己相関パラメータ(スカラー)
    - つまり我々が最初に勉強した=空間的交互作用を考慮しないモデルは$\lambda=0$のケース！
    - $-1<\lambda<1$を仮定している。
    - 本論文では、プラスになる事=正の空間的自己相関が存在する事を期待する。
    - マイナスは珍しいらしい...。
      - ex)Aさんの家の値段が高い時、となりの家の価格が安い。
      - 自然界では起こりづらい?
  - $W$：データの空間構造(各観測地の空間的な関係)を表す重み行列$\in \mathbb{R^{n \times n}$

ここで分析者は、Wを事前に知っているものとみなしている。つまり、重み行列Wは推定すべきパラメータではなく、観測済みの値である。
従ってこの点で、**全ての分析結果は$W$の設定(特定)方法に依存**する！

- (例外としてPace et al 1998)
- このモデルは時系列のAR1モデルと似ている！
- また、時系列の場合と同様、様々な空間的なラグを用いる事でモデルを拡張する事ができる！

## 重み行列$W$の三種類の設定(特定)方法

重み行列Wは、このアプローチにおける最重要要素。

- Wは、主対角成分がゼロの、N×N行列。
- 非対角要素$W_{ij}$は、観察対象iとjの間の空間的関係を表す。
  Wの特定方法は主に三種類ある。

1. "最近傍Nearest Neighbors"を使用する方法
   - この方法(scheme)では、iとjが互いに最も近い関係にある場合に$W_{ij}=1$, それ以外の場合は$W_{ij}=0$とする
   - この手法は、1個の最近傍→n個の最近傍に簡単に拡張できる点が◎
     - ex. N-1個の内、iと最も近い上位n個のjに対してW_ij=1
2. 距離行列と閾値を元にした方法
   - iとjの間の距離が、事前に指定されたある閾値$L$よりも小さい場合に$W_{ij}=1$を設定する。
   - $W_{ij}=1 if D_{ij}\le L$
   - Dは距離行列。
3. 距離行列の逆数を元にした方法
   - Wの要素を2値化(0 or 1)するのではなく、$W_{ij}= \frac{1}{D^{p}_{ij}}$とする。
     - この場合、$W_{ij}>0$となる。
     - $p$は設定すべき定数。
   - 従って、観測地iとjの距離が近いほど、$D_{ij}$は小さく重み$W_{ij}$は大きくなる...！

上述した3つのW特定方法は、いずれも良く用いられるが、どの方法が住宅市場に表れる相関構造を最も良く実現しているかについては、合意が得られていない。

## 重み行列Wと撹乱項ベクトルuの関係性(Wを用いて、uの不均一分散性を表現している事を確認する。):

式(1.b)をuについて解くと、

$$ \mathbf{u} = (I - \lambda W)^{-1} \mathbf{\epsilon}$$

よって上記のuを、撹乱項ベクトルの共分散行列の式$V[\mathbf{u}] = E[\mathbf{u} \mathbf{u}^T]$に代入すると...

$$
V[\mathbf{u}] = E[\mathbf{u} \mathbf{u}^T] \\
= V[(I - \lambda W)^{-1} \mathbf{\epsilon}]
$$

(I - \lambda W)^{-1}は固定された(=非確率的な)行列なので、共分散行列の外側に出せる。

$$
(\because var[AX] = A \cdot var[X] \cdot A^T )\\
V[(I - \lambda W)^{-1} \mathbf{\epsilon}]
  = (I - \lambda W)^{-1} \cdot V[\mathbf{\epsilon}] \cdot ((I - \lambda W)^{-1})^T
$$

$V[\mathbf{\epsilon}] = \sigma^2 I$なので、

$$
= (I - \lambda W)^{-1} \cdot \sigma^2 I \cdot ((I - \lambda W)^{-1})^T
$$

転置と逆行列の性質(=順番入れ替え可能！)より、

$$
= (I - \lambda W)^{-1} \cdot \sigma^2 I \cdot ((I - \lambda W)^{T})^{-1}
$$

転置行列の性質より、

$$
= (I - \lambda W)^{-1} \cdot \sigma^2 I \cdot ((I^T - \lambda W^T)^{-1} \\
= (I - \lambda W)^{-1} \cdot \sigma^2 I \cdot ((I - \lambda W^T)^{-1}  \\
\because I^T = I
$$

スカラーである$\sigma^2$を前に出してきて...

$$
= \sigma^2 (I - \lambda W)^{-1} \cdot I \cdot (I - \lambda W^T)^{-1}
$$

ここで、V[u]はuの共分散行列。

- Vは通常、主対角線上に定数を持たない事に注意。
- ＝＞従ってこのタイプのモデルでは、uは分散不均一。（例え$\epsilon$が均一分散でも）

## 重み行列Wの各生成方法が意味する(自己)相関関係(相関図)

生成方法１～３のいずれでも、各観測データの位置が分かれば、距離行列$D$を計算する事ができる。
距離行列Dを元に、重み行列Wを計算できる。

相関図(Correlogram)は、空間的な依存関係を表現するのに便利なツール。
各ポイント間の相関関係を、ポイント間の距離の関数としてグラフ化したものである。

- 縦軸は、共分散行列V[u]の各要素である$V_{ij} = V_{ji}$の値。
- 横軸は、ポイントiとjの距離$D_{ij}=D_{ji}$の値。

Correlogramの良い特性は、「分離距離が増加すると、相関が減少する」こと
＝＞これは、Tobler(1970)の地理学の第一法則「**全てのモノは他の全てのモノに関係しているが、近くのモノは遠くのモノよりも関係している**」に従っている！

Correlogramは、観測データ(yやX)に基づいたものではなく、"観測地点と空間重み行列Wの生成方法が与えられた場合の母集団の相関図"である点に注意！！

もし、実際に観測された相関係数と距離の関係がむちゃくちゃ(Random)だったら、空間的な関係はない＝空間的な自己相関はない。
もしある関係性が観測(Non-Random)されたら、空間的な関係がある＝Spatial Autocorrelationが存在する！！

### 生成方法①Nearest Neighbor correlationの場合のCorrelogram

このW生成アプローチのCorrelogramから分かる事・特徴は以下。

- このWの生成方法によって示唆される空間的な相関は、距離に応じて低下する傾向にはあるが、**空間的相関は単調に低下するわけではない**。
  - ex) 図(2.a.1)では、同じ距離でもゼロと正の相関が混在している。
  - ＝＞**同じ距離を隔てた点でも、空間的相関が大きく異なる！**
- **ハイパーパラメータ(ex. n)の選択によって、空間的な相関構造が大きく変わる**！
  - これはこのアプローチの潜在的な弱点。
  - ＝＞分析者は通常、nを(推定するのではなく)選択するから！

Sample Locationの空間構造の場合の、生成方法1によって得られるWとVは以下。
![](../images/W_and_V_matrix_by_method1.JPG)

### 生成方法②$W_{ij} = 1 if D_{ij} <= L$の場合のCorrelogram

このW生成アプローチのCorrelogramから分かる事・特徴は以下。

- 生成アプローチ②の基本的な概念は①と似ている。
  - 重み行列の各要素はどちらの手法も2値(0 or 1)
- 一方で相違点①
  - "**Wの各行の1の数を指定する**"(＝Nearest Neighborがやってる事)のではなく、"**点が互いに影響しあう最大の距離を指定**"する事で、"各行の1の数"を決定する。
  - =>1が多い行も、1が少ない行も存在する。
- 相違点②：
  - Nearest Neighborとは異なり、**このアプローチによるWは常に対称性を持っている**！

従って概念に類似性はあるが、2つの方式は**異なる空間的相関のパターン**を生み出す事が分かる！(距離が離れるほど空間的相関は顕著に低下し、ゼロ相関を示すペアもある。)

「パラメータの選択が相関パターンに大きく影響する」点では、Nearest Neighborと同様(この手法の場合は、L)。

Sample Locationの空間構造の場合の、生成方法2によって得られるWとVは以下。
![](../images/W_and_V_matrix_by_method2.JPG)

### 生成方法③$W_{ij} = \frac{1}{D_{ij}^p}$の場合のCorrelogram

このW生成アプローチのCorrelogramから分かる事・特徴は以下。

- 他の2つのアプローチとの相違点:
  - Wの要素が分数。0 or 1の二値ではない。
- (重要)このアプローチでは、**Pが大きいほど、「影響の及ぶ範囲」が小さくなる**。
  - 従ってP=1~3の中では、P=3がNearest Neighborのn=1に最も近い設定となる。
- このアプローチの場合の空間的相関は、距離行列$D$の"バンド幅"が小さい程、空間的相関の発生する距離が小さくなる傾向にある(?)
  - 帯行列(Band Matrix)とは？
    - 非ゼロ要素が帯状に並んでいる行列の事。
    - バンド幅が大きくなると、より多くの点が隣り合っている為、相関はより均一になる。
- (重要)このアプローチで得られる相関関係$V[u]$のパターンは、**他のアプローチとは著しく異なる**点に注意！

Sample Locationの空間構造の場合の、生成方法3によって得られるWとVは以下。
![](../images/W_and_V_matrix_by_method3.JPG)

## 分析者の選択するべき(ハイパー)パラメータ

## 3つの空間的な重み付け(重み行列Wの生成)方法に関するDiscussion

３つのアプローチの選択次第で、相関パターンが大きく異なる事が示された。更に、各アプローチに関わるハイパーパラメータ選択も相関パターンに影響を与える。

3つの重み付け方式は全て妥当なものだが、その度合いはデータに対して異なる事を意味する。

例えば、空間的自己相関の最も一般的な検定の1つである"Moran's I statistic"(モランのI統計量)は以下の式で与えられる。

$$
I = \frac{N(e'W e)}{S(e'e)}
$$

ここで、

- N:観測Observationsの数.
- e: 回帰残差Regression Residualsのベクトル
- S :標準化係数?
- W :the weight matrix

上式のモランのI統計量は、空間的自己相関を考慮すべきかそうでないかの検定であるが、**明らかにこの検定の結果は、研究者のWの選択に条件付けられる**！(Can 1992)

- Canが3つの重み付けスキーム×2つの回帰モデル構造に対して、Iを検定した。
- =>3つは有意な空間的自己相関を示し、3つは示さなかった。
- =>Canは、どの重み付けスキームが正しいのか＝誤差が空間的に相関しているのかいないのかを知る方法がなかった…?
- =>その検定を使っても判断できなかった…???

# 空間的自己相関のモデリング方法②：誤差項の共分散行列を直接モデル化する方法

## 概要

- 1つ目のアプローチと異なり、**共分散行列(構造?)の関数形式**をDirectに仮定する。
- 仮定される関数のパラメータは、回帰係数と共に最尤法を用いて推定される。
- 仮定される関数に関しては、分離距離separation distanceの増加に伴って相関が低下するようなものが選択される。
- 空間計量経済学でよく使われるのは2.aの手法。2.bは地球統計学・空間統計学。

## 共分散行列(構造?)の関数形式の種類

以下のような関数形式が使用される。

1. Negative Exponential(負の指数型)：
   $$
   K_{ij} = b_1 \cdot \exp(-\frac{D_{ij}}{b_2})
   $$
2. Gaussian(ガウス型)：
   $$
   K_{ij} = b_1 \cdot \exp(-\frac{D_{ij}^2}{b_2})
   $$
3. Spherical(球面型)：
   $$
   K_{ij} =
   \begin{cases}
   b_1 \cdot (1- \frac{3D_{ij}}{2b_2} - \frac{D_{ij}^3}{2 b_2^3}) & if  0 < D_{ij} < b_2 \\
   0 & if  D_{ij} > b_2
   \end{cases}
   $$

ここで、

- Kは誤差項の相関行列($\sigma^2 K = V[u]$)。(**とにかくuの共分散行列の形を設定してる！**)
- $b_1, b_2$は、推定されるパラメータ?
- 上2つは、入れ子型(マトリョーシカ)。関係が深い。
  - ガウス型は、Negative Exponentialを含む。b^2よりも距離が大きいか小さいかを利用する。2.aのLimited modelのLと似ている。
- 3つ目は、他2つと関係がない。作成者が違うから。あんま使わないかも。

最近は、上2つの手法を使って、Weight Matrixを作る研究が提案されているらしい。

## 3種の共分散構造関数を用いた場合のCorrelogram(2.aと同じデータで)

(注意)2.aのCorrelogramとの違い：

- 2.aの相関図＝＞ハイパーパラメータ(研究者自身が設定)によるCorrelogramの変化。
- 2.bの相関図＝＞b1, b2は推定されるもの。
  - 観測されたデータから、下記の3×3 の相関図から、最適な関数((例えば、尤度を最大化する共分散構造関数と$b_1$と$b_2$))が決定される。
  - もちろん、図に示されたもの以外のb1とb2もOK!

### Correlograms for Negative Exponential

### Correlograms for Gaussian：

### Correlograms for Spherical：

## 3種類の共分散構造関数によるCorrelogramの比較

- 形としては似たようなグラフになる。
- ガウス型相関図は、負の指数型よりも、分離距離(横軸)が長くなると速く落ちる。
- またガウス型は、分離距離が非常に小さい場合に、より大きな重みを持つようになる。
- 球面型のCorrelogramは、負の指数型と非常によく似ている。
  - ＝＞原点付近(分離距離が非常に小さい場合)での振る舞いが異なる！
  - ＝＞球面型では、原点付近においてより高い相関が得られる！

# 2種類の空間的自己相関のモデル化方法に関するDiscussion：

## 2.a(重み行列を用いたアプローチ)の相関図と2.b(共分散構造関数を用いたアプローチ)のCorrelogramの結果の比較：

重み行列の相関図よりも、2.bの相関図の方が遙かになめらか。

- ＝＞相関構造が直接モデル化されてるから、他の点の位置に関係なく、所定の距離で区切られた全ての点が同じ相関を持つ事になるから！
- 重み行列の場合は、同じ距離間の点でも、他の点の位置によって相関の値が異なる！

## Discussion

上述の通り、空間的自己相関のモデル化には、空間重み行列を作る方法と、空間的な自己相関構造を直接モデリングする方法の2つがある。

そして、両手法において、研究者が決めるべき選択肢(=ハイパーパラメータ?)がある。

- 例えば(2.a)の場合は重み行列の形成スキームと、各形成スキームのハイパーパラメータ。(2.b)の場合は自己相関構造を仮定する関数形式, etc.
- それらの選択肢は、**データの空間的関係について異なる仮定**を意味する.(**Correlogramを参照**！)

では、どのモデルがどのような状況で最も効果的なのか？？
ほとんど示されていないが、2点、明らかになっている事がある。

1. 「可能な限り、モデルのパラメータを事前に選択するのではなく、推定する方が良い！」ということ。
   (=>著者は2.bを推奨？**2.aでもpやLを推定すべきパラメータとすればOK**！)

2. 空間的な自己相関が存在する可能性が高い状況では、空間的自己相関を考慮したモデルはどれでも、**自己相関を完全に無視したモデルよりも高い精度?(より有意?より高い再現性?)を示す**。

# 推定方法

# Other Issues

# 次回

- 今までは撹乱項に自己相関があると考えた。
  - ＝＞今度はYに自己相関があるケース、Xに自己相関があるケースも考える。
- モデルの中で、2カ所同時に自己相関が生じるケースはよくあり得る。
- 

# 参考
- Spatial Autocorrelation: A Primer(1998), Robin A. Dubin
