## 0.1. Reference

- https://geographicdata.science/book/notebooks/06_spatial_autocorrelation.html

## 0.2. Spatial Antocorrelationの導入

- 空間的自己相関の概念は、“functional relationship between what happens at one point in space and what happens elsewhere”
  - 「空間の1つのポイントで起こることと，他の場所で起こることの間の機能的関係」
  - ＝＞従って空間的自己相関は、「データ集合の中の観測地(Observation)間の**値の類似性**が、観測地間の**位置の類似性**にどの程度依存しているか」に関係してる。
- 時間的自己相関との関連（ただし別物）：
  - Temporal Autocorrelation「ある時点の変数の値とそれ以前の値を関連付ける」
  - Spatial Autocorrelation「**ある場所での**変数の値と、**他の場所での**同じ変数の値を関連付ける」
  - ＝＞これを理解する為の別の見方として、「ある場所での変数の値に含まれる、**他の場所での同じ変数の値に関する情報の度合い**」

## 0.3. Understanding Spatial Antocorrelation

空間的自己相関の概念をよりよく理解するためには、空間的自己相関がない場合、世界はどのように見えるかを考えることから始めるのが有効。

- 空間的ランダム性：
  - 観測の位置がその値について何の情報も与えない状況
  - 言い換えれば、ある変数が識別可能な空間的パターンに従って分布していない場合、その変数は空間的にランダムである。
- したがって、空間的自己相関は「空間的ランダム性の欠如」と定義することができる。

しかし、この定義ではまだ漠然としすぎている。そこで、より具体的に言うと、空間的自己相関は、**符号**と**スケール**の2つの次元で分類されるのが一般的。

### 0.3.1. Spatial Autocorrelationの符号について

従来の非空間的なケースと同様に、**空間的自己相関は正と負の2つの主要な形態**をとることができる。

- 前者（正のSpatial Autocorrelation）：類似性と地理的な近さが密接に関連する状況である。
  - つまり、**似たような値は近くにあり、異なる値は散らばって遠くにある**傾向がある。
  - これらの値の符号は、空間的自己相関の存在には関係ないことが重要である：高い値の近くに高い値があったり、低い値の近くに低い値があったりすること。
  - この文脈で重要なのは、**近さと統計的類似性の関係が正であること**です。
  - これは多くの社会的文脈でかなり一般的なケースで、実際、いくつかの人間現象は明らかに正の空間自己相関を示します。
    - 例えば、所得や貧困の空間分布を考えてみると、似たような値が近くにあるのが普通です（富裕層は他の富裕層と近く、貧困層も空間に集中している）
- 後者（負のSpatial Autocorrelation）：似たような値が互いに離れている傾向がある状況を反映
  - この場合、統計的な類似性は距離と関連している。
  - これは社会科学ではやや少ないが、まだ存在する。
    - 例えば、空間的な競争のプロセスに従う現象や、一連の施設の立地が最も高い空間的な被覆率を目指すような状況に見られるものである。
    - 異なるブランドのスーパーマーケットや病院の分布は、通常、負の空間依存のパターンに従っている。

### 0.3.2. Spatial Autocorrelationを考慮するスケールについて

また、空間的自己相関を理解するために、空間的自己相関を考慮するスケールを使用することもできる。
一般的に**Global** processes、**Local** processesという言い方をします。

- Global Spatial Autocorrelation：
  - 値の位置が従う全体的な傾向を考えるもの。
  - この分析は、データセットにおけるクラスタリングの度合いについての記述を可能にします。
    - 値は一般的に地理的な分布において特定のパターンに従っているか？
    - 似たような値は、純粋な偶然から予想されるよりも、他の似たような値に近いのだろうか？
    - これらは、グローバルな空間自己相関に関連する質問の一部です。
- Local Spatial Autocorrelation：
  - 地図全体よりもはるかに焦点を絞ったレベルでの、**グローバルなトレンドからの逸脱**に焦点を当てるもの。

# 1. Global Spatial Autocorrelation：

**Global Spatial Autocorrelationの存在、性質、強さについて**データを調査する。

そのために、Explanatory Spatial Data Analysis（ESDA、探索的空間データ解析）と総称される一連の手法を使用する。
非空間的なEDAと同様に、ESDAは上述した目的の為に特別に設計されており、**空間とデータセット内の観測の相対位置**を分析の最前線に置く。

ESDAの手法は幅広く、前章の人口分布図のような単純なアプローチから、統計的推論やデータの地理的配置の明示的な認識を含むより高度で堅牢な手法まで、様々なものがあります。本章の目的は、後者の手法群に足を踏み入れることです。

## 実証的図解 An Empirical Illustration

2016年、イギリスではEU残留か離脱かを決める国民投票、いわゆる「Brexit」投票が行われた。ここでは、選挙管理委員会から提供された、残留派と離脱派の投票率に関する自治体レベルの公式データを使用する。組み合わせるデータセットは2つある。

自己相関を調べる前に必要な最後の要素は、空間重み付け行列です。この例では、8つの最近傍を使用しますが、前の章の重みに関する議論がこの文脈でも適用されますし、他の基準も有効でしょう。また、行の標準化も行います。

- コロプレス図はデータの主な空間的パターンを探るのに適した方法である。
- 一見、正の空間的自己相関があるように見える。
  - EU離脱の投票率が高い自治体は互いに隣接している傾向があり（例えば、東部地域を参照）、離脱の投票率がかなり低い自治体も同様である（北部のスコットランドが良い例である）。
- しかし、人間は非常に優れたパターン検知能力をもっている。
  - =>傾向、パターン、関連性を見出すこの並外れた能力は、**多くの偽陽性を生み出す傾向がある**。

つまり、パターンがあると思い込んでいても、実際には見ているものはほとんどランダムであるというケースです。これは地図の場合に特に顕著で、コレオプレス・マッピングの章で見たように、**幾何学的な形や大きさが、基本的なパターンに対する我々の認識を著しく歪めてしまうことがある**。

- 例えば、上の地図を見れば、空間的な自己相関の存在を推測することができる。
- しかし、我々が見ているものが純粋な偶然から生まれたものかどうかを実際に判断することは、通常、言うほど簡単なことではない。

そして、これこそが、Global Spatial Autocorrelationの指標の目的である。統計学の力を借りて、まず**地図に存在する値の空間分布を要約**し、次に**ランダム性からの逸脱を正式に定量化**します。

しかし、統計を掘り下げる前に、**核となる構成要素である「Spatial Lag」**を理解する必要がある。この概念を理解することで、グローバルな空間自己相関を理解することができるようになります。

## Spatial Lag

Spatial Lag演算子は、空間解析における**空間重み行列($W$)の最も一般的かつ直接的な応用の一つ**。

- 数学的な定義は、$W$と変数ベクトル(＝分析対象の値)の積で表される。
- 概念的には、Spatial Lagは各場所の周囲における変数の挙動を捉えるもので、その点では、変数のローカルスムーザーに似ている（？？）

Spatial Lagは行列表記で次のように表されるWe can formally express it in matrix notation as:

$$
Y_{sl} = W \cdot Y
$$

or, in individual notation(要素毎の表記) as:

$$
y_{sl-i} = \sum_{j} w_{ij} y_j
$$

where

- $w_{ij}$ is the cell in $W$ on the $i$-th row and $j$-th column.
  - thus capturing the **spatial relationship** between observation $i$ and $j$.
- $y_{sl-i}$ thus captures the 各Observationの値と、iとのSpatial Weightの積、の和。
  - non-neighborsの重みは0であるため、iのneighborsの値と重みの積を表す事になる。
  - もしSpatial Weight Matrixがバイナリであれば、**$y_{sl-i}$はiのneighborsの値の合計**となる。

もし行標準化（一般的な変換）であれば，0と1の間で境界ができる．
したがって，**空間ラグは「Local Average」**，**各観測点の近隣の平均値**となる。
この後者の意味は、後述する空間的自己相関の分析を可能にするものである。

Spatial Lagは多くの空間分析手法の重要な要素であり、その為、Pysalでは完全にサポートされています。
任意の変数のSpatial Lagを計算するためには、以下のようにする事ができる。

```
db['Pct_Leave_lag'] = weights.spatial_lag.lag_spatial(
    w, db['Pct_Leave']
)
```

このSpatial Lagの背景を知るために、2つの地方行政区を覗いてみよう。

## Binary case: Join counts(結合回数)

Spatial Lagは、空間的自己相関を定量化するのに重要な役割を果たします。
それを使って、任意の場所での変数の振る舞いを、そのすぐ近くのパターンに関連付け始める事ができます。

最初の一歩は、単純化されたケースであるBinary値について。
(関心を持っている変数が2つの値しか取らないケース)

- この文脈では、**あるオブザベーション(x=1)が同じカテゴリ内(x=1)の他のオブザベーションに囲まれているかどうか**に関心があります。
  - たとえば、我々のデータセットに戻って、「離脱に投票した地方自治体が、同じく離脱に投票した他の人に囲まれている傾向がどの程度あるか」を評価したいのです。
  - 進めるために、まず、地方自治体が離脱に投票した場合は1を、そうでない場合は0を示すバイナリ変数 (Leave)を計算しましょう。

可視化してみると、このマップは正の空間的自己相関の明確なケースを表しているように見えます：
全体的に、与えられた観測が反対のカテゴリの他の観測に囲まれている目に見えるケースはほとんどありません。

この視覚情報から得られた評価を正式に調査するために、"**join count statistic**"と呼ばれるものを使うことができる。

### join count statisticの概念：

- 緑（G、値0）と黄色（Y、値1）の正方形があるチェッカーボードを想像してください。
- この統計のアイデアは、**マップ上の緑-緑（GG）、黄-黄（YY）、または緑-黄/黄-緑（GY）の結合（または隣接ペア）の発生をカウント**すること。
- この文脈では、GGとYYの両方が正のSpatial Autocorrelationを反映し、GYは負のSpatial Autocorrelationを捕らえる。
- この統計量の直感は、**完全な空間的ランダム性の場合**にどれだけのGG、YY、GYが予想されるかの**基準値**を提供し、これを**データセットで観察されたカウントと比較**することである。
  - 予想よりGG/YYが多く、GYが少ないという状況は、正のSpatial Autocorrelationを示唆し、反対に、GG/YYよりGYが多いという状況は、負のSpatial Autocorrelationを指すであろう。

**Spatial Weight Matrixは、ここでは「誰が隣人かそうでないか」を区別するためにのみ使用される**ので、結合数統計量には2値重み(=すなわち0か1)が必要です。したがって、**wを非標準化状態に戻す**ように変換しましょう。

join count statisticsは次のように計算できる：

```python
seed(1234)
jc = esda.join_counts.Join_Counts(db['Leave'], w)
jc
```

```
<esda.join_counts.Join_Counts at 0x7f1e75f2bd30>
```

Pysalではよくあることですが、**計算された統計量の値以外にも多くの情報を保持するオブジェクト（jc）**を作成しています。
例えば、GGの出現回数を確認することができます（属性がbbであることに注意、これは考えられる2つのクラスが黒と白である元の参照に由来しています）。

- `jc.bb`=>返り値は`871.0`。
- 同様にYYの出現回数は`ww`属性で確認することができる。
- また、GY+YGの出現回数は`bw`属性で確認できる。
- 上記3パターンの合計の出現回数は`J`属性で確認できる。

この統計量joint count statisticは、**各クラス（bb, ww, bc）の実際の結合数を空間的ランダム性の場合に期待される結合数と比較する**ことに基づいています。

- GGの期待値：`mean_bb`属性
- GY/YGの期待値：`mean_bw`属性

これらの値がランダムな偶然に由来する可能性が高いかどうかを知るための統計的推論は、**観測値のランダムな空間順列**(=すなわち、Spatial Weight Matrixをランダムに作り直す？？)を使用して、完全な空間ランダム性という帰無仮説の下で合成マップを作成することで行うことができます。

esdaはこのような合成パターン(＝すなわちランダムなSpatial Weight Matrixを使ったJoint countの値？)を999個生成し、これらのパターンから結合カウントの分布を使用して、観測された結合カウント統計の擬似値(=すなわちSpatial Raodomnessの場合に期待される結合数？？)を生成します。

- `jc.p_sim_bb`
- `jc.p_sim_bw`

これらの結果は、正のSpatial Autocorrelationの存在を明確に示しています。なぜなら、同じカテゴリーのペアの結合が予想以上に多く（`p_sim_bb`）、反対の結合が著しく少ない（`p_sim_bw`）からです。**擬似p値の生成**については、次のセクションで詳しく説明します。

## Continuous case(連続値の場合): Moran Plot and Moran’s I

次は関心のある変数が連続値である場合を考える。
この場合によく使われる統計量はMoran's Iで、以下のように定義される。

$$
I = \frac{n}{\sum_{i}\sum_{j} w_{ij}}
\frac{
    \sum_{i}\sum_{j} w_{ij} z_i z_j
}{
    \sum_{i} z_i^2
}
$$

where

- $n$ : 観測地の数
- $z_i$ : location $i$における標準化された関心のある変数
- $w_{ij}$ Spatial Weight Matrixの要素

その数学の背後にある直感を理解するために、まずグラフィカルな解釈、すなわち**Moran Plot**から始めると便利である。モランプロットは空間データセットを可視化し、Spatial Autocorrelationの性質と強さを調べる方法である。これは基本的に、関心のある変数がそのSpatial Lagに対して表示される伝統的な散布図です。値を平均より上か下かに解釈できるように、興味のある変数は通常、その平均を引くことによって標準化されます

# 2. Local Spatial Autocorrelation：
