## 0.1. 参考

- サンプルサイズの設計と検出力分析
  - https://bellcurve.jp/statistics/course/12769.html
- 効果量・検出力・サンプルサイズ
  - https://cogpsy.educ.kyoto-u.ac.jp/personal/Kusumi/datasem07/nunoi.pdf
- 効果量と検定力分析入門―統計的検定を正しく使うために―
  - https://www.mizumot.com/method/mizumoto-takeuchi.pdf
- そのABテストの結果は正しい？検定や統計学に基づき正しい判断をする方法
  - https://dlpo.jp/ab-test/ab-test5.php
- 【寄稿記事】インターネット広告で統計学の視点からワンランク上のABテストをするためのポイント
  - https://orangeplus.me/ab_test_internet/#:~:text=CVR%20%E3%81%AE%E5%80%A4%E3%81%AE%E4%B8%8A%E6%98%87,%E3%81%AE%E3%81%8C%E5%8A%B9%E6%9E%9C%E9%87%8F%E3%81%A7%E3%81%99%E3%80%82
- 効果量(effect size)のはなし\*渋谷駅前で働くデータサイエンティストのブログ
  - https://tjo.hatenablog.com/entry/2014/02/24/192655
- python statsmodel で、検定力 と、Sample Size の計算をする
  - https://www.monotalk.xyz/blog/With-python-statsmodel-calculate-the-verification-power-and-the-Sample-Size/
- 比率の差の検定におけるサンプルサイズの計算
  - https://zenn.dev/parcb/articles/sample-size-for-comparing-proportions

## 0.2. はじめに

サンプルサイズの設計および検出力分析とは、信頼性の高い実験を行うために実験の前後で行う分析のこと。

「**有意水準**」と「**検出力**」と「**サンプルサイズ**」と「**効果量**」はサンプルサイズの設計や検出力分析を行うための4大因子で、**このうち3つの因子の値が決まると、残りの1つの因子の値が**決まる。

# 1. 事前分析(A priori)：サンプルサイズの設計

- なにそれ?? -> **実験前に、検出したい差(=効果量)から適切なサンプルサイズを算出する事**。
  - ex)推薦システムのMLモデルのABテストにおいて、primary decision metricをCTRとした場合に、検出したいeffect sizeを2% (i.e. controlと比較してtreatmentのMLモデルではCTRが2%上がると期待すること)とした場合に、適切なサンプルサイズはどれくらい??
- サンプルサイズが小さすぎると...
  - 統計的仮説検定で対立仮説が棄却されtreatment施策が有効とは言えないと判断された場合、それがサンプルサイズの小ささに起因するものなのか、実際のeffect sizeの小ささに起因するものなのかを判断できなくなる。
  - また本来のtreatment施策は期待するeffect sizeを満たしているはずなのに、その差を検出できず実験自体に意味がなくなってしまうかも...。
- 一方で、サンプルサイズが大きすぎると...
  - 本来のtreatment施策は期待するeffect sizeを満たしていないのに、有意差ありとなってしまい、意思決定する上で実験自体に意味がなくなってしまうかも...。
  - またサンプルサイズを大きく設定すると、そのデータを収集する期間もしくはABテスト対象ユーザ数を増やす必要があり、コストやユーザ体験の悪化のリスクも大きくなる。
- したがって、**実験は適切なサンプルサイズに対して行う必要がある**。
  - サンプルサイズの設計には「有意水準」、「検出力」、「効果量」の値が必要。
  - 有意水準は0.05もしくは0.01が用いられることが多く、検出力は通常0.8に設定される。
  - よって、**実際に算出する必要があるのは、効果量(effect size)だけ**。(domainによっては、false negativeのリスクが高かったりするかも。医療分野とか。逆も然り。その場合は検出力や有意水準は別の値になりうるよね...!)

# 2. 事後分析(post hoc) -検出力分析

- 実験後は、その実験によってどの程度の効果があったのかを知るために検出力分析を行う。
- **検出力分析には「有意水準」、「効果量」、「サンプルサイズ」の値が必要**。
- これによりP値が真に効果があったためのものなのか否かという本来のもつ意味を知ることができる。
- また、追加実験を行う際の参考にもなる。
- 結局やることとしては、事前分析のサンプルサイズ設計と同じなのかな...! :thinking:

# 3. 例題

検定力分析を用いて適切な総サンプルサイズ（全テスト群での合計サンプルサイズ）を算出しようとしています。 サービス責任者と効果量を相談した結果、下記の設定で今回のABテストを実施することにしました。

- テストする群の数：2（一方を対照群、もう一方を介入群として「CVRに差があるか」の検定を行う想定）
- CVR：10％
- 目標CVR：11％
- 有意水準：0.05
- 検出力：0.8
- 両側検定
- 選択肢の中から、総サンプルサイズとして最も適切だと思われるものを一つ選んでください

## 3.1. まず効果量を仮定する?

- CVR：10％
- 目標CVR：11％
- 効果量のよりメタな(＝俯瞰的な)概念＝＞「**今相手にしている母集団には有意な効果があるとしたら○○ぐらいのeffect sizeがあるはずだ！そうでないなら検定で引っかからなくてもOK！**」みたいな「信条」を置くってこと。
  - そうすることで、積極的に必要なサンプルサイズを決めるための基準が生まれる！
- 今回のeffect sizeは $11-10 = 1$ %？
  - すなわち、施策によってCVRが1%上がることを期待している。よって統計的仮説検定では、CVRが1%上がったと言えるか否かを検出できれば良い。
-
