
## これは何??

- 参考: [Blueprints for recommender system architectures: 10th anniversary edition](https://amatria.in/blog/RecsysArchitectures)
- このブログ記事は、Netflixの元リードリサーチサイエンティストである Xavier Amatriain が、過去10年間の推薦システムのアーキテクチャの設計パターンをまとめたもの。


## 考え方1: Netflixの3層アーキテクチャ

2013年にNetflixの技術ブログで紹介された「3層アーキテクチャ」がベースになってる。
推薦システムの処理を以下の3つの層に分割する。

- オフライン処理(Offline)
- ニアライン処理(Nearline)
- オンライン処理(Online)

## 考え方2: Amazonの2✖️2アーキテクチャ

- Amazonのデータサイエンティスト Eugene Yan が提案したアーキテクチャ (2021年)
- オンライン処理とオフライン処理を2✖️2の行列に整理。
  - 行: Online / Offline
  - 列: Retrieval / Ranking
  - 行列の各要素について:
    - Offline*Retrieval: 埋め込みモデルの学習, アイテム埋め込みの事前計算, 近似近傍探索のためのインデックスの構築。
    - Offline*Ranking: ランキングモデルのための特徴量を作って特徴量ストアに保存。ランキングモデルの学習。
    - Online*Retrieval: 埋め込みモデルのencode。近傍探索でretrieve。
    - Online*Ranking: 特徴量を取得してランキングモデルで推論。推薦結果を作成。
- 特徴
  - Netflixの3層アーキテクチャとは異なり、ニアライン処理を省略。
  - 「検索(Retrieval)」コンポーネントを重視。
  - 行列分解 → 埋め込みモデル(Embedding Model)への移行の流れを考慮。
  - **Netflixの例と異なり、大規模なアイテムカタログを持つサービス向けの設計**。
    - Netflix はカタログが小さく全アイテムをランク付け可能だったが、Amazonのような大規模サービスでは「候補アイテムの検索（retrieval）」が必要。
    - そのため、retrieval+rankingの2-stages推薦を採用。

## 考え方3: Nvidiaの4段階アーキテクチャ

- NvidiaのMerlinチームが提案したアーキテクチャ
- Amazonの2✖️2アーキテクチャを拡張し、スコアリング(scoring)とランキング(ranking)を明確に分けた設計。
  - (**行が4つになって、4✖️2の行列になるイメージ**...!:thinking:)
  - 1段階目: 検索(retrieval)
    - ユーザに関連するアイテムを高速に取得(ex. 近似近傍探索)。
  - 2段階目: フィルタリング(filtering)
    - ユーザ属性やビジネスルールによる事前フィルタリング。
    - メモ: スコアリング前か後かはケースバイケース!!
  - 3段階目: スコアリング(scoring)
    - MLモデルによるスコアリング。
  - 4段階目: ランキング(ranking)
    - 探索(exploration)やオンラインテスト(ex. A/Bテスト, interleaving)を考慮した最終ランキング。

## 考え方4: Fennel.ai の8段階アーキテクチャ

- Fennel.ai のチームが発表した設計。
- Nvidiaの設計を拡張し、8つの段階に分割!
  - (つまり、4✖️2の行列が8✖️2の行列になったイメージ...??:thinking:)
  - (今回はあんまりオンライン/オフラインの区別を意識した設計じゃないかも??)

## 考え方5: ブログ著者の最新の提案

- 前述の考え方1~4を踏まえて、ブログ著者が提案する設計。
- 特徴
  - 1. 推薦システムにおいて、**データとフィードバックループが中心的な役割を果たす**ことを強調。
    - すべての推薦システムはデータ駆動であり、ユーザの行動データ(i.e. フィードバック...??)から継続的に学習する必要がある。
  - 2. 検索 (retrieval) と ランキング (ranking) の2つのMLモデルを考慮
    - 検索: 候補アイテムを高速に抽出する（埋め込みモデル）。
    - ランキング: ユーザーに最適な順番でアイテムを並べる（学習されたスコアリングモデル）。
  - 3. オフライン・オンライン・ニアラインの固定的な区別をなくす
    - 以前の設計（Netflix 3層アーキテクチャ）では、「オフライン」「ニアライン」「オンライン」 を明確に分けていた。
    - 今回の新設計では、**どのコンポーネントがオンライン／オフラインかは状況によって変わる**とする。
      - まあ例えば継続的学習の頻度はオンライン/オフラインの2値で明確に分類できるものではなくて、**グラデーション**だろうし...!:thinking: (ex. 1日一回はオフライン? 1時間ごとはオンライン??)
  - 4. オプションのコンポーネント（候補選択など）
    - 破線で示されたコンポーネントは、システムによって必要・不要が異なる。
    - ex. 候補選択 (Candidate Selection)
      - AmazonやYouTubeなど大規模カタログを持つサービスでは必須。
      - Netflixのようにカタログが小さい場合は不要（全アイテムをランキングできる）。
    - ex. スコアリング
      - スコアリングとランキングは必ずしも2つの別のコンポーネントである必要はなく、MLモデルが直接ランキング最適化できる場合もある。そのため、スコアリングはオプション。
  - 5. スコアリング後・ランキング後のポストプロセッシング
    - 推薦システムでは、スコアリング後やランキング後にフィルタリングを適用することが多い。
    - ex. 
      - スコアリング後のフィルタリング
        - ユーザーの 過去に見たアイテムを除外（重複排除）。
        - 特定のカテゴリやブランドを優先するビジネスルールを適用。
      - ランキング後のフィルタリング
        - 探索（exploration）のためにランダム性を加える。
        - オンラインテスト（A/Bテスト, interleaving）を行う。






