## 参考
- [Gunosyデータ分析ブログ](https://data.gunosy.io/entry/2018/10/15/080000)
- [Re:ゼロから始めるML生活 インターリービングについて勉強する](https://www.nogawanogawa.com/entry/interleaving)
- [A/Bテストより10~100倍効率的なランキング評価手法　インターリービング（Interleaving）のまとめと実践](https://qiita.com/mpkato/items/99bd55cc17387844fd62)

# Interleavingとは？
## 概要
- インターリービングは高感度なランキング評価手法。
  - 実験的に、**10倍から100倍従来のA/Bテストよりも効率的**であることが知られている(https://qiita.com/mpkato/items/99bd55cc17387844fd62)
- 従来のA/Bテストでは...
  - 2つのランキングリストを評価する際は、ユーザを2つの群に分け、各々に別々のランキングリストを提示し性能を評価する
- 一方でインターリービングでは...
  - 2つのランキングリストを**混ぜる**ことで新たなランキングを作成し、**同一のユーザー群**にそのランキングを提示し性能を評価する。
  - 同一のユーザー群で評価することで、極端な振る舞いをする少数のヘビーユーザーの行動に結果が左右されなくなるメリットもある

![](https://cdn-ak.f.st-hatena.com/images/fotolife/z/zer4/20181011/20181011150941.jpg)

- **ランキングリストの混ぜ方によって**、それぞれ名前がついている。
  -  代表的なものでは「Balanced Interleaving」「Team Draft Interleaving」「Probabilistic Interleaving」「Optimized Interleaving」がある。
- なお、**2つ**のランキングリストを1つに混ぜる手法は**インターリービング**と呼ばれ、**3つ以上**のランキングリストを混ぜる手法は**マルチリービング**と呼ばれる。

## 具体例(ex. Team Draft Interleaving)

Team Draft Interleavingを例に説明する。
チームドラフトは名前の通り、プロ野球のドラフト会議と同じような仕組み。
各チームの監督は、欲しい選手に対して以下の選好ランキングを持つと仮定する。

| 指名順位 | 監督1 | 監督2 | 
|------|-----|-----| 
| 1    | 選手A | 選手C | 
| 2    | 選手B | 選手B | 
| 3    | 選手C | 選手D | 
| 4    | 選手D | 選手A | 


ドラフト一巡目では、各チームの監督は抽選(ランダム)によって選手を選ぶ優先度が決まる。
ここでは監督1 < 監督2とする。

| 一巡目      | 
|----------| 
| 監督2: 選手C | 
| 監督1: 選手A | 

二巡目でも同様に、抽選によって選手を選ぶ優先度を決める。
ここでは、監督1 > 監督2とする。
**選手Bを両監督が指名**するため、優先度が高い監督1が選手Bを獲得し、**監督2は次に欲しい選手である選手Dを獲得**する。

| 二巡目      | 
|----------| 
| 監督1: 選手B | 
| 監督2: 選手D | 

一巡目、二巡目の結果をまとめると以下のようなリストが得られる。

| 混合ランキング  | 
|----------| 
| 監督2: 選手C | 
| 監督1: 選手A | 
| 監督1: 選手B | 
| 監督2: 選手D | 

このように**各巡目でランダムに優先度をつけ**、複数の選好リストから**アイテムを選択していく**手法が**Team Draft Interleaving**。
実際の推薦システムでは、**各監督＝テスト対象のアルゴリズム**に相当し、**選手＝ニュース記事**、**各監督による選手の指名順位＝各アルゴリズムによる記事の推薦結果**に当たる。
**ドラフトのi巡目＝ユーザーのリクエスト**の度に、混合ランキングを生成する。

## Interleavingの解釈

なぜインターリービング（マルチリービング）が**通常のA/Bテストよりも感度が高く**なるか = **1人のユーザーが何度も複数の選考リスト(各アルゴリズムによる推薦結果)を評価する**ことになるから...??

- インターリービングがA/Bテストよりも優れていると考えられる点について、(Radlinski et al. 2008)は、「**絶対評価**」と「**一対比較評価**」について論じている。
  - 味や音のような**感覚的なものの評価では「絶対評価」は難し**く、「一対比較評価」がよく用いられる
  - ランキングの評価においても「一対比較評価」が効果的であると主張
  - A/Bテストは、**同じユーザが2つのランキングを比較しているわけではない**ので、「一対比較評価」ではない。
  - 一方、**インターリービングは同じユーザが2つのランキングを暗に比較する**ことになるので、「一対比較評価」であると言える。
- ex)非常に性能がよく似たランキングを評価する場合
  - A/Bテスト
    - 最上位の結果がどちらも同等に良ければ、どちらのクリックスルーレートも変わらない
  - インターリービング
    - ユーザに対して暗に選択を行わせることになるため（例えば、ランキングAの最上位から得られた1件目をクリックするか、ランキングBの最上位から得られた2件目をクリックするか）、差が生じやすい。

# インターリービングの性能

hogehoge
[参考](https://qiita.com/mpkato/items/99bd55cc17387844fd62#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%AA%E3%83%BC%E3%83%93%E3%83%B3%E3%82%B0%E3%81%AE%E6%80%A7%E8%83%BD)



# 各手法の概要

最初のBalanced interleavingの提案に始まり、様々なインターリービング手法がこれまで提案されてきました。その中でも代表的な4種類の方法を以下で説明する。なお、これらの手法はすべて[interleaving](https://github.com/mpkato/interleaving)で実装されている。

- Balanced interleaving
  - 「2つのランキングから**交互に**検索結果を最上位から順に選択し1つのランキングを生成する」インターリービング手法。
- Team draft interleaving
  - 「2つの検索結果を選ぶごとに**先攻・後攻をランダムで決めながら**、両ランキングから1つずつ、まだ用いられていない検索結果を上位から順に選択していく」インターリービング手法
- Probabilistic interleaving
  - 「できるだけ各ランキング中の検索結果の順序を保持しつつも、相対的に低い確率で任意の順序での検索結果選択を許容する」インターリービング手法。
- Optimized interlaving
  - 「いくつかの制約のもと、生成されるランキングの感度の期待値を最大にするようなランキング提示確率を用いる」インターリービング手法。

## Balanced interleaving（均衡交互配置） (Joachims 2002a, Joachims 2003)

Balanced interleaving(2つのランキングから**交互に**検索結果を最上位から順に選択し1つのランキングを生成する)は以下のように行われる:



## Team draft interleaving（チームドラフト交互配置） (Radlinski et al. 2008)

## Probabilistic interleaving（確率的交互配置） (Hofmann et al. 2011)

- **Balanced interleavingとTeam draft interleavingの問題点を指摘**しつつ、新たな手法の提案を行ったのが(Hofmann et al. 2011)。
- Probabilistic interleavingでは、できるだけ各ランキング中の検索結果の順序を保持しつつも、相対的に低い確率で任意の順序での検索結果選択を許容する、というのが基本的なアイデアとなる。
  - Team draft interleavingでは、まだ結合ランキングに追加されていない検索結果のうち、最上位のものを決定的に選択していた。
  - これに対して、Probabilistic interleavingでは以下の順位のみに依存する確率で検索結果を確率的に選択する。

## Optimized interleaving（最適化交互配置） (Radlinski and Craswell 2013)

- Team draft interleavingでは、ランダムクリックに対するバイアスの問題は解決され、一方、その低い感度が問題とされていた。
- Optimized interleavingでは、いくつかの制約の下、この感度の期待値を最適化（最大化）するような結合ランキングを優先的に提示するインターリービング手法となっている。

(Radlinski and Craswell 2013)では、以下のような制約を結合ランキングは満たす必要があると主張した。
- 制約1:結合ランキングは元となるランキングと大きく異なってはならない。
  - つまり、どちらかのランキングか、その中間的なランキングでなくてはならない。
  - より厳密には、結合ランキングの任意の順位までの検索結果は、各ランキングのある順位i, jまでの検索結果の和集合でなくてはならない：
- 制約2: 結合ランキングに対してランダムなクリックを行った場合、両ランキングのいずれかが優れているという結論を導いてはならない。
