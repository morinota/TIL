## refs:

- [ドメインロジックのパターンは、ドメインモデルだけなの？](https://masuda220.jugem.jp/?eid=319)

# ドメインロジックのパターン

## そもそもドメインロジックってなんだっけ?

- そもそもドメインロジック (ビジネスロジック, ビジネスプロセス)とは?
  - 特定のビジネスやプロダクト固有の問題の解決方法を、ソフトウェアシステムに落とし込んだもの?
    - コアロジックと言い換えても良い?:thinking:
  - ex.
    - 在庫管理
    - 価格計算
    - ユーザ認証
- ドメインロジックでないロジックは??
  - -> アプリケーションサービスロジック
    - システムがスムーズに動作するためのコード?
- 一般的には、ユーザインターフェースやデータベース管理システムから分離して実装される。

## ドメインロジックの3パターン

- ドメインロジックをいい感じに設計・実装するかに焦点を当てたアーキテクチャパターンが3種類ある。
- 1. Domain Model (ドメインモデル)
- 2. Transaction Script (トランザクションスクリプト)
- 3. Table Module (テーブルモジュール)

## パターン1. Domain Model (ドメインモデル)について

- 複雑なビジネスロジックを、オブジェクト指向の原則を使用して表現する設計パターン。
  - 実世界のビジネスEntityをクラスとして表現し、これらのクラス間で関係を定義する。
  - **ビジネスロジックをEntityクラスの操作としてカプセル化**し、実世界のビジネスオペレーションを直感的に反映する構造を持っている。
- うちの会社も、メインはこれかも...!
  - 「ドメインモデル + サービス層 + Repository」みたいな!
  - ex. 顧客登録のアプリケーションの例:
    - CustomerRegisterService クラス (UIとの境界に、薄いサービス層)
    - Customer クラス (ドメインオブジェクト)
    - CustomerRepositoryクラス (データアクセスとの境界、仮想のデータベース)

## パターン2. Transaction Script (トランザクションスクリプト)について

- **サービス層のクラスに、ドメインの知識、ビシネスルールを集めていくのがTransaction Scriptパターン**。
  - 上述した顧客登録のアプリケーションの例で言うと...
    - CustomerRegisterServiceクラスはそのままに、ここにビジネスの知識を書き込んでいく。
    - 純粋なデータの入れ物クラスとして、Customerクラスを使う手はあるかも。
      - ちゃんとしたTransaction Scriptパターンならば、必要なデータは、サービスクラス内のインスタンス変数として持つのかも。
    - データベースアクセスのロジックは、Transaction Script(=ドメインのロジック)とは分離しておきたいので、Repositoryパターンはそのまま使うのかも。
    - なので、**Transaction Scriptパターンでは以下の2クラス構成**になる。
      - CustomerRegisterServiceクラス(トランザクションスクリプト = ビジネスロジックが書き込まれたサービスクラス)
      - CustomerRepositoryクラス (データアクセスとの境界、仮想のデータベース)

## パターン3. Table Module (テーブルモジュール)について

- **Repositoryクラスに、ドメインの知識、ビジネスルールを集めていくのがTable Moduleパターン**。
  - 顧客登録のアプリケーションの例で言うと...
    - CustomerRepositoryクラスに、ビジネスロジックを書き込んでいく。
    - なので、**Table Moduleパターンでは以下の1クラス構成**になる??
      - CustomerRepositoryクラス (データアクセスとビジネスロジックが書き込まれたクラス)

# でも結局はドメインモデル??

## データの入れ物はほしい

- どのパターンでも、実アプリケーションになれば、コード量が増え、変更も色々発生してくる。
- で、読みやすく、扱いやすいコードを目指してリファクタリングしていくとどうなるか??
  - -> **データの入れ物はほしい**
  - Transaction Scriptパターンでも、Table Moduleパターンでも、顧客を表すデータの入れ物は欲しくなる気がする。
- -> そうすると、個々のデータ毎の制約ルール(形式や値の範囲、ようはContract??)などやビジネスの知識は、データの入れ物の方に移動していくのかもしれない。
  - Transaction Scriptパターンの場合、登録サービスクラス(CustomerRegisterService)と変更サービスクラス(CustomerUpdateService)とで、そういった制約ルールのコードを重複させなくてすむので...!
- -> そんな感じで設計を改善していくと、単なるデータの入れ物クラスだったものが、ドメインオブジェクトとして成長していく。
  - なので、Transaction Scriptパターンをリファクタリングしていくと、ドメインモデルパターンと似ていくのかも...??

## データアクセスロジックの分離

- Transaction Scriptパターンでも、Table Moduleパターンでも、「ドメインの知識を表現してる箇所」と「データアクセスの手続き」はもちろん分離すべき。
  - そのほうが、コードの見通しが良くなるし、変更も簡単&安全になる。
- なので、Table Moduleパターンから「データアクセスの手続き」を外だしして、ドメインのロジックに抽象化していくと、結局こっちもドメインモデルパターンに近づいていくのかも...??

## ドメインモデルパターンだけじゃないけど、結局はドメインモデル??

Transaction Scriptパターンでも、Table Moduleパターンでも、

- 関心の分離
- カプセル化
- 変更の影響範囲の局所化

などの設計原則を追いかけてリファクタリングしていくと、

- 関連するデータ
- 関連するロジック

を、いい感じに凝集したドメインオブジェクトが増え、ドメインモデルパターンとして成長していくのかもしれない。
最初はTransaction ScriptパターンやTable Moduleパターンでドメインロジックを表現していても、ソフトウェアを改良しながら育てていくと、結局ドメインモデルパターンに近づいていくのかもしれない。
