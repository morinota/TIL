## refs

- 元記事:https://aws.amazon.com/jp/about-aws/whats-new/2023/11/amazon-sagemaker-pipelines-developer-ai-ml/?nc1=h_ls
- Sagemaker Pipelinesの公式ドキュメント:https://aws.amazon.com/jp/sagemaker/pipelines/
- classmethodさんの記事: https://dev.classmethod.jp/articles/update-reinvent2023-sagemaker-summary/#:~:text=Machine%20Learning%20Blog-,SageMaker%20Pipelines%E3%81%8C%E6%94%B9%E8%89%AF%E3%81%95%E3%82%8C%E3%81%9FPython%20SDK%E3%82%92%E6%8F%90%E4%BE%9B,-Python%20SDK(SageMaker
- stepデコレータの話: [Lift-and-shift Python code with the @step decorator](https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-step-decorator.html)
- AWS communiryの記事: [Sagemaker Pipelines using step decorators](https://community.aws/content/2bFfwOMvMaWfOuwUy30HMF1qgGb/sagemaker)
- [Quick Start - Using @step Decorated Step with Classic TrainingStep](https://sagemaker-examples.readthedocs.io/en/latest/sagemaker-pipelines/step-decorator/quick-start/notebooks/using_step_decorator_with_classic_training_step.html)
- [サンプルのnotebook](https://github.com/aws/amazon-sagemaker-examples/blob/main/sagemaker-pipelines/step-decorator/batch-examples/basic-pipeline-batch-inference.ipynb)
- [step decoratorの公式ドキュメント](https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#step-decorator)

## 概要

- 投稿日は2023年11月29日。
- 改善されたPython SDKによって、使い慣れたPython構文を使用して、MLワークフローを素早く定義できるようになった。
- 改善されたSDKの主な機能は以下:
  - **Pythonデコレータ(@step)**で簡単にpipeline内の各stepを定義できる。
    - @stepデコレータはかなり興味深いアップデートであり、pipelineに組み込みたい関数にデコレータを付与するだけで、**従来の記述よりもかなり簡素化した表現でpipelineを定義できそう**...??
  - ワークフロースケジューラー

## @stepデコレータについてメモ

- Python関数をpipelineのstepに変換するデコレータ。
  - 紐づけられた関数内のコードを、`DelayedReturn`オブジェクトにwrapする。

(注意点):**各引数の値が設定されていない場合の@step decoratorの挙動**:
  - 1. まずSagemakerのconfigファイルから値を検索しようとする。
    - (`config.yaml`のやつ!)
    - @step decorator がconfig.yamlを利用できるように、yamlが存在するディレクトリを`SAGEMAKER_USER_CONFIG_OVERRIDE`環境変数に保存する必要がある。
  - 2. config.yamlに値が見つからない場合、Sagemaker SDKのデフォルト値を使用する。
    - SDKのデフォルト値の詳細は[link](https://sagemaker.readthedocs.io/en/stable/overview.html#configuring-and-using-defaults-with-the-sagemaker-python-sdk)

@remoteデコレータもあるらしい。

decorator的な使い方もできるし、functionを引数にとって新しいfunctionを返すような使い方(＝高階関数的な使い方...!)もできるっぽい。
  - (decoratorってそもそも全て高階関数的な使い方ができる??:thinking_face:)

step decoratorをつけた関数の返り値 

- step decoratorをつけた関数の返り値は、`DelayedReturn`オブジェクトになる。
  - DelayedReturnの意味: 関数は即座に実行はされず、パイプライン実行時にstepが走るタイミングに実行される。
- 各stepの`DelayedReturn`オブジェクトはそのstepの出力を表し、他のstepの入力として使うことができる。
  - -> このように使うことで、**pipelineの各step間の依存関係を表現でき**、pipelineの定義時にstepの配列を渡せる...!
  - decorateする関数の返り値は、単数型でも、tuple型やlist型やdict型などのコレクション型でもOK...!
    - コレクション型の場合は以下のように参照できる。
      - `a_member = a_delayed_return[2]`
      - `a_member = a_delayed_return['a_key']`
      - `a_member = a_delayed_return[2]['a_key']`

step decoratorの場合、基本的にTrainingJobとして実行されるっぽい。

- でも特に各TrainingJob間の接続は開発者的には意識する必要がなくなる。
  - **ここがstep decoratorの特徴?? step間の接続方法が抽象化・情報隠蔽されてる感じ...!**
- 実行imageや、パッケージ依存関係はどう指定できるのか気になる。
  - stepごとに切り替えられる? もしくはpipeline内では共通になる?? :thinking_face:
- TrainingJob名がある程度コントロールできるのか気になる...!
  - デフォルトでは意味を解釈できないIDを含んだ名前になってしまう感があるので。
    - せめて{pipeline名}-{timestamp}-{step名} みたいな感じにしたい。


### step decoratorのparameters

- `name`: stepの名前を指定する。
  - デフォルトでは関数名と一意のIDを使用して生成。
- `display_name`: stepの表示名を指定する。
  - デフォルトでは関数名
- `description`: stepの説明を指定する。
  - デフォルトでは関数のdocstring
  