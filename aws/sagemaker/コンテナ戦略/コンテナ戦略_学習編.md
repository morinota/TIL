## refs

- [Amazon SageMaker におけるカスタムコンテナ実装パターン詳説 〜学習編〜](https://aws.amazon.com/jp/blogs/news/sagemaker-custom-containers-pattern-training/)
- [Amazon SageMaker におけるカスタムコンテナ実装パターン詳説 〜推論編〜](https://aws.amazon.com/jp/blogs/news/sagemaker-custom-containers-pattern-inference/)
- 各パターンのサンプルコード:
  - パターン1: [PyTorch extending our containers](https://github.com/aws/amazon-sagemaker-examples/tree/main/advanced_functionality/pytorch_extending_our_containers)
  - パターン2, パターン3。(basic-training-containerのみパターン3、それ以外はパターン2): [custom training containers](https://github.com/aws/amazon-sagemaker-examples/tree/main/advanced_functionality/custom-training-containers)

## これはなに?

- Sagemakerのカスタムコンテナの実装方法の選択肢が多い。各選択肢の適したusecaseを理解するための資料。

## はじめに

- Amazon SageMaker は機械学習のあらゆるステップを支援するフルマネージドサービス。
- Sagemakerの機能の中で、**最も汎用性の高いものとして、実行環境をマネージドで提供する機能**がある。
  - (ex. TrainingJob, ProcessingJob, BatchTransformなどのbatch処理サービス、Endpointなどの推論サービス)
  - この実行環境は**containerでの処理を前提としており**、ユーザは処理開始時に任意のcontainer imageを指定する。
- まず前提として、**ほとんどのusecaseでは、AWSが提供してるcontainer imageをそのまま利用できる**。(うんうん...!:thinking:)
  - しかし、特殊なライブラリをインストールしたい場合など、どうしてもカスタマイズが必要になるケースがある。
- カスタムコンテナの実現方法が複数あるので、どれを選択するかの意思決定が難しい。
- (感想メモ):
  - カスタムコンテナを採用する場合、管理とメンテナンスの負担が増加したり、セキュリティリスクが増加する可能性があるので、そもそもカスタムコンテナが必要かどうかはちゃんと議論したい気持ち...!:thinking:

## カスタムコンテナの実装パターン

大きく3つのパターンがある。

- 1. AWSが提供してるcontainer imageを拡張する方法。
- 2. 独自のcontainer imageにSagemaker Training/Inference Toolkitをインストールする方法。
- 3. スクラッチでcontainer imageを作成する方法。

パターン1が最も簡単で、パターン3が最も難易度が高い。

## パターン1: AWSが提供してるcontainer imageを拡張する方法

AWSが提供してるcontainer imageをそのまま利用しつつ、独自のライブラリ等を追加する場合に選ぶパターン。

- このパターンが最も実装が簡単。
- **一方で、カスタマイズの程度によってはそもそもカスタムコンテナが不要になる場合もあるので、まずは本当に必要かどうかを検討した上で選択すべき**...!(うんうん...!:thinking:)
  - ex.) pipでインストール可能なライブラリの場合
    - Sagemaker Python SDKの`Estimator`クラスのコンストラクタの`source_dir`引数でディレクトリを指定する。そのディレクトリ内に`requirements.txt`を配置しておけば、Sagemakerが自動でpip installしてくれる。
    - この場合、カスタムコンテナの利用は不要になる...!(うんうん...!:thinking:)

パターン1で重要なポイント:「**AWS提供のcontainer imageの中でどのimageをbase imageとして利用するか??**」

- AWS提供のcontainer image一覧のURIは、以下のdocument等から辿れる。でも面倒。

  - https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers-prebuilt.html
  - ブログでのおすすめは、一度目的のフレームワークのバージョンなどを指定して Estimator オブジェクトを作成し、`Estimator.training_image_uri()`メソッドで取得する方法。

- この選択ができれば、後はDockerfileで`FROM`でbase imageを指定して、imageのbuildとpushを行って、batch処理サービスの実行時に`image_uri`を指定するだけでOK。
  - base imageとしてAWS提供のものを使ってるので、Sagemakerとの連携機能は通常通り利用可能。
  - もちろん、Sagemaker Python SDKからではなくBoto3の`create_training_job`などのAPIを使ってもOK。

## パターン2: 独自のcontainer imageにSagemaker Training Toolkitをインストールする方法

- 有効なusecase: 独自のbase imageを利用したい場合や、フレームワークを独自のオプションでビルドしたい場合。
- Sagemaker Training Toolkit(以下 Toolkit)とは??
  - OSSのツール
  - TrainingJobのコンテナ内で利用される。
  - Sagemakerのサービスとの様々な連携機能が実装されている。スクラッチでこれを代替することは、実装工数が大幅に増える為、非推奨。

## パターン3: スクラッチでcontainer imageを作成する方法

-
