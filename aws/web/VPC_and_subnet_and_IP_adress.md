## 一つのAWS VPCは、一つのIPアドレスを持ちますか?

- いいえ。VPCは多くのIPアドレスを包含できる。
  - VPCはユーザーがAWS内で定義できる仮想ネットワーク空間。
  - VPC内では、1つ以上のサブネットを作成し、それぞれのサブネットには一つ以上のIPアドレス範囲が割り当てられる。
  - -> 一つのVPCは複数のIPアドレスを持つ。
- VPCの設定時にできること
  - IPアドレス範囲をCIDRブロックを使用して指定できる。
  - 複数のサブネットを作成し、異なるサブネットに異なるIPアドレス範囲を割り当てることができる。

## 1つのAWS subnetは、1つのIPアドレスを持ちますか?

- いいえ。AWSのサブネットも複数のIPアドレスを持つ。
  - サブネットはVPC内に作成される、IPアドレスの範囲を持つネットワークセグメント。
  - サブネット作成時には、それが属するVPCのIPアドレス範囲から更に小さなCIDRブロックを指定して、そのサブネットのIPアドレス範囲を定義する。
  - よって、**VPC内のsubnetのIPアドレス範囲は、VPCのIPアドレスの範囲の部分集合**になる。
  - subnet設定時のルール:
    - 複数のサブネットの範囲はVPCの範囲内で重複しないべき。
    - VPCのIPアドレス範囲を超えるようなサブネットは作れない。

## CIDRブロックの読み方難しい問題:

- CIDR（Classless Inter-Domain Routing）表記:
  - IPアドレスの範囲を効率的に指定する方法
- 解釈の仕方: VPCのCIDR`10.0.0.0/16`と、subnetのCIDR`10.0.1.0/24`を例に:
  - `10.0.0.0`や`10.0.1.0`の部分は、IPアドレス範囲の先頭アドレスを表す。
  - `/16`や`/24`の部分は、IPアドレス範囲の長さに関する情報。(**値がそのまま長さではない点に注意**!)
    - **IPv4アドレスは32bitで表現される**(2^32通り)。
    - `/16`の場合は最初の16bitが固定されている事を意味する。
      - -> 残りの32 - 16 = 16bitをホスト毎に割り当てる事ができるという範囲を意味する。
      - (よって、2^16通りのIPアドレスがVPCのIPアドレス範囲になる...!)
      - 具体的には`10.0.0.0`を範囲の先頭として`10.0.255.255`までの2^16 = 256^2 通り。
    - 同様に、`/24`の場合は、最初の24bitが固定されている事を意味する。
      - -> 残りの32 - 24 = 8bitをホスト毎に割り当てる事ができるという範囲を意味する。
      - (よって、2^8通りのIPアドレスがsubnetのIPアドレス範囲になる...!)
      - 具体的には `10.0.1.0`を範囲の先頭として`10/0.1.255`までの2^8 = 256通り。
- つまり、CIDR表記において、**スラッシュの後の数値が大きいほど、そのサブネットはより小さな範囲のIPアドレスを持つことになる**。
- CIDR表記: `{IPアドレス範囲の先頭}/{固定されているbit数}`

## VPCとsubnetとセキュリティグループとルートテーブルの関係性について!

- VPC(Virtual Private Cloud):
  - AWSクラウド内に仮装ネットワークを作成するためのサービス。
    - VPCによって、仮想ネットワーク環境を完全に制御でき、**AWSリソース(EC2インスタンス、RDSインスタンスなど)をこのネットワーク内に配置**できる。
  - 利点:
    - ネットワークを分離できる。セキュリティ○
    - IPアドレス範囲を管理できる。
    - 外部ネットワークとの接続を管理できる。
- サブネット:
  - VPC内のIPアドレス範囲から、部分集合を切り出して分割したもの。
    - (**あ、じゃあサブネットの実体って、IPアドレス範囲なのか**...!!:thinking:)
    - サブネットを使うと、**VPC内で更にネットワークを分離し**、特定のリソース集合に異なるセキュリティポリシーを適用できる。(=サブネット毎に設定するルートテーブルのこと...??:thinking:)
  - public subnetとprivate subnetを選択できるっぽい??
    - public subnet: インターネットゲートウェイを持ち、インターネットに直接アクセスできる。
    - private subnet: NATゲートウェイを通じてインターネットアクセスを行うが、外部から直接アクセスはできない。
- セキュリティグループ:
  - AWSリソースへのアクセスを制御するための仮想ファイアウォール。
    - 各セキュリティグループには、インバウンド(受信)及びアウトバウンド(送信)のトラフィックに対するルールを設定できる。
  - ルールの設定:
    - **特定のIPアドレス範囲(=これってサブネットってこと??)**、ポート番号、プロトコルに基づいて、トラフィックを許可or拒否するルールを設定できる。
  - リソースにアタッチ:
    - **EC2インスタンス、RDSインスタンスなどのリソースにセキュリティグループをアタッチ**して使用する。
    - 単一のリソースに、複数のセキュリティグループをattachすることは可能??
      - Yes. これによりリソースへのアクセス管理が柔軟になる。
    - 複数のリソースに、同一のセキュリティグループをアタッチすることは可能ですか？
      - Yes. これにより複数のリソースに共通のアクセス制御ルールを適用でき、一元的な管理ができる。
    - (なんかこの観点で、セキュリティグループって、IAM Policyと似てますね! 単一のIAM Roleに複数のPolicyをattachすることもできるし、同一policyを複数のIAM Roleにattachして使い回すこともできるし...!:thinking:)
- ルートテーブル:
  - VPC内のネットワークトラフィックのルーティング(経路情報)を制御する。
    - **ルートテーブルは、VPC内の特定のサブネットにassociate(関連づけ)される**。
    - ルートテーブルでは、宛先(CIDRブロック)とターゲット(trafficの送信先)が定義される。
  - あるVPC内の、異なるサブネット間で通信させたい場合:
    - サブネットはデフォルトで相互に通信可能。
  - 異なるVPC内の、異なるサブネット間で通信させたい場合:
    - (VPC peering接続やセキュリティグループの追加に加えて、)**両方のルートテーブルを更新し、相手側のCIDRブロックへのルートを追加する必要がある**...!

ex.

```shell
aws ec2 create-route --route-table-id rtb-1 --destination-cidr-block 10.0.0.0/16 --vpc-peering-connection-id pcx-1a2b3c4d
aws ec2 create-route --route-table-id rtb-2 --destination-cidr-block 192.168.0.0/16 --vpc-peering-connection-id pcx-1a2b3c4d
```


## 特定のVPC内(の特定のsubnet内)のRDSインスタンスに、Sagemaker TrainingJobからアクセスするには??

- たぶんざっくり以下のような確認(or手順)が必要っぽい...!
  - 1. VPCの確認:
    - TrainingJobのインスタンスを起動させるVPCが、RDSインスタンスと同じVPC内にあるか、あるいはVPC peeringなどで接続されているVPC内にあるか確認する。
    - (これは同じVPC内で起動させてしまって問題ない気がするなぁ...:thinking:)
  - 2. サブネットの確認:
    - TrainingJobで起動させるインスタンスが所属するサブネットが、RDSインスタンスと同じサブネット内にあるか、あるいは通信可能なサブネットか確認する。
      - (サブネットってIPアドレス範囲なので、結局セキュリティグループの設定を確認する、って話になりそう...??:thinking:)
      - (これって、同じサブネット内で起動させてしまうデメリットとかあるんだろうか??:thinking:)
  - 3. セキュリティグループの設定:
    - **RDSインスタンスにattachされているセキュリティグループに、TrainingJobのインスタンスのIPアドレス範囲からMySQLのデフォルトポート（3306）へのアクセスを許可するインバウンドルールが含まれているか確認**する。なければ、必要に応じてルールを追加する。

対象のRDSインスタンスに関連づけられているセキュリティグループIDの一覧を取得するコマンド:

```shell
$ aws rds describe-db-instances --db-instance-identifier {my-rds-instance-id} --query "DBInstances[0].VpcSecurityGroups[*].VpcSecurityGroupId" --output text

sg-xxxxxxxxxxxxxx
```

対象のRDSインスタンスが所属するサブネットを取得するためのコマンド:

```shell
aws rds describe-db-instances --db-instance-identifier {my-rds-instance-id} --query "DBInstances[0].DBSubnetGroup.Subnets[*].SubnetIdentifier" --output text

subnet-xxxxxxxxxxxxxxxx       subnet-yyyyyyyyyyyyyy
```

## TrainingJobを、RDSと同じサブネットを指定して起動させるデメリット・メリットについて

- メリット:
  - 低レイテンシーの通信
  - セキュリティの向上
  - シンプルなネットワーク設定
- デメリット:
  - サブネットのリソース制限
  - 障害の影響範囲が広がる
  - ネットワーク分離の欠如

# セキュリティグループのinbound ruleの見方

ざっくり:

- インバウンドルールは、セキュリティグループが紐づけられたリソースに対して、**外部からのアクセスの流入を許可するためのルール**! 
- アウトバウンドルールは、逆に紐付けたリソースから外部へのアクセスの流出を許可するためのルール。
  - アウトバウンドルールは、デフォルトで全てのトラフィックを許可するように設定されていることが多い。(**なので基本はアウトバウンドルールは気にせず、インバウンドルールを確認すれば良いはず**...!:thinking:)

セキュリティグループの特徴

- リソース単位(ex. EC2インスタンス、RDSインスタンス)で許可するインバウンド、アウトバウンドトラフィックを定義する。
- ホワイトリスト方式なので、許可ルールのみ指定可能。
- 設定されたルールに序列はなく、全て評価される。ルールに載ってないものは全て拒否される。

トラフィックを制御するルールは、以下の内容を指定して登録される:

- タイプ
- プロトコル: 許可するプロトコルの種類 (TCP, UDP, ICMP, etc.)
- ポート範囲: 許可するポート番号。単一あるいは範囲で指定可能。
- Source(ソース、送信元)/Destination(宛先、送信先): 許可するトラフィックの送信元(inbound)、または送信先(outbound)を指定する。
  - **送信元/送信先は、以下のいずれかの方法で指定できる**(インバウンドルール毎に異なる設定方法っぽくて解釈難しいな...:thinking:):
    - 単一のIPアドレス
    - CIDRブロック表記によるIPアドレス範囲
    - prefixリスト(複数のIPアドレスを指定したリスト)のID。
    - セキュリティグループのID
