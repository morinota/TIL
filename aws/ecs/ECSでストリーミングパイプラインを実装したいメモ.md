## これは何?

- ECSでMLの特徴量生成ストリーミングパイプラインを実装する場合を考えて、色々調べるメモ.


## ECSについて

- AWS ECS (Elastic Container Service) は、AWS上でコンテナを実行するためのサービス。

### 3つの主要な概念:

- クラスター (cluster):
  - コンテナを実行するための**論理的なグループ**。
    - (あ、じゃあ例えば**A/Bテスト中などで、複数のnews encoderパイプラインを稼働させたい場合は、両パイプラインを異なるサービスで同じクラスターに配置する、みたいなイメージ...??**:thinking:)
  - 複数のAZに跨って構成できる。
  - クラスターはEC2もしくはFargate上で動作する。
- サービス (service)
  - クラスター内でタスクを管理する役割。タスクをスケールさせたり、**指定した数のタスクが常に動作するように維持**する役割。
  - ex.) 特定のルールに基づいて、タスクをスケールイン/アウトする。タスクがクラッシュしたら、新しいタスクを起動する。
  - メモ: **1つのECSサービスには、1つのタスク定義のみが紐づけられる...!:thinking:** 
    - サービスはタスク定義を元に、実際にタスクを実行し管理する...!
    - (同一のタスク定義を使用して複数のサービスを作成することは可能だが、各サービスは独立して管理される)
- タスク (task)
  - ECS上で動作する**コンテナの実行単位**。クラスター内で実行される1つ以上のコンテナの集まり。
  - タスク定義(task definition) で、どのコンテナイメージを使うか、どのリソース(メモリ、CPU)を割り当てるかを指定する。
    - メモ: **cdkではタスクではなくタスク定義を記述して、ECSサービスに紐づける、という理解...!!**:thinking:

### ECRから特定のコンテナイメージをpullしてきて、指定したエントリーポイントを実行させたい。

TypeScriptのcdkで定義する場合、どう実装できそうか。
(調べた感じ、ここはまあ特に問題なく実装できそう...!:thinking:)

- なんとなくどう定義するかのイメージ...!:thinking:
  - まずタスク定義!
    - 1. ECRリポジトリの参照
    - 2. タスク定義の作成
    - 3. タスク定義にコンテナを追加
      - 3-1. コンテナイメージを指定
      - 3-2. エントリーポイントを指定
      - 3-3. 環境変数を指定
      - 3-4. ログをどこに出力するか指定(CloudWatch Logsなど)
  - そして、タスク定義をクラスターやサービスに紐付ける!
    - 1. ECSクラスターを定義 (ここではクラスター名, VPC, などを指定)
    - 2. ECSサービスを定義
      - ここでサービスが所属するクラスター, サービスが管理するタスクの定義, 実行するタスク数などを指定する...!!

### パイプラインの種類ごとにリソースを独立させたいメモ

- 経緯:
  - 単一クラスター内で全てのstreaming feature pipeliesを含める場合、**A/Bテストしやすさなどを考慮して同一クラスター内の異なるサービス間で計算リソースを独立させたい**!!
    - ex. control variantのnews encoderとtreatment variantのnews encoderの計算リソースは完全に独立していて欲しい。そうでないと「treatmentの処理がcontrolに影響を与えてしまわないか...!」とA/Bテストするのが怖くなってしまう。
- どうやら**EC2のインスタンスタイプの指定は、どうやらサービスごとではなくクラスターごとっぽい??**:thinking:
  - EC2起動タイプの場合、インスタンスタイプをクラスターに紐づける感じになる。その場合、**クラスター内の全てのサービスがそのインスタンスタイプのインスタンスで動作する**っぽい...??
  - サービスごとに異なるインスタンスタイプを使いたい場合は、基本的には複数のクラスターを作成する必要があるみたい。　
    - 方法はなくはないらしいが、設定が複雑になってしまうっぽい。
    - (正直、管理するリソースを増やしたくないので、streaming feature pipelinesという単一のクラスターで管理したい...!:thinking:)
  - **おそらくEC2起動タイプの場合、サービス間で計算リソースを完全に独立させることは結構難しそう**...!:thinking:
- 一方で、**Fargate起動タイプの場合は、タスク定義でCPUとメモリの要件を指定するらしい...!** じゃあこっちの方が扱いやすい気がする...!:thinking:
  - Fargate起動タイプの場合、タスク間でリソースの共有は行われない。
  - なので当然、**サービス間でも計算リソースは独立**するはず。こうあるべき...!

