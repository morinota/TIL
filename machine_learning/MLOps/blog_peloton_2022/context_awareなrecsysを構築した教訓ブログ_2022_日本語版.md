# コンテキスト対応レコメンダーシステムの構築から得た教訓

執筆者: Shoya Yoshida, Arnab Bhadury, Neel Talukder, Shayak Banerjee, Alexey Zankevich and Vijay Pappu
2022年8月24日

前回の投稿では、Pelotonのパーソナライズチームがプラットフォームのホーム画面向けに機械学習ベースのレコメンダーシステムを構築するための最初の試みとして選んだモデルLSTMNetについて説明しました。LSTMNetは適切な選択でした。なぜなら、データストアはまだ初期段階で断片化しており、さまざまな異なる特徴を使用するのが難しかったからです。その結果、ワークアウトのシーケンスから単純に学習するLSTMNetは適しており、モデルのシーケンシャルな性質とフィットネスの連続的な性質との自然な対応もありました。また、LSTMNetを使用する際の欠点、例えばコンテキストの関連性の欠如や、新しいアイテムやユーザーに対応できないことについても詳述しました。

この投稿では、LSTMNetを反復するために、どのようにコンテキスト対応レコメンダーシステム(CARS)を構築してきたかを説明します。まず、推薦を行う際にコンテキストを意識する必要性を説明し、その後、私たちが学んできた教訓について詳しく掘り下げ、最後に今後の計画についてまとめます。

## フィットネスにおける文脈の重要性の理解

フィットネスは、無限の可能性を持つ各個人に特有の旅です。Pelotonでは、各クラスは異なるテーマ、音楽、フィットネスの分野、そして穏やかで落ち着いたスタイルから、刺激的で陽気なスタイルまでの世界的なインストラクターの指導スタイルによって特徴付けられています。言うまでもなく、ユーザーの行動や好みは大きく異なり、時間とともに進化し、同じユーザーであっても文脈によって変わることがあります。

例えば、あるユーザーは、金曜日の夜にPeloton Bikeでエネルギッシュな音楽のライブサイクリングクラスを選択する一方で、他の日には朝にヨガクラス、夜にモバイルアプリを使用して瞑想クラスを受講することを選ぶかもしれません。別のユーザーはPeloton Bikeを持っていないかもしれませんが、代わりにリビングのスマートTVから複数の筋力トレーニングクラスをストリーミングし、その後外に出てPeloton Appを使用してガイド付きの屋外ランクラスに参加するかもしれません。

さまざまな種類のワークアウトが利用可能であるため、ユーザーはその日のワークアウトを選ぶために多くの小さな決定を下さなければなりません。Pelotonの内部ユーザーリサーチチームは調査を行い、ユーザーがクラスを選択する際に直面する5つの重要な決定要因を特定しました。その要因は、時間、インストラクター、クラスの種類、気分、最近の状態であり、これらはすべて相互に関連しています。

### 時間

時間は、二つの相互依存的な側面に分解することができます。時間の一つの側面は、ユーザがトレーニングを行うことに対してどれだけの時間をかける意欲があるかということです。そして、もう一つの側面は、ユーザがこの決定を下す日、週、または年の時間です。一部のユーザは、その時に利用可能な唯一の時間が30分のトレーニングであるため、そのトレーニングを行うためにログインするかもしれません。しかし、状況は通勤前の平日朝では異なる可能性があり、また、ホリデーシーズンの土曜日の午後であれば決定も異なるかもしれません。時間はしばしば交渉不可能な決定要因となることがあります。

### 講師

前述のように、私たちは多様なバックグラウンドと教授スタイルを持つ世界クラスの講師を幅広く揃えています。私たちのユーザーのほとんどは、主に特定の好きな講師のクラスを受講します。気分によっては、Cody Rigsbyのクラスを受けて励ましの言葉をもらったり、挑戦的なワークアウトを指導することで知られるOlivia Amatoのクラスを受けたりするユーザーもいます。

### クラスの種類

多様なインストラクターがいることで、さまざまなプラットフォームで多様なクラスが提供されます。数字を見てみると、私たちは3つのプラットフォーム(Peloton BikeおよびBike+、Peloton Tread、そしてPeloton Appや最近リリースされたPeloton Guideを含むデジタル)を持ち、50人以上のインストラクター、10以上のフィットネス分野、そして各フィットネス分野内に数十の異なるシリーズがあります。さらに、Pelotonの各クラスには、そのクラスのスタイルに合ったキュレーションされた音楽プレイリストがあります。私たちのコンテンツライブラリは、想像できるほぼすべてのクラスの種類を満たすのに十分な多様性があります。Jess Simの「Flash 15」筋力トレーニングシリーズ(15分で筋肉痛になる可能性があります)からダンスカーディオ、そしてお気に入りのインストラクターによる瞑想コンテンツまで、私たちのライブラリには誰にでも合うものがあります。

### 気分

気分は、クラスでどのような雰囲気を求めるかに影響を与える可能性があります。おそらく、月曜日の早朝で、落ち着きを求める必要があると感じ、そのためにヨガやストレッチのクラスを選ぶでしょう。逆に、金曜日の夜に明るい気分であれば、お気に入りの音楽に合わせて楽しむためにグルーヴサイクリングのクラスを選ぶかもしれません。

### 最近の状態

ユーザーの最近の状態、特に最後に完了したワークアウトに関する情報も重要です。もし誰かが最近、下半身の筋力トレーニングクラスとコアエクササイズクラスを受講していた場合、使用した筋肉のバランスを取るために上半身のワークアウトを受けたくなるでしょう。同じワークアウトセッション内で、もし誰かが長時間のサイクリングクラスを終えたばかりであれば、心地よい10分間の下半身ストレッチクラスを受けたいと思うでしょう。また、ユーザーが怪我をしている場合など、外的な要因もあり、ユーザーは通常受けているクラスよりも簡単なクラスを選択しなければならないこともあります。

要するに、フィットネスの領域において、適切なクラスを選択することはユーザーのリアルタイムのコンテキストに大きく依存しています。したがって、Pelotonにおける理想的なレコメンダーシステムはコンテキストを認識し、ユーザーがいる多様な環境に動的に適応できる必要があります。

## LSTMNetの限界

前回のブログ記事で説明したように、LSTMNetは各ユーザをそのユーザが受講しているクラスのシーケンスで表現します。このユーザの表現は、特定のクラスの埋め込みと比較され、このユーザ-クラスペアの推薦スコアが算出されます。

LSTMNetの大きな制限の一つは、推薦に影響を与えるための文脈情報を使用できないことです。例えば、ユーザが朝早くにログインするか夜遅くにログインするかに関わらず、LSTMNetはこれらの文脈の変化に適応できません。なぜなら、文脈はモデルへの入力ですらないからです。

もう一つの大きな欠点は、新しいクラスに対するコールドスタート問題です。Pelotonでは、毎日数十の新しいクラスをリリースしています。LSTMNetは各クラスのために別々の埋め込みを学習しなければならないため、これは私たちに毎日最新のクラスをトレーニングデータに加えてこのモデルを再トレーニングすることを強いることになります。新しいユーザに対するコールドスタート問題も同様の問題です。ワークアウト履歴がないため、LSTMNetは推薦を計算するためのユーザに関する情報を持っていません。

これらの問題に対処するために、私たちはモデルが各ユーザとクラスのために暗黙的にブラックボックス表現をキャプチャすることに依存するのではなく、理想的にはモデルが明示的な特徴と文脈を使用して各ユーザとクラスの表現を作成することを望んでいます。

## コンテキスト対応推薦モデルの動作

コンテキスト対応推薦モデルは、明示的な特徴やユーザコンテキストなど、連続的であろうとカテゴリカルであろうと、あらゆる種類の入力を柔軟に受け入れることができるクリック率(CTR)モデルの一群です。具体的には、実験の結果、私たちは2019年にFacebookによってオープンソース化された深層学習推薦モデルであるDLRMを使用することに決めました。DLRMはユーザ-アイテムペアを入力として受け取り、ユーザがペアになったアイテムと相互作用する確率を出力します。

したがって、入力特徴は大きくユーザ情報とアイテム情報に分けることができ、各グループ内では静的特徴と動的特徴に分けることができます。

このパラダイムでは、ライブラリ内の各個別クラスの埋め込みを学習しません。代わりに、各クラスはそのメタデータによって表されるため、通常、新しくリリースされたクラスのすべての属性は既存のクラスで既に見られているため、LSTMNetの場合のようにモデルを再訓練する必要はありません。さらに、新しいユーザに対しても、モデルがユーザの静的特徴からいくつかの情報を推測できるため、LSTMNetと比較してコールドスタート問題が軽減されます。同様に、既存のPelotonメンバーが新しいプラットフォームに参加する「寒冷」スタート設定では、コンテキスト対応モデルはユーザが好むコンテンツの種類についてすでにある程度のアイデアを持っています。私たちの推薦システムをコンテキスト対応にすることで、フィットネスの旅の現在の段階に関係なく、すべてのユーザコホートを処理できる中央システムを実現します。

## バッチ処理からオンライン推論への移行

リアルタイムコンテキスト(例えば、時間帯)を入力として使用して推薦を計算する際の重要な観察点は、モデルもリアルタイムで予測を行う必要があるということです。しかし、現在私たちのシステムは、各ユーザの推薦が生成され、キャッシュされて、ユーザがログインしたときに単純に取得される日次バッチ処理ジョブを介して推薦を生成しています。したがって、コンテキスト対応モデルを真に活用するためには、オンライン推論に移行する必要があります。

このパラダイムシフトは簡単なものではなく、私たちのチームはこの旅を二段階で進めることに決めました。まず、LSTMNetと同等のパフォーマンスを持つDLRMでバッチ推論を行うパイプラインを開発します。次の段階として、推論部分をオンラインに移行し、DLRMにリアルタイムコンテキスト機能を追加します。システム構築に使用されるツールの詳細については、NVIDIAのGTC 2020カンファレンスでの私たちのチームの講演をご覧ください。現在、私たちはこの重要な変化の第一段階を完了しており、その過程で推薦システムの反復に関するいくつかの重要な教訓を学びました。

## 得られた教訓

### 各エンドツーエンドの反復をできるだけ迅速に行う

機械学習モデルの構築は、できるだけ多くのアイデアをできるだけ早く試すことに関するものです。これは、コンテキスト対応モデルを開発する際に特に当てはまります。なぜなら、調整すべきノブが無限に増えるからです。LSTMNetではこの問題はあまりありませんでした。なぜなら、そのモデルの唯一の入力はユーザのトレーニング履歴だからです。コンテキスト対応モデルでは、異なる特徴、特徴の前処理方法、ポジティブおよびネガティブサンプルを生成する方法の無限の組み合わせを探求するという贈り物と呪いがあります。このプロジェクトは、私たちの機械学習パイプラインにおける最初の主要な反復の一つであり、アイデアの各エンドツーエンドの実験をできるだけ迅速に行うことが絶対に重要であることを学びました。

プロジェクトの初期段階では、トレーニングデータの準備、データの前処理、モデルのトレーニング、モデルの評価というオフライン実験サイクル全体を通過するのに数時間かかりました。私たちはすぐに、2つの変更を行う必要があることに気付きました：並列実験を可能にし、データをダウンサンプリングすることで各実験を迅速にすることです。

並列実験を可能にすることで、異なる設定で複数の実験を同時に開始し、それらを並べて比較することができました。ダウンサンプリングの観点からは、評価に使用するユーザの数とトレーニングデータ自体をダウンサンプリングすることができます。これらのデータの両方をダウンサンプリングすることには注意が必要です。なぜなら、ユーザのサブセットで評価することは全体の人口の正確なイメージを与えない可能性があり、より小さなデータセットでトレーニングすることは、特に協調フィルタリングモデルがユーザの行動を真に理解するのを妨げる可能性があるからです。

しかし、いくつかの実験を行った結果、関連するすべてのユーザを使用して計算した評価指標は、実際にはランダムに選ばれたユーザの5%のみを利用した場合とほぼ同じ数値になったことがわかりました。さらに、全データセットと比較して10%のデータでトレーニングされたモデルは、オフライン評価指標でわずかな低下しか見られませんでした。コンテキスト対応モデルは技術的にはハイブリッドモデルであり、コンテンツと協調フィルタリングの要素を組み合わせているため、ユーザが少ないデータでもモデルがそれなりに良いパフォーマンスを発揮できる可能性があります。これらの変更により、私たちは全体のオフライン実験を桁違いに短縮することができました。ただし、開発中は新しい変更のスケーラビリティを確認するために、時折フルデータセットで実験を行いました。

### 評価への投資

評価は、間違いなくあらゆる実験において最も重要な側面です。特に開発の初期段階では、実際のユーザ、通常は私たちのチームメイトのモデル出力を定性的に評価することが非常に意義深いものでした。彼らの好みを知っているため、妥当性を確認するためです。

実際、定性的評価は、純粋な定量的指標では観察できなかった出力の問題を明らかにするのに役立ちました。例えば、私たちのシステムは、異なるプラットフォーム(すなわち、Peloton BikeとBike+、Peloton Tread、Peloton Appなど)に対して各ユーザに異なる推薦を生成します。これは、同じユーザであっても、異なるプラットフォーム間でユーザの行動が大きく変わるためです。しかし、Bikeプラットフォームでの私たちのチームメイトのモデル出力は、その人がPeloton Appで受講したことのあるインストラクターに過度に重みを置いていることがわかりましたが、通常は自転車では避けているものでした。このような洞察を検出することで、私たちは推薦を改善するためにいくつかの特徴量をより慎重に設計することができました。

しかし、定性的評価は手間がかかり、私たちが行っていたすべての反復に適しているわけではありません。そのため、私たちは主にオフライン評価指標、例えばKにおける平均適合率(MAP@K)に依存しました。特に開発の初期段階を過ぎてからはそうでした。

しかし、オフライン評価指標がオンラインパフォーマンスと常に相関しないというのは、Pinterestのような企業によって確認されている業界の一般的な問題です。オフライン評価が実際に役立つかどうかを確認するために、私たちはいくつかのmultivariateテストを実施しました。各バリアントは意図的に異なるMAP@Kのレベルを持ち、各々がどのようなオフラインパフォーマンスを達成するかを比較しました。その考えは、オフライン指標が高いモデルがオンライン指標も高くなることを観察できれば、開発中にオフライン指標を高めるために自信を持って最適化できるというものです。具体的には、この結果を使用することで、オフライン-オンライン指標相関チャートを確立することができました。ここでは、各バリアントのパフォーマンスがグラフにプロットされており、X軸がオフライン指標、Y軸がオンライン指標です。

このチャートを使って、私たちはまず、より高いオフライン指標がより高いオンライン指標につながるという自信を得ました。また、両者の実際の数学的関係も見え始めました。理論的には、完璧にフィットしたオフライン-オンライン相関チャートがあれば、最適なフィットのライフはオフライン指標の向上からオンライン指標の期待される向上を近似できるでしょう。これは、オンライン指標の向上が得られるかどうかを確認するために常にA/Bテストを実施する必要がないことを意味します。A/Bテストには時間がかかるため、これは有益です。完璧なオフライン-オンライン相関チャートは実際には存在しませんが、このチャートは私たちがオフライン指標にどれだけの信頼を置けるかを効果的に示しています。

しかし、この手法にはいくつかの特異点がありました。まず、私たちは、こちら側で何も変更を加えていなくても、オンライン指標が常に安定しているわけではないことを発見しました。私たちの主なオンライン指標である、ホーム画面での推薦クラスのコンバージョンは、その週にプラットフォームで何が起こっているかによって変動する可能性があります。例えば、新しいタイプのワークアウトクラスがリリースされたり、特別なイベントが進行中であったりすると、ユーザが推薦クラスを受講する通常の習慣から逸れる可能性があります。Pelotonでは、オフライン-オンライン相関チャートのためにデータポイントを蓄積し続けるために異なる多変量テストを実施することは、コンテンツの常に進化する状況のために非常に信頼性が低いことが証明されました。

したがって、オフライン-オンライン相関チャートは、信頼できる指標を見つけるのに役立つツールですが、まだ完璧には程遠いものです。その結果、私たちのチームは、評価アプローチの武器を増やすために、ページシミュレーションやリプレイを含むより洗練されたオフライン評価技術の開発を目指しています。

### 実験追跡ツールへの投資

私たちは、MLFLowのトレーニングおよび評価パイプラインの各ステップから、すべてのメトリックとモデルアーティファクトを記録し、保存します。これには、トレーニングデータのサイズ、正例と負例の比率、使用された特徴、さまざまな評価メトリック、そしてもちろんトレーニングされたモデルファイルが含まれます。しかし、並行して多くの実験が行われると、すぐに混乱し、どの実行が意図した変更に対応しているのかを見失う可能性があります。その結果、私たちはMLFlowおよび一般的な実験追跡に関するインフラにさらに投資し、手動で行わなければならない実験追跡の一部を軽減することを計画しています。

### より良いインフラストラクチャの信頼性がより良い開発者体験をもたらす

私たちは、モデルのトレーニングと評価ジョブを実行するために、Kubernetesを使用してAWSでGPUポッドを立ち上げることに依存しています。しかし、進行中の世界的なチップ不足のため、私たちのジョブを立ち上げることができない期間がありました。これにより開発者体験が妨げられ、私たちは一時的にAWSからリザーブドインスタンスを購入することで状況を改善しました。さらに、データをダウンサンプリングすることで、開発中に私たちのジョブが必要とするGPUの数を減らすことができ、これも問題を改善しました。私たちのチームは、インフラの観点から開発者体験を向上させるために、他のチームと密接に協力し続けています。

## 今後の計画

私たちが推論をオンラインに移行することによって、完全にコンテキストを意識したレコメンダーシステムの構築の次の段階に移行する中で、CARsに関して計画している他のエキサイティングなこともあります。

### コンテキストに基づくコンテンツの行の生成

CARSは、私たちのホームスクリーンに表示するコンテンツの行の多様性を拡大するために使用できます。時間のコンテキストを活用することで、「朝を始めるには…」や「一日を終えるには…」のような新しい行を作成でき、これらは特定の時間にユーザが特に好むコンテンツで満たされます。他の可能なコンテンツの行のタイプには、「昨日の60分のワークアウトから回復するために…」や「気分が高揚している場合は…」のような行が含まれるかもしれません。

### マルチヘッド予測

以前、私たちはコンテキスト対応モデルへの入力が非常に柔軟であることを説明しました。これらのタイプのモデルの出力についても同じことが言えます。従来のCTRモデルは、ユーザーがアイテムをクリックするかどうかを予測する「ヘッド」が1つだけです。しかし、これらのモデルを修正して複数のヘッドを持たせることができ、各ヘッドが異なるものを予測することで、モデルが同時に複数のタスクを学習できるようにします。Pelotonでは、ほとんどのクラスで複数の曲が再生され、ユーザはワークアウト中に明示的にその曲を気に入ることができます。このデータを使用することで、ユーザーがクラスの音楽を気に入るかどうかを予測するヘッドを追加でき、音楽に基づく推薦を行うことができます。また、ブックマークや他者への共有など、他のアクションを予測するための他のヘッドを追加する可能性も探ります。マルチヘッド予測を使用することで、ホーム画面やそれ以外の場所に追加するための異なるコンテンツの棚を作成できるようになります。

## 結論

私たちは、このブログで共有された学びが、コンテキスト対応のレコメンダーシステムを構築しようとしている他のチームに役立つことを願っています。私たちは、レコメンダーシステムとフィットネスの交差点で直面する非常にやりがいのあるユニークな課題に取り組み続ける中で、エキサイティングなロードマップを持っています。もしあなたやあなたの知り合いが私たちと一緒に働くことに興味があるなら、ぜひ私たちのキャリアページを訪れて、共に旅を始めましょう！
