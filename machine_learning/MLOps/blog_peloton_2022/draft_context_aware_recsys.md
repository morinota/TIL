# Pelotonのコンテキスト対応レコメンダーシステム構築から得た教訓

## 元記事情報

- **タイトル**: Lessons Learned from Building out Context-Aware Recommender Systems
- **著者**: Shoya Yoshida, Arnab Bhadury, Neel Talukder, Shayak Banerjee, Alexey Zankevich, Vijay Pappu
- **公開日**: 2022年8月24日
- **URL**: https://www.onepeloton.com/press/articles/lessons-learned-from-building-context-aware-recommender-systems

## 概要

PelotonのパーソナライゼーションチームがLSTMNetからContext-Aware Recommender Systems (CARS)への移行プロセスで得た教訓をまとめた記事。特にバッチ処理からオンライン推論への移行における課題と、実験プロセスの効率化について詳しく述べている。

## 背景: フィットネスにおけるコンテキストの重要性

Pelotonのユーザーリサーチチームは、ユーザーがクラスを選択する際に直面する5つの重要な決定要因を特定した:

1. **時間 (Time)**: トレーニング可能な時間の長さと、日・週・年の時間帯
2. **インストラクター (Instructor)**: 気分に応じて異なるインストラクターを選択
3. **クラスの種類 (Class Type)**: 50人以上のインストラクター、10以上のフィットネス分野
4. **気分 (Mood)**: 落ち着きたい、エネルギッシュになりたいなど
5. **最近の状態 (Recent State)**: 直近のワークアウト履歴や身体状態

![5つの決定要因](images/decision_factors.svg)

**重要な洞察**: 同じユーザーでも、コンテキストによって行動や好みが大きく変わる。

## LSTMNetの限界

前作のLSTMNetには2つの主要な制約があった:

1. **コンテキスト情報の欠如**: id-onlyな手法のため、時間帯などのコンテキスト情報を活用できない
2. **コールドスタート問題**:
   - 新しいクラスには個別の埋め込みが必要で、毎日再トレーニングが必要
   - 新規ユーザーにはワークアウト履歴がなく推薦ができない

## DLRM (Deep Learning Recommendation Model) の採用

Facebookが2019年にオープンソース化したDLRMを採用。

### DLRMの特徴

- **入力の柔軟性**: ユーザ-アイテムペアを入力とし、クリック確率を出力
- **特徴量の分類**:
  - ユーザ情報: 静的特徴(年齢、居住地など) + 動的特徴(時間帯、デバイスなど)
  - アイテム情報: 静的特徴(インストラクター、音楽ジャンルなど) + 動的特徴(リリース時期など)

### メリット

- メタデータベースの表現により、新クラスの再トレーニングが不要
- 新規ユーザーでも静的特徴から推論可能でコールドスタート問題を軽減
- ハイブリッドモデル(コンテンツ + 協調フィルタリング)の性質

![LSTMNetからDLRMへの移行](images/lstmnet_vs_dlrm.svg)

## バッチ処理からオンライン推論への2段階移行

リアルタイムコンテキストを活用するには、推論もリアルタイムで行う必要がある。チームは2段階アプローチを採用:

1. **第1段階**: LSTMNetと同等性能のDLRMによるバッチ推論パイプラインを構築 (完了)
2. **第2段階**: 推論をオンライン化し、リアルタイムコンテキスト特徴を追加 (計画中)

![バッチ処理からオンライン推論への2段階移行](images/two_phase_migration.svg)

## 実践から得た教訓

### 1. エンドツーエンド反復の高速化

**課題**: コンテキスト対応モデルは調整可能なパラメータが無限に増え、実験サイクルに数時間かかっていた。

**解決策**:
- **並列実験の実現**: 異なる設定で複数実験を同時実行
- **データのダウンサンプリング**:
  - 評価用ユーザーを5%にしても評価指標はほぼ同じ
  - トレーニングデータを10%にしても性能低下は軽微
  - ハイブリッドモデルの性質により、少ないユーザーデータでも良好なパフォーマンス
- **結果**: 実験時間を桁違いに短縮

![実験サイクル高速化の戦略](images/experiment_speedup.svg)

**注意点**: スケーラビリティ確認のため、時折フルデータセットでの実験も実施

### 2. 評価への投資

#### 定性的評価の重要性

開発初期段階では、チームメイトなど実際のユーザーに対する出力を定性的に評価。

**事例**: あるプラットフォームで推薦されたインストラクターが、別のプラットフォームでは避けているものだった。このような洞察により特徴量設計を改善。

#### オフライン-オンライン相関の検証

**目的**: オフライン指標(MAP@K)がオンライン指標と相関するか検証

**手法**:
- 異なるMAP@Kレベルを持つ複数variantでmultivariateテストを実施
- オフライン指標(X軸)とオンライン指標(Y軸)の相関チャートを作成

**結果**:
- より高いオフライン指標はより高いオンライン指標につながることを確認
- 理論的には、完璧な相関があればA/Bテストなしでオンライン改善を予測可能

**制約**:
- オンライン指標は常に安定しているわけではない(新コンテンツリリース、特別イベントなどの影響)
- Pelotonのような進化し続けるコンテンツ環境では、相関チャートの蓄積は困難
- **結論**: 「完璧ではないが役に立つ」ツール

![オフライン-オンライン指標の相関検証](images/offline_online_correlation.svg)

**今後の方向性**: ページシミュレーションやリプレイなど、より洗練されたオフライン評価技術の開発

### 3. 実験追跡ツールへの投資

**現状**: MLFlowで全メトリックとモデルアーティファクトを記録・保存

**課題**: 並列実験が多いと混乱し、どの実行がどの変更に対応するか見失う

**計画**: MLFlowおよび実験追跡インフラへのさらなる投資

### 4. インフラの信頼性と開発者体験

**課題**:
- 世界的チップ不足によりAWSでGPUポッドが立ち上がらない期間があった
- 開発者体験が妨げられた

**対策**:
- AWSからリザーブドインスタンスを購入
- データダウンサンプリングによる必要GPU数の削減

## 今後の計画

### 1. コンテキストに基づくコンテンツ行の生成

時間コンテキストを活用した新しいコンテンツ行:
- 「朝を始めるには…」
- 「一日を終えるには…」
- 「昨日の60分ワークアウトから回復するために…」

### 2. マルチヘッド予測

**概念**: 複数の予測ヘッドを持つモデルで、同時に複数タスクを学習

**応用例**:
- メインヘッド: クラスをクリックするか
- 追加ヘッド: クラスの音楽を気に入るか、ブックマークするか、共有するかなど

**メリット**: 音楽ベースの推薦など、多様なコンテンツ棚を作成可能

## 学びと考察

1. **id-only手法からの卒業**: メタデータベースの表現により、再トレーニング頻度を削減し、コールドスタート問題を軽減

2. **実験速度の重要性**: コンテキスト対応モデルでは調整可能なパラメータが劇的に増加するため、高速な実験サイクルが不可欠

3. **評価の多面性**:
   - 定性的評価で発見できる問題もある
   - オフライン-オンライン相関は完璧ではないが有用
   - 複数の評価手法を組み合わせることが重要

4. **段階的移行の賢明さ**: バッチ→オンラインの2段階移行により、リスクを分散し着実に進化

5. **ハイブリッドモデルの利点**: コンテンツと協調フィルタリングを組み合わせることで、少ないデータでも良好なパフォーマンス

6. **ドメイン特性の理解**: フィットネスという領域特有の5つの決定要因を特定し、それに基づいてシステムを設計

## 技術的ポイント

- **モデル**: DLRM (Facebook, 2019)
- **評価指標**: MAP@K (Mean Average Precision at K)
- **インフラ**: AWS + Kubernetes + GPU
- **実験管理**: MLFlow
- **データサンプリング**: 評価5%、トレーニング10%でも十分な性能

## 参考リンク

- [Pinterest: オフラインリプレイ実験](https://medium.com/pinterest-engineering/experiment-without-the-wait-speeding-up-the-iteration-cycle-with-offline-replay-experimentation-7a4a95fa674b)
- [Netflix: ページシミュレーター](https://netflixtechblog.com/page-simulator-fa02069fb269)
- NVIDIA GTC 2020でのPelotonチームの講演
