## これは何?

- SageMaker Feature Storeのオフラインストアのデータ形式は2種類ある。
  - 「AWS Glueテーブル形式」と「Apache Icebergテーブル形式」。
  - 両者の違いについて調査したもの。

## refs:

- [Amazon SageMaker Feature Store オフラインストアのデータ形式](https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/feature-store-offline.html)

## 2種類のデータ形式について

- SageMaker Feature Storeのオフラインストアのデータ形式は2種類ある。
  - 「AWS Glueテーブル形式」と「Apache Icebergテーブル形式」。
  - デフォルトは「AWS Glueテーブル形式」。
  - 新しいfeature groupを作成する際にテーブル形式を選択できる。
  - オフラインストアのファイル形式は、parquet形式のみをサポートしてる。
- その1: AWS Glueテーブル形式
  - デフォルトのテーブル形式。
  - S3にparquetでデータ保存、Glue Data Catalogにテーブルメタデータを保存。
  - **小さいファイルが多いとクエリが遅くなる可能性あり。**
- その2: Apache Icebergテーブル形式
  - オフラインストアデータの保存と同じS3バケットに、テーブルメタデータも保存される。`metadata/`というプレフィックスの下に保存される。

### 両者のparquetファイルの構造、s3内での置き方(uriパターンやパーティション分割スキーム)について。

- parquetファイルの構造自体は同じ!
  - ファイル形式もカラム構造も同じ!
- S3内での置き方(uriパターンやパーティション分割スキーム)は異なる!
  - AWS Glueテーブル形式
    - hour単位までのパーティション粒度。
    - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/data/year=year/month=month/day=day/hour=hour/timestamp_of_latest_event_time_in_file_16-random-alphanumeric-digits.parquet`
  - Icebergテーブル形式
    - 日付単位までのパーティション粒度。
      - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/data/8-random-alphanumeric-digits/event-time-feature-name_trunc=event-time-year-event-time-month-event-time-day/timestamp-of-latest-event-time-in-file_16-random-alphanumeric-digits.parquet`
    - 加えて`metadata/`というプレフィックスの下に、Icebergのテーブルメタデータが保存される。
      - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/metadata/`

