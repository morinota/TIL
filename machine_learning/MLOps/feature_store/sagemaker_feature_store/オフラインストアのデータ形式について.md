## これは何?

- SageMaker Feature Storeのオフラインストアのデータ形式は2種類ある。
  - 「AWS Glueテーブル形式」と「Apache Icebergテーブル形式」。
  - 両者の違いについて調査したもの。

## refs:

- [Amazon SageMaker Feature Store オフラインストアのデータ形式](https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/feature-store-offline.html)

## 2種類のデータ形式について

- SageMaker Feature Storeのオフラインストアのデータ形式は2種類ある。
  - 「AWS Glueテーブル形式」と「Apache Icebergテーブル形式」。
  - デフォルトは「AWS Glueテーブル形式」。
  - 新しいfeature groupを作成する際にテーブル形式を選択できる。
  - オフラインストアのファイル形式は、parquet形式のみをサポートしてる。
- その1: AWS Glueテーブル形式
  - デフォルトのテーブル形式。
  - S3にparquetでデータ保存、Glue Data Catalogにテーブルメタデータを保存。
  - **小さいファイルが多いとクエリが遅くなる可能性あり。**
- その2: Apache Icebergテーブル形式
  - オフラインストアデータの保存と同じS3バケットに、テーブルメタデータも保存される。`metadata/`というプレフィックスの下に保存される。

### 両者のparquetファイルの構造、s3内での置き方(uriパターンやパーティション分割スキーム)について。

- parquetファイルの構造自体は同じ!
  - ファイル形式もカラム構造も同じ!
- S3内での置き方(uriパターンやパーティション分割スキーム)は異なる!
  - AWS Glueテーブル形式
    - hour単位までのパーティション粒度。
    - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/data/year=year/month=month/day=day/hour=hour/timestamp_of_latest_event_time_in_file_16-random-alphanumeric-digits.parquet`
  - Icebergテーブル形式
    - 日付単位までのパーティション粒度。
      - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/data/8-random-alphanumeric-digits/event-time-feature-name_trunc=event-time-year-event-time-month-event-time-day/timestamp-of-latest-event-time-in-file_16-random-alphanumeric-digits.parquet`
    - 加えて`metadata/`というプレフィックスの下に、Icebergのテーブルメタデータが保存される。
      - `s3://amzn-s3-demo-bucket/example-prefix/111122223333/sagemaker/AWS リージョン/offline-store/feature-group-name-feature-group-creation-time/metadata/`


### Apache Icebergテーブル形式の方が良さそうな話:

- 参考:
  - https://www.linkedin.com/posts/riley-johnson-73a83aa_amazon-sagemaker-feature-store-now-supports-activity-7089315357131227136-W8Vl
  - Iceberg形式のオフラインストアを推奨するブログ: [­­Speed ML development using SageMaker Feature Store and Apache Iceberg offline store compaction](https://aws.amazon.com/jp/blogs/machine-learning/speed-ml-development-using-sagemaker-feature-store-and-apache-iceberg-offline-store-compaction/)
- まずApatche Icebergの話:
  - 非常に大規模な分析データセット向けのオープンなテーブル形式。
    - (なので **Feature Storeのオフラインストアのようなユースケースに適してる**、ってことか...!:thinking:)
    - **大規模なファイルコレクションをテーブルとして管理**し、S3での使用に最適化された最新の分析データレイク操作をサポート。
- データ投入(ingestion)の観点でのIcebergの利点:
  - 特にストリーミング処理で特徴量生成パイプラインが稼働する場合、**多数の小さなファイルが生成**される。
    - 必要なファイル操作数が増加するため、クエリ性能に悪影響を与えるリスクあり。
  - Icebergでは、partition内の小さなファイルを少数の大きなファイルに自動的に圧縮できるので、クエリ速度が大幅に向上する。
    - この圧縮操作は並行して実行されるので、進行中の他の読み書き操作を妨げない。

- ちなみに... Sagemaker Feature StoreにおけるApache Icebergの使われ方。
  - まずAWSでIcebergを利用する際のストレージは主に三種類。
    - S3汎用バケット
    - S3テーブルバケット(S3 Tables)
    - Redshift Managed Storage
  - SageMaker Feature Storeのオフラインストアでは、1番目のS3汎用バケットの方法が使用されている。
    - 参考: https://speakerdeck.com/simosako/apache-iceberg-to-amazon-s3-tables?slide=18

### Sagemaker Feature StoreのIngest APIを使わずに、Apache Icebergテーブル形式のオフラインストアだけに書き込む方法

- まず前提として、S3にオブジェクトを追加するだけでは、Icebergテーブルにデータを追加できない。
  - Icebergテーブルのメタデータも更新しない限り、Icebergテーブルは新しいデータを認識しない。
- なのでApache Icebergテーブルフォーマットへ読み書きできるようなクエリエンジンのAPIを使う必要がある。
  - 多分例えば...SparkやPyIceberg、Athenaなど! :thinking:
