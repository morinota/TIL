

## 何を書きたいか

- 4ヶ月ほど、SageMaker Feature Storeを試験運用してみた経験をもとに、自社で価値を発揮するFeature Storeを構築する上でどんな点が重要そうか、という自分の現時点での見解を書きたい。
  - 4ヶ月間の試験運用での学び: 何が重要か。
    - 特徴量生成のbackfillが容易であること。
      - 特に推薦・広告配信などのユースケースでは顕著だが、歴史的特徴量(historical features)を使うことが多い。
      - 歴史的特徴量を使う場合、学習時のデータリーク(future data leak)を防ぐために、過去のある時点(tの時点)における特徴量値を生成・保存する必要がある。
        - なのでFeature Storeでは、歴史的特徴量の値をtimestampカラムと一緒に管理することが多い。オフラインストア側で。一方で、オンラインストアは最新の値だけがあれば十分なケースがほとんど。
      - よって、新しい歴史的特徴量を追加したり、既存の歴史的特徴量の計算ロジックを変更したりする場合に、過去のある時点(tの時点)における特徴量値を一括で再計算(backfill)してFeature Storeに書き込めることが必要。
        - なので、feature pipelineは冪等性を持ってbackfillは容易であるべきだし、Feature Storeはbackfill時に大量の読み書きを効率的に行えることが重要。
      - 逆に歴史的特徴量のbackfillが容易じゃない場合どうなる??
        - hoge

    - オンラインストアの有効化を柔軟に切り替えられること。
      - 全ての特徴量グループをオンラインストアで管理する必要はない。
      - ex. 
        - 試しに新しい特徴量を作ってみて、モデルの性能向上に寄与するかどうかを評価する段階では、オンラインストアは不要。
        - バッチ推論でしか使われない特徴量グループもある。
        - 途中でリアルタイム推論などでも使いたくなった時に、オンラインストアを有効化できると良い。

    - ストリーミング/マイクロバッチでの高頻度の読み書きが容易であること。
      - 特にニュースサービスなので新規ニュースが常に入ってくる。なのでfeature pipelineがストリーミング/マイクロバッチ処理で稼働することが多い。
      - また、ユーザのリアクション関連の特徴量も、なるべく少ないラグで更新して、パーソナライズフィード内に反映できるようにしたい。
      - 上記の経緯から、feature pipelineはストリーミング/マイクロバッチ処理で稼働したいユースケースが結構ある。
        - そのために、Feature Storeが高頻度の読み書きに対応できることが望ましい。
        - 例えば、ストリーミングで読み書きするとめっちゃ高額なコストがかかる、みたいなことが起きないことが望ましい。

    - 学習コストが低いこと。
      - そりゃそう。開発・運用する上で学習コストが低いことは重要。
      - 特にマイナーなフルマネージドサービスの場合、ドキュメントや事例が少なかったりして、学習コストが高くなりがち。

    - 新しい特徴量の試行錯誤が容易であること。特にオフライン読み書き(主に実験時)の低コスト化・高速化。
      - 新しい特徴量を試しに作ってみて、モデルの性能向上に寄与するかどうかを評価することは、MLシステム開発において重要な活動。
      - なので、Feature Storeがオフラインでの特徴量の読み書きを低コストかつ高速に行えることが望ましい。
      - 「特徴量生成のbackfillが容易であること」も含む。

    - 開発組織内のMLを使う人たちがアクセスしやすいこと。
      - 既存のDWHやBIツールと連携しやすいことが必要。
      - リアルタイム推論時に低レイテンシーでアクセスできること。学習時・バッチ推論時に高スループットでアクセスできること。

  - 上記の学びを踏まえて、今後の改善の話:
    - フルマネージドサービスではなく、AWSのメジャーなサービス(S3, DynamoDB等)を組み合わせた自前Feature Storeに移行を考えている。
    - SageMaker Feature Storeでは、上記の要件を満たすのが難しい点がいくつかあった。
      - backfill -> 大量の読み書きが高コスト(なぜならオフラインストア限定の書き込みAPIが存在しないから)
      - ストリーミング/マイクロバッチでの高頻度の読み書き -> こちらは一旦対応してるOK。
      - 学習コスト -> マイナーサービスなのでかなり高め。Sagemaker固有の仕様なども多い。
        - 基本的にFeature Storeとしての各種機能はAPIとして抽象化されているため、資金が無尽蔵にあるならば、学習コストはあまり問題にならないかも。
        - ただし、結局自社のユースケースやコスト事情に合わせて最適化したい場合、マイナーサービスの実装の詳細を理解してカスタマイズする必要が出てくることが多かった。
          - ex. オフラインストアの実体は標準S3バケット上のIcebergテーブル。backfill時に大量の読み書きを効率的に行うには公式APIではなく自前でIcebergテーブルを直接操作する必要がある。


## 参考資料

- [5 Minimum Requirements of an Operational Feature Store](https://medium.com/data-for-ai/5-minimum-requirements-of-an-operational-feature-store-ab1436ca1a2c)
  - 自分の感想メモ記事: [hoge]()
- [Feature Store: The Definitive Guide](https://www.hopsworks.ai/dictionary/feature-store)
  - 自分の感想メモ記事: [hoge]()
- [Feature Store Architecture and How to Build One](https://www.qwak.com/post/feature-store-architecture)
- [Beware the data science pin factory: The power of the full-stack data science generalist and the perils of division of labor through function](https://multithreaded.stitchfix.com/blog/2019/03/11/FullStackDS-Generalists/)
- [実践MLOps 作って理解する機械学習システムの構築と運用](https://www.ohmsha.co.jp/book/9784274233982/)
- [事例でわかるMLOps 機械学習の成果をスケールさせる処方箋](https://www.kspub.co.jp/book/detail/5369562.html)


### 発表タイトル:

Feature Store、フルマネージドサービス使うか自前で作るか ~Sagemaker Feature Storeを3ヶ月試験運用して得た気づきたち~

#### タイトル案

- (TODO: 他のタイトル案を追加)

### なんの課題解決の話を書きたいんだっけ??

#### 主メッセージ:

- 候補
  - **自社で価値を発揮するFeature Storeを構築する上で、マイナーなフルマネージドサービスよりもAWSのメジャーなサービスを組み合わせた内製の方が都合良い! SageMaker Feature Storeの試験運用を通じてわかった選び方**

#### ピラミッド構造:

- 主メッセージ: SageMaker Feature Storeを3ヶ月試験運用した結果、マイナーなフルマネージドサービスよりもAWSのメジャーなサービス(S3, DynamoDB等)を組み合わせた内製の方が都合良いという結論に至った
  - 背景: 機械学習システムにおいて特徴量管理は重要な課題である
  - 前提: 特徴量ストアとは何か、どんな課題を解決するのか
  - 選択肢: フルマネージドサービス vs 自前実装
  - 検証内容: SageMaker Feature Storeを3ヶ月試験運用してみた
  - 気づき1: SageMaker Feature Storeのメリット
  - 気づき2: SageMaker Feature Storeの課題・制約(マイナーサービスならではの問題)
  - 結論: 我々の場合、AWSのメジャーなサービスを組み合わせた内製の方がより価値を発揮しやすそう。
    - 理由1: マイナーなフルマネージドサービス特有の制約が多い。
    - 理由2: メジャーなサービスの方が長期的な安定性・拡張性が高い
    - 理由3: 既存システムとの統合がしやすい
