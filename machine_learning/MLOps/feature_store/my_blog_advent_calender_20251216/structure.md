

## ざっくり何を書きたいか？

- 4ヶ月ほど、SageMaker Feature Storeを試験運用してみた経験をもとに、自社で価値を発揮するFeature Storeを構築する上でどんな点が重要そうか、という自分の現時点での見解を書きたい。
  - 4ヶ月間の試験運用での学び: 何が重要か。
    - 特徴量生成のbackfillが容易であること。
      - 特に推薦・広告配信などのユースケースでは顕著だが、歴史的特徴量(historical features)を使うことが多い。
      - 歴史的特徴量を使う場合、学習時のデータリーク(future data leak)を防ぐために、過去のある時点(tの時点)における特徴量値を生成・保存する必要がある。
        - なのでFeature Storeでは、歴史的特徴量の値をtimestampカラムと一緒に管理することが多い。オフラインストア側で。一方で、オンラインストアは最新の値だけがあれば十分なケースがほとんど。
      - よって、新しい歴史的特徴量を追加したり、既存の歴史的特徴量の計算ロジックを変更したりする場合に、過去のある時点(tの時点)における特徴量値を一括で再計算(backfill)してFeature Storeに書き込めることが必要。
        - なので、feature pipelineは冪等性を持ってbackfillは容易であるべきだし、Feature Storeはbackfill時に大量の読み書きを効率的に行えることが重要。
      - 逆に歴史的特徴量のbackfillが容易じゃない場合どうなる??
        - hoge

    - オンラインストアの有効化を柔軟に切り替えられること。
      - 全ての特徴量グループをオンラインストアで管理する必要はない。
      - ex. 
        - 試しに新しい特徴量を作ってみて、モデルの性能向上に寄与するかどうかを評価する段階では、オンラインストアは不要。
        - バッチ推論でしか使われない特徴量グループもある。
        - 途中でリアルタイム推論などでも使いたくなった時に、オンラインストアを有効化できると良い。

    - ストリーミング/マイクロバッチでの高頻度の読み書きが容易であること。
      - 特にニュースサービスなので新規ニュースが常に入ってくる。なのでfeature pipelineがストリーミング/マイクロバッチ処理で稼働することが多い。
      - また、ユーザのリアクション関連の特徴量も、なるべく少ないラグで更新して、パーソナライズフィード内に反映できるようにしたい。
      - 上記の経緯から、feature pipelineはストリーミング/マイクロバッチ処理で稼働したいユースケースが結構ある。
        - そのために、Feature Storeが高頻度の読み書きに対応できることが望ましい。
        - 例えば、ストリーミングで読み書きするとめっちゃ高額なコストがかかる、みたいなことが起きないことが望ましい。

    - Feature Storeを開発運用する上で学習コストが低いこと。
      - そりゃそう。開発・運用する上で学習コストが低いことは重要。
      - 特にマイナーなフルマネージドサービスの場合、ドキュメントや事例が少なかったりして、学習コストが高くなりがち。

    - 新しい特徴量の試行錯誤が容易であること。特にオフライン読み書き(主に実験時)の低コスト化・高速化。
      - 新しい特徴量を試しに作ってみて、モデルの性能向上に寄与するかどうかを評価することは、MLシステム開発において重要な活動。
      - なので、Feature Storeがオフラインでの特徴量の読み書きを低コストかつ高速に行えることが望ましい。
      - 「特徴量生成のbackfillが容易であること」も含む。

    - 開発組織内のMLを使う人たちがアクセスしやすいこと。
      - 既存のDWHやBIツールと連携しやすいことが必要。
      - リアルタイム推論時に低レイテンシーでアクセスできること。学習時・バッチ推論時に高スループットでアクセスできること。

  - 上記の学びを踏まえて、今後の改善の話:
    - フルマネージドサービスではなく、AWSのメジャーなサービス(S3, DynamoDB等)を組み合わせた自前Feature Storeに移行を考えている。
    - SageMaker Feature Storeでは、上記の要件を満たすのが難しい点がいくつかあった。
      - backfill -> 大量の読み書きが高コスト(なぜならオフラインストア限定の書き込みAPIが存在しないから)
      - ストリーミング/マイクロバッチでの高頻度の読み書き -> こちらは一旦対応してるOK。
      - アクセスしやすさ!
        - DWHやBIツールとの連携 -> AWS公式のSagemaker Python SDKはAthena経由APIを提供してるが、NPではあまりAthenaを使ってないので親和性が低め。
        - 開発者たちが、Snowflake経由でパッと特徴量を参照したり分析したりできる仕組みが望ましいが、Sagemaker Feature StoreはSnowflakeとの連携しづらさがあった。
          - Icebergテーブルの連携に苦戦、ここを解決しようと思うと、結局内部実装を細かく理解する必要が出てきて、フルマネージドサービスの恩恵が薄れる。
      - 学習コスト -> マイナーサービスなのでかなり高め。Sagemaker固有の仕様なども多い。
        - 基本的にFeature Storeとしての各種機能はAPIとして抽象化されているため、資金が無尽蔵にあるならば、学習コストはあまり問題にならないかも。
        - ただし、結局自社のユースケースやコスト事情に合わせて最適化したい場合、マイナーサービスの実装の詳細を理解してカスタマイズする必要が出てくることが多かった。
          - ex. オフラインストアの実体は標準S3バケット上のIcebergテーブル。backfill時に大量の読み書きを効率的に行うには公式APIではなく自前でIcebergテーブルを直接操作する必要がある。

- そもそもなぜFeature Storeが自社で必要だったのか??
  - シンプルなより多種多様な特徴量を活用したMLモデルの運用のため。
    - 自社でのML活用のメインの1つ = ニュース推薦
    - これまでは、協調フィルタリングベース手法 → 内容ベース手法がメイン。扱う特徴量の種類がかなり限られており、Feature Storeの必要性はあまり高くなかった。
    - しかし最近では、よりユーザに価値のある情報を見つけてエンゲージメントを高めるために、多種多様な特徴量を活用するようなcontext-awareな推薦手法への進化が求められていた。
    - バッチ推論 & リアルタイム推論の両方のユースケースがある中で、多種多様な特徴量を効率的に管理・取得できる仕組みが必要だった。
      - また複雑性の高いcontext-awareな推薦手法を運用経験のあるメンバーが少なかったため、Feature Storeのような抽象化された仕組みがあると助かる面もあった。歴史的特徴量の管理などのノウハウもあまり社内に蓄積されていなかった。だからマネージドなFeature Storeを試験運用して勘所を掴みたかった。
  - 開発組織内でのMLモデルの活用が活発化してきたため。
    - この1年で、事業部向かいのチーム(ストリームアラインドチーム)自身が、MLモデルを活用した機能改善や分析に積極的に取り組むようになってきた。
    - 以前は機械学習技術は複雑なサブシステムとして専属チームのみが扱っていたが、Claude Codeなどのコーディングエージェントの登場により、ハードルが下がってきた感がある。
    - そのため、MLを使う人たちが特徴量にアクセスしやすい仕組み・有効な特徴量を効果的に共有できる仕組みが望ましかった。

- ざっくりそもそもFeature Storeとは?? どんな性質を持つ、どんな役割のコンポーネントなのか??
  - hoge

## 参考資料

- [Feature Store: The Definitive Guide](https://www.hopsworks.ai/dictionary/feature-store)
  - 自分の感想メモ記事: [hoge]()
- [5 Minimum Requirements of an Operational Feature Store](https://medium.com/data-for-ai/5-minimum-requirements-of-an-operational-feature-store-ab1436ca1a2c)
  - 自分の感想メモ記事: [hoge]()
- [Feature Store Architecture and How to Build One](https://www.qwak.com/post/feature-store-architecture)
- [Beware the data science pin factory: The power of the full-stack data science generalist and the perils of division of labor through function](https://multithreaded.stitchfix.com/blog/2019/03/11/FullStackDS-Generalists/)
- [実践MLOps 作って理解する機械学習システムの構築と運用](https://www.ohmsha.co.jp/book/9784274233982/)
- [事例でわかるMLOps 機械学習の成果をスケールさせる処方箋](https://www.kspub.co.jp/book/detail/5369562.html)
- [Feature Stores: Components of a Data Science Factory[Guide]](https://neptune.ai/blog/feature-stores-components-of-a-data-science-factory-guide)
- [Rules of Machine Learning: Best Practices for ML Engineering](https://developers.google.com/machine-learning/guides/rules-of-ml?hl=ja)

### 発表タイトル:

#### タイトル案

- ニュースアプリで本当に効くFeature Store設計：4ヶ月の学びを全部まとめた
- ニュースサービスに必要なFeature Storeの条件：4ヶ月の実践で見えた本質
- 高速更新 × 歴史的特徴量 × オンライン推論：ニュースアプリに最適なFeature Storeを考える
- “止まらないデータ”と戦うニュースアプリのためのFeature Store設計
- **NewsPicksで真に価値を発揮するFeature Storeに必要な観点たち~SageMaker Feature Storeを4ヶ月試験運用した学びから見えてきたこと~**

### なんの課題解決の話を書きたいんだっけ??

#### 主メッセージ:

NewsPicksで価値を発揮するFeature Storeの重要観点は...

1. 歴史的特徴量の管理やbackfillが容易であること。
2. ストリーミング/マイクロバッチでの高頻度の読み書きに現実的なコストで対応できること。
3. 新しい特徴量の試行錯誤を安く・高速に回せること
4. MLを使う人たちからアクセスしやすく、発見しやすいこと

#### ピラミッド構造:

- はじめに
  - 本記事の目的
  - 4ヶ月の試験運用を通して何を言語化したいのか
- 背景: NewsPicksで機械学習の成果をスケールさせるために特徴量ストアが必要になってきたんです!
  - 1. まず特徴量は、機械学習プロダクトの成否を左右する中心資産なんです!
    - ほとんどの利益は優れた特徴量から得られ、優れた機械学習アルゴリズムからは得られない。
    - 驚くべきことではないが、最も重要なことは適切な特徴量を持つこと。
  - 2. そして特徴量ストアは、プロダクション環境で特徴量を扱う上で重要な役割のコンポーネントなんです!
    - オフライン環境で機械学習モデルを実験する上では、特に特徴量ストアなしの「場当たり的な」特徴量管理でも大きな問題はない。
  - 3. そしてNewsPicksでも特徴量ストアの必要性が高まってきたんです! なのでSageMaker Feature Storeを4ヶ月試験運用してみたんです!
    - いきなりゼロから自前でFeature Storeを構築するのは工数もかかるし不確実性も高いので、まずはフルマネージドサービスであるSageMaker Feature Storeを試験的に一部のプロジェクトに組み込んで試験運用してみた。
- 本論: NewsPicksで価値を発揮するFeature Storeの重要観点4つはこれだと思うんです!
  - 1. 歴史的特徴量の管理やbackfillが容易であることが重要なんです!
  - 2. ストリーミング/マイクロバッチでの高頻度の読み書きに現実的なコストで対応できることが重要なんです!
  - 3. 新しい特徴量の試行錯誤を安く・高速に回せることが重要なんです!
  - 4. MLを使う人たちからアクセスしやすく、発見しやすいことが重要なんです!
- 今後の取り組み
  - 既存のフルマネージドサービスでは上記の要件を満たすのが難しい点がいくつかあったため、自前Feature Storeでの運用を考えているんです!
- おわりに
  - 本記事で言いたかったことの総括

- はじめに: 本記事を書くことの意味づけ
  - 機械学習の実運用における特徴量の重要性! 特徴量は機械学習プロダクトの成否を左右する中心資産だ!
    - (Rules of Machine Learningより) Even with all the resources of a great machine learning expert, most of the gains come from great features, not great machine learning algorithms.(優れた機械学習の専門家のすべてのリソースを持っていても、ほとんどの利益は優れた特徴量から得られ、優れた機械学習アルゴリズムからは得られません)
    - (Facebook 広告CTR予測の教訓論文より) Not surprisingly, the most important thing is to have the right features.(驚くべきことではないが、最も重要なことは適切な特徴量を持つことです)
    - メッセージ: 機械学習プロダクトの成功には、まず有益な情報を捉えた価値を発揮する特徴量が最重要!
  - 機械学習の実運用における特徴量ストアという概念の重要性
    - 特徴量は機械学習プロダクトの成否を左右する中心資産なわけだが、本番運用では以下の課題が必ず発生する:
  - なぜNewsPicksで今Feature Storeを導入したいのか??
  - なぜFeature Storeが必要だったのか??
    - 推薦まわりの高度化（context-aware化）
    - ML活用者の増加（ストリームアラインドチームの台頭など）
    - 特徴量の管理・再利用がめちゃ大事になってきた
  - SageMaker Feature Store を4ヶ月試験運用して得た「実感ベースの気づき」がテーマです、という導入。
  - 本記事の目的: NewsPicksで価値を発揮するFeature Storeの重要観点を4つに整理して共有すること。
- 背景:
  - Featureとは?なぜ重要なのか?
  - Feature Storeとは? なぜ重要なのか?
- 本論: NewsPicksで価値を発揮するFeature Storeの重要観点4つ
  - 1. 歴史的特徴量の管理やbackfillが容易であること。
  - 2. ストリーミング/マイクロバッチでの高頻度の読み書きに現実的なコストで対応できること。
  - 3. 新しい特徴量の試行錯誤を安く・高速に回せること
  - 4. MLを使う人たちからアクセスしやすく、発見しやすいこと
- おわりに:
