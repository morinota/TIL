皆さんこんにちは！ソーシャル経済メディア「NewsPicks」プロダクトエンジニアの森田([@moritama7431](https://twitter.com/moritama7431))です。
この記事は [NewsPicks アドベントカレンダー 2025](https://qiita.com/advent-calendar/2025/newspicks) の16日目の記事です。

さて本日は、ざっくり機械学習のプロダクトへの実応用やMLOpsに関する内容です！
本記事は、

- 機械学習をプロダクトに本番導入している／これから導入したいソフトウェアエンジニア
- 特徴量ストア(Feature Store)の導入や運用に悩んでいる方

向けに、**NewsPicksでSageMaker Feature Storeを4ヶ月間試験運用して得られた実運用の学び**を言語化して整理してみたものです。
皆さんのMLOps活動の参考になれば幸いですし、何か気になる点や思ったことがあればぜひお気軽にコメントいただけたら嬉しいです:)

## TL;DR

- **特徴量(Feature)はMLプロダクトの成否を左右する中心資産**だが、本番運用では管理・提供が一気に難しくなる。**特徴量ストア(Feature Store)**はその課題解決を担う重要コンポーネント。
- SageMaker Feature Store を約4ヶ月試験運用した結果、NewsPicksの文脈では特に以下の**4つの観点**が特徴量ストアの重要観点だった:
  1. **リアルタイム推論に必要な特徴量を低レイテンシーで取得できること**
  2. **履歴特徴量の バックフィル が容易であること**
  3. **ストリーミング/マイクロバッチでの高頻度の読み書きに対応できること**
  4. **日常的に使われている DWH / BI ツールからアクセスしやすいこと**
- 現在は自社プロダクトのユースケース・ワークロード・コスト構造に合わせて最適化しやすいよう、S3×Iceberg（オフライン）＋DynamoDB（オンライン）を軸にした自前の特徴量ストアを検討中

## 背景: 本記事を書く意味づけ

### 特徴量は、機械学習プロダクトの成否を左右する中心資産だ！

最初に特徴量について簡単に説明します。
「特徴量(Feature)」とは、ある対象(エンティティ, ex. ユーザ, 記事, etc.)の属性(property)を数値化したもので、機械学習モデルの入力情報として予測や意思決定に役立つデータとして定義されています（参考: [Feature Store: The Definitive Guide](https://www.hopsworks.ai/dictionary/feature-store)）。
例えばNewsPicksプロダクト内での特徴量の例としては、以下のようなものがあります。

- エンティティがユーザの場合の特徴量: 年齢、性別、過去のニュース閲覧履歴, アクセス頻度, etc.
- エンティティが記事の場合の特徴量: 記事のカテゴリ, 公開日時, 著者情報, 閲読数, etc.

「そりゃそうだ!」と思われるかもですが、**機械学習モデルの予測や意思決定の性能は入力する特徴量に大きく依存**します。
入力情報を元に機械学習モデルが出力を計算する訳ですし...!

Googleの機械学習プロダクト・プロジェクトに関する指針を提供する大作資料「Rules of Machine Learning: Best Practices for ML Engineering」では、以下のように特徴量の重要性が強調されています。

> Most of the problems you will face are, in fact, engineering problems. Even with all the resources of a great machine learning expert, most of the gains come from great features, not great machine learning algorithms.

> （あなたが直面するほとんどの問題は、実際にはエンジニアリングの問題です。**優れた機械学習の専門家のすべてのリソースを持っていても、ほとんどの利益は優れた特徴量から得られ、優れた機械学習アルゴリズムからは得られません。**）

> （ブログ記事「[Rules of Machine Learning: Best Practices for ML Engineering](https://developers.google.com/machine-learning/guides/rules-of-ml)」より引用）

またFacebookの広告CTR予測の教訓論文でも、以下のように記述されています。

> Not surprisingly, the most important thing is to have the right features.

> （驚くべきことではないが、**最も重要なことは適切な特徴量を持つこと**です。）

> （論文「[Practical Lessons from Predicting Clicks on Ads at Facebook](https://research.facebook.com/publications/practical-lessons-from-predicting-clicks-on-ads-at-facebook/)」より引用）

つまり、**特徴量は、機械学習モデルの性能ひいては機械学習プロダクト・プロジェクトの成否を左右する重要な中心資産である**と考えている訳です。

### 特徴量ストアは、プロダクション環境で特徴量を活用して価値を発揮する上で重要なコンポーネントだ!

さて「特徴量は機械学習プロダクトの成否を左右する中心資産だ!」と述べましたが、最初のPoC段階では特徴量の運用はそこまで難しくありません。
PoC段階で特徴量生成→学習→推論の一連の流れを実装すると、例えば以下のような設計になるのではないでしょうか??

<figure class="figure-image figure-image-fotolife" title="図1: モノリシックなバッチMLシステムアーキテクチャの例">[f:id:morinota:20251216203929p:plain]<figcaption>図1: モノリシックなバッチMLシステムアーキテクチャの例</figcaption></figure>

主にDWHやデータレイクからデータを直接引っこ抜いて、 CSVやparquetファイルをこねくり回して、「学習用の特徴量できた！モデルも学習できた！性能評価もできた！Yes！」 という世界では、特徴量は全て開発者の手元にあり、再現性も整合性もほぼ問題になりません。
さらにPoCでは、特徴量の生成に何秒かかろうが集計に1時間かかろうが大して困らないので、レイテンシ要件やスループット要件の懸念もありません。
またPoCを超えて本番プロダクトにMLを組み込む段階でも、例えば日次や週次バッチで特徴量生成・学習・推論を一括で行えばOKなユースケースの場合は、最初はこの設計でも十分に運用可能だと思います。

しかし一方で、プロダクション環境に本格的にMLを活用していこうとすると、特徴量運用の難易度は跳ね上がっていきます。
例として、**推論結果にリアルタイム性が求められるケース**を考えてみましょう。
前述の図1の設計をそのまま本番プロダクトに組み込もうとするとリアルタイム性を満たせないため、例えば学習と推論を分離した以下のような設計が考えられると思います。

<figure class="figure-image figure-image-fotolife" title="図2: 学習と推論を分離したリアルタイムMLシステムアーキテクチャの例">[f:id:morinota:20251216205754p:plain]<figcaption>図2: 学習と推論を分離したリアルタイムMLシステムアーキテクチャの例</figcaption></figure>


この場合、例えば次のような課題が出てきます。

- 特徴量ってレイテンシー要件を満たせる範囲でリアルタイムに作成できるんだっけ??
- モデルの学習時と推論時で、特徴量の生成ロジックって一貫してるっけ? 一貫性を保証できるっけ??
- 特徴量は事前計算しておくとしたら保存場所は?? データレイクやDWHだと低レイテンシでアクセスできないよね...でも学習とかの際はむしろ高スループットでアクセスしたいし...!
- リアルタイムアクセス用にキーバリューストア、バッチアクセス用にDWHとかデータレイクとか複数の保存場所を用意するとして、両者の一貫性の保証はどうやろう...!
- 特徴量の種類に応じて、リアルタイム/ストリーミング/日次バッチ/週次バッチ、など求められる更新頻度も様々だよね...それらをまとめてどう学習時・推論時に提供しよう...!

リアルタイム推論のユースケースを例に挙げましたが、実運用では他にも以下のような課題が出てきます。

- **自社プロダクト内で機械学習やアルゴリズムを扱うユースケースもチームも増えてきた**んだけど...。
  - 同じような特徴量をユースケース毎に別々の生成ロジックで作って試行錯誤しちゃってない?? いい感じに共有できた方が改善のイテレーション早く回せそう...!
  - リアルタイム推論のユースケース達が、それぞれ特徴量を事前計算してキャッシュする仕組みを持っちゃってるな、毎回キャッシュの仕組みを追加するのも開発コスト高いし、運用コスト・認知負荷も高くなってきた...!
- 過去のユーザ行動などの**履歴特徴量**が、推薦タスクなどでは効果的だから使いたいんだけど...
  - 学習時に未来の情報が漏洩(future data leak)しないように、履歴特徴量についてある1時点の値を正しく再現できるようにしたいんだけど、どう管理したらいいんだっけ...!

さて、上記のような特徴量周りの実運用のあれこれの課題解決の責務を担う役割として導入されるのが **特徴量ストア(Feature Store)** というコンポーネントです。

特徴量ストアを採用した場合のアーキテクチャ例は例えば以下のようになります。
（ちなみにこの設計思想はFTI Pipelines Architectureと呼ばれています。参考: [From MLOps to ML Systems with Feature/Training/Inference Pipelines](https://www.hopsworks.ai/post/mlops-to-ml-systems-with-fti-pipelines)）

<figure class="figure-image figure-image-fotolife" title="図3: 特徴量ストアを採用したリアルタイムMLシステムアーキテクチャ (FTI Pipelines Architecture)">[f:id:morinota:20251216211419p:plain]<figcaption>図3: 特徴量ストアを採用したリアルタイムMLシステムアーキテクチャ (FTI Pipelines Architecture)</figcaption></figure>

特徴量ストアは、例えば以下のような機能を提供することで上記の課題の解消を図ります。

- 特徴量生成と学習 & 推論を分離したアーキテクチャの提供
  - 特徴量生成ロジックを独立させることで、学習時と推論時で一貫性のある特徴量を提供できる。
  - 事前計算したリッチな特徴量をリアルタイム推論で活用できる。
- 低レイテンシー & 高スループットな特徴量アクセス基盤(オンラインストア & オフラインストア)の提供
  - リアルタイム推論に必要な特徴量を低レイテンシーで提供できる。
  - バッチ学習に必要な特徴量を高スループットで提供できる。
  - 両者の整合性の保証は特徴量ストアが担保する。
- 様々な種類の特徴量を一元管理
  - 特徴量の再利用がしやすくなる。
  - オフライン&オンラインストアを内包してる事で、高スループットのオフラインアクセス、低レイテンシーのオンラインアクセス両方に対応できる。
- 履歴特徴量はタイムスタンプ付きで管理
  - 過去のある1時点の特徴量の値を正しく再現し、学習時に誤って未来のデータを使ってしまうデータリーク問題を防止できる。

という訳でここでは、PoC段階ではそこまで難しくなかった**特徴量運用が、プロダクション環境で本格運用する際に難易度が跳ね上がる!** だから**特徴量ストアは、プロダクション環境で特徴量まわりの運用課題を解決して機械学習で価値を発揮するための重要なコンポーネントなんだ〜!**ということを主張したかったのでした。

### NewsPicksでも特徴量の運用課題が現実的な問題になってきた...!

なお、ここまで述べてきた特徴量運用の課題は、NewsPicksにおいても徐々に現実的な問題となってきていました。
求められる推薦手法の高度化に伴い、扱う特徴量はより多様かつ複雑になってきています。
またここ1年ほどで、事業部向かいのチームを含めてML技術の活用の裾野が広がり、プロジェクト・チーム間での特徴量の共有・再利用・発見しやすさといった観点も無視できなくなってきました。

こうした背景から、私たちは特徴量ストアについて真剣に検討を始め、新規MLプロジェクトの開発に合わせてAWSの[SageMaker Feature Store](https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store.html)を約4ヶ月間試験運用してみました。
本記事では、その試験運用を通じて得られた学びとして「NewsPicksで真に価値を発揮する特徴量ストアに重要そうな観点たち」を共有したいと思います。

## 本論: NewsPicksで真に価値を発揮する特徴量ストアに重要そうな観点たち

ここからは、SageMaker Feature Store を約4ヶ月試験運用してみた経験をもとに、NewsPicksの特徴量ストアが真に価値を発揮するために重要だと感じた観点を紹介します。

まず特徴量ストアの要件として、一般的に思いつくのは例えば以下のようなものがあるでしょう。

- 低レイテンシー & 高スループットな特徴量アクセス(オンラインストア & オフラインストア)の提供
- 特徴量を一元管理できること
- 学習時と推論時で一貫性を保証できること
- 履歴特徴量の管理（過去のある1時点の値を再現できること）

それらを踏まえて、**NewsPicksの特徴量ストアが満たすべき要件として、特に重要だと感じた観点は次の4つ**です。

1. リアルタイム推論に必要な特徴量を低レイテンシーで取得できること
2. 履歴特徴量のバックフィルが容易であること
3. ストリーミング/マイクロバッチ更新へのコスト効率と耐性があること
4. 日常的に使われているDWH/BIツールからアクセスしやすいこと

以下で順に紹介していきます。

### 観点1: リアルタイム推論に必要な特徴量を低レイテンシーで取得できること

（この観点1については、特徴量ストアとしてかなり一般的な観点ですし、実際にSageMaker Feature Store の試験運用を始める前から「必須だよね」という認識はありました。でも重要観点ではあるので一応軽く紹介させてください！）

というのも、NewsPicksにおける機械学習の主要なユースケースの1つが、**ニュース推薦や検索といったコンテンツの編成・配信を最適化するタスクであり、ここではリアルタイム性が重視される場面が多いため**です。
ニュースはライフサイクルが短く、新着ニュースを興味がありそうなユーザに素早く届けられるかがユーザ体験の質を左右します。
また、目指すべきユーザ体験として、ユーザの直近の行動や興味関心の変化をなるべく早く反映できるパーソナライズされたコンテンツ編成が求められます。
こうした背景から、**リアルタイム推論のユースケースが多いNewsPicksでは、低レイテンシで特徴量を取得できるオンラインストア機能が、特徴量ストアに強く求められる**訳です。

一見すると当たり前の要件に見えるかもしれませんが、**すべてのプロダクトにとってオンラインストア機能が必須というわけではない**、という点は意識しておく必要があります。
実際、現在ベンダー各社から提供されているフルマネージドな特徴量ストアの中にも、オンラインストア機能を前提としていない、あるいはオフライン中心の機能を採用しているものも存在します。

例えば、映画やドラマのようにアイテムのライフサイクルが比較的長いプロダクトでは、新しいアイテムを即時に推薦に反映する必要性はそこまで高くありません。実際、Netflixの推薦システムでは日次バッチで推論を行っているという話もあり、このようなケースでは高スループットなオフラインストア機能だけで十分に成立することもあります。
（ただちなみに、アイテムのライフサイクルが長い場合でも、ユーザの行動履歴や嗜好の変化を素早く反映したい場合には、リアルタイム推論が求められることもあります。その場合は、やはりオンラインストア機能が必要になる可能性は高いでしょう。）

というわけで、リアルタイム推論への対応はプロダクト特性に依存する要件ですが、少なくともNewsPicksの文脈においては、**オンラインで低レイテンシーに特徴量を提供できることは、特徴量ストアが価値を発揮するための前提条件の1つ**だと感じています。

### 観点2: 履歴特徴量の バックフィル が容易であること

まず「履歴特徴量(historical features)」という用語についてですが、論文やブログ記事などでよく使われているものの、統一された定義はパッと見つかりませんでした。本ブログでは、**過去のなんらかのログデータから生成され、その値が時間と共に動的に変化し得る特徴量を「履歴特徴量」**と呼ぶことにさせてください。

「観点1」で述べた通り、NewsPicksでは推薦や検索といったコンテンツ編成・配信の最適化タスクが多く、こうしたユースケースでは**ユーザの過去のリアクション履歴などに基づく履歴特徴量**が非常に高い価値を発揮します。そのため、特徴量ストアがこれらの履歴特徴量を適切に管理・運用できることは、重要な要件の1つです。

<figure class="figure-image figure-image-fotolife" title="図: 履歴特徴量の例">[f:id:morinota:20251217142910p:plain]<figcaption>図: 履歴特徴量の例</figcaption></figure>

もちろん、学習時に誤って未来の情報を漏洩させてしまうこと(future data leak)を防ぐために、過去のある時点tにおける特徴量の値を正しく再現できることは前提条件です。しかし、試験運用を通してそれ以上に重要だと感じたのが、**履歴特徴量のバックフィルをどれだけ容易に行えるか**という点でした。

ここでいう**「履歴特徴量のバックフィル(backfilling)」とは、過去のある時点tにおける特徴量の値を、特定の期間全体にわたって再計算し、保存し直す作業**を指します。モデル性能を改善する過程では、新しい履歴特徴量を追加したり、既存の特徴量の生成ロジックを変更したりすることが頻繁に発生します。そのたびに、過去の各時点における特徴量値を再計算して学習データセットを作り直す必要があります。

このため、**特徴量生成パイプラインは状態を持たず冪等性を保った設計であることが望ましいですし、同時に特徴量ストア側も バックフィル 時に大量の書き込みを効率よく処理できること**が求められます。

<figure class="figure-image figure-image-fotolife" title="図: 履歴特徴量のバックフィルの容易さが重要">[f:id:morinota:20251217151657p:plain]<figcaption>図: 履歴特徴量のバックフィルの容易さが重要</figcaption></figure>


一方で、この観点は SageMaker Feature Store を試験運用する中で、明確な課題として浮き彫りになりました。
SageMaker Feature Store には、**オフラインストアのみに書き込む公式な API が存在せず、書き込み時には必ずオンライン・オフライン両方への処理が発生**します。そのため、過去の古い期間を対象とする履歴特徴量の バックフィル であっても、**リアルタイム推論用に最新の特徴量を保持するためのオンラインストアに対して書き込みリクエストが発生**してしまいます。
しかし、これらのデータは学習用途でのみ利用されるものであり、オンラインストアに保存する必要は本来ありません。
実際には、タイムスタンプを見てオンラインストア内の現存レコードより古い場合は更新されないものの、書き込みリクエスト自体は発生するため、**結果としてDynamoDB 相当の不要な書き込みコストが積み重なりやすい構造**になっていました。

この課題感は[既存のブログ記事](https://towardsdatascience.com/ingesting-historical-feature-data-into-sagemaker-feature-store-5618e41a11e6/)でも指摘されており、この課題を回避するためには、**公式の書き込み API を使わず、特徴量ストアの内部実装を理解した上でオフラインストアのみに直接書き込む処理を自前で実装する必要**がありました。
ただこの仕様によってオンラインストアとオフラインストアの整合性・一貫性が強く保証されている点は非常に理解できます。**一方で履歴特徴量を多用するNewsPicksのユースケースでは、バックフィル 時のコストが無視できないレベルになる可能性がありました。**

履歴特徴量の バックフィル は、MLモデルの性能改善におけるイテレーションを回す上で欠かせない作業です。もし バックフィル が重く、高コストで、時間もかかる仕組みだと、特徴量の追加やロジック変更を気軽に試せなくなり、結果として改善のスピードが落ちてしまいます。
仮にバックフィルが全くできない場合どうなるかというと、新しい履歴特徴量を導入するたびに本番リリース後のログ蓄積を待つ必要があり、学習データが揃うまで何週間も改善を止めざるを得ない、という状況にもなりかねません。

こうした理由から、特に履歴特徴量を活用するMLユースケースが多いNewsPicksにおいては、**バックフィル が容易な特徴量ストアであること**が、非常に重要な要件だと感じています。

### 観点3: ストリーミング/マイクロバッチでの高頻度の読み書きに対応できること

NewsPicksはニュース記事を扱うプロダクトであるため、**新しいコンテンツが継続的に流入**します。そのため、新規ニュースが公開されたタイミングでできるだけ早く特徴量を生成し、興味を持ちそうなユーザに届けたいという要求が自然に生まれます。加えて、クリックや閲覧といったユーザのリアクションに基づく特徴量も、なるべく小さなラグで更新し、パーソナライズされたフィードに反映したいという意図があります。

こうした背景から、**特徴量生成パイプラインは日次バッチだけでなく、ストリーミングやマイクロバッチで稼働させたいケース**が多くなります。その結果、**特徴量ストア側にも高頻度な読み書きに耐えられる特性**が求められます。
具体的には、並列書き込みに弱かったり、アクセスが集中した際にレイテンシが大きく悪化したりする仕組みでは運用が難しくなります。また、ストリーミング処理を行うだけでコストが急激に膨らんでしまうような設計も厳しいです。

<figure class="figure-image figure-image-fotolife" title="図: ストリーミング/マイクロバッチでの高頻度の読み書きに対応できることが重要">[f:id:morinota:20251217151910p:plain]<figcaption>図: ストリーミング/マイクロバッチでの高頻度の読み書きに対応できることが重要</figcaption></figure>

この観点においては、SageMaker Feature Store は要件を比較的よく満たしていました。オンラインストアは DynamoDB をベースとしており、高頻度な読み書きや並列アクセスに強い設計になっています。また、オフラインストアは S3 + Iceberg をベースとしてるためコストを抑えつつ柔軟に運用することが可能でした。

常に新しいニュース記事が流入し、ユーザの行動も継続的に発生するNewsPicksのようなプロダクトにおいては、**ストリーミング / マイクロバッチでの高頻度な読み書きを、現実的なコストで継続できること**が、特徴量ストアが本番で価値を発揮するための重要な要件だと感じています。

### 観点４: 日常的に使われている DWH / BI ツールからアクセスしやすいこと

特徴量は、それを必要とする任意のチームが容易にアクセスできる必要があります。
既存の文献でも、**価値を発揮する特徴量ストアの重要な要件の1つとして、共有可能性（sharable）**が挙げられています。

> Having a single repository of features that data scientists can search and reuse to help solve their problems is crucial to their productivity.  
> （データサイエンティストが問題を解決するために検索・再利用できる単一の特徴量リポジトリを持つことは、生産性にとって非常に重要です）

> (中略)

> Easily searching through those features, whether that be through SQL or a dataframe-like API, is a must-have for data scientists to be successful. 
> （SQLやデータフレームのようなAPIを通じて、それらの特徴量を簡単に検索できることは、データサイエンティストが成功するために必須です）

> ([5 Minimum Requirements of an Operational Feature Store](https://medium.com/data-for-ai/5-minimum-requirements-of-an-operational-feature-store-ab1436ca1a2c) より引用)

この観点で SageMaker Feature Store を試験運用してみると、NewsPicks開発組織内の現行の分析体験とは必ずしも噛み合わない部分が見えてきました。

SageMaker Feature Store のオフラインストアは S3 + Iceberg をベースとしており、AWS公式の SageMaker Python SDK を使えば、Athena 経由で SQL クエリを投げて特徴量にアクセスできます。
しかし、NewsPicksでは日常的なデータ分析や調査に、SnowflakeやSnowsight（SnowflakeのWeb UI）を中心とした DWH / BI 環境を主に利用しています。そのため、ちょっとした確認のために Athena を経由して S3 上の Iceberg テーブルにクエリを投げる、という体験は、開発メンバーにとってあまり馴染みがあるものではありませんでした。
例えば、「このユーザはどんな特徴量を持っているんだっけ?」とか「この記事の特徴量はどういう値になってるんだっけ?」といった疑問をパッと調べたい場合に、Snowflake 経由でクエリを投げて確認できれば非常に楽なのですが、Athena経由だとハードルがかなり高い訳です。
また、分析用途として Snowsight 上の notebook で Tree 系モデルを使い特徴量の重要度分析を行いたい、といったユースケースもありました。この点でも、Athena ではなく Snowflake 経由で特徴量にアクセスできることが望ましい状況でした。

そこで、SageMaker Feature Store が生成する S3 上の Iceberg テーブルを、Snowflake の外部テーブルとして読み込むことも試みましたが、連携には苦戦しました。
具体的には、Sagemaker側でのIceberg テーブルの初期化時に生成される 0 byte の data file が Snowflake 側で読み込みエラーを引き起こし外部テーブルとして取り込めないという問題に直面しました。当時は明確な解決策が見つからず連携を断念したのでした。

<figure class="figure-image figure-image-fotolife" title="図: 開発組織で日常的に使われているDWH/BIツールからアクセスしやすいこと">[f:id:morinota:20251217154504p:plain]<figcaption>図: 開発組織で日常的に使われているDWH/BIツールからアクセスしやすいこと</figcaption></figure>

こうした経験から、**自社で日常的に使われている DWH / BI ツールから、特徴量ストアに自然にアクセスできること**は、想像以上に重要な要件だと感じています。
技術的に正しく設計されていても、特徴量が「見つけにくい」「触りにくい」状態では共有・再利用は進まず、結果として特徴量ストアの価値も十分に引き出せません。**NewsPicksの文脈では、特に Snowflake を中心とした分析体験と親和性の高い形で特徴量にアクセスできること**が重要なポイントだと考えています。

## 学びを踏まえて、今後の改善の話:

これまでの試験運用を踏まえ、現在はフルマネージドな特徴量ストアをそのまま使い続けるのではなく、**AWSのメジャーなサービスを組み合わせた自前の Feature Store へ段階的に移行することを検討しています。**
具体的には、オフラインストアとして S3テーブルバケット × Icebergテーブル形式、オンラインストアとして DynamoDB を中心に据えた構成です。

この判断に至った背景には、フルマネージドサービスを採用するメリットと、自前で構築するメリットを比較した結果、**今のNewsPicksの文脈では後者の方が柔軟性と学習コストの面で有利だと判断したため**です。

Sagemaker Feature Store を試験運用する中で、前述したいくつかの重要要件を満たすのが難しい場面がありました。
特に、**履歴特徴量のバックフィルの容易さ**に関しては、オフラインストアのみに書き込む公式 API が存在しないため、大量の読み書きが発生する バックフィル 処理が高コストになりがちでした。これを回避するには、結局オフラインストアへ直接書き込む処理を自前で実装する必要があり、フルマネージドサービスとしての恩恵が薄れてしまいます。

また、**特徴量の発見しやすさ・アクセスしやすさ**という観点でも課題がありました。
AWS公式の SageMaker Python SDK は Athena 経由でのアクセスを前提としていましたが、NewsPicksでは Snowflake を中心に DWH / BI ツールを構成しており、日常的な分析フローとの親和性は高くありませんでした。S3 上の Iceberg テーブルを Snowflake から直接参照することも試みましたが、オフラインストアの内部仕様に起因する問題に直面し、スムーズな連携には至りませんでした。こうした点を解消しようとすると、結果的に内部実装を深く理解し、細かくカスタマイズする必要が出てきます。この点でもフルマネージドサービスの恩恵が薄れる感がありました。

さらに、**フルマネージドサービスゆえの学習コスト**の高さも無視できませんでした。
SageMaker Feature Store は比較的新しいサービスであり、仕様や挙動を正しく理解するまでに一定の時間がかかります。加えて、自社のワークロードに合わせたコスト最適化やパフォーマンス改善を行おうとすると、どうしても抽象化の内側を理解する必要があり、その点でも自前実装との差が縮まっていく印象を受けました。

こうした学びを踏まえ、S3 × Iceberg と DynamoDB といった、**NewsPicks開発組織にとって馴染みのある AWS の基盤サービスを組み合わせた特徴量ストア** を構築することで、学習コストを抑えつつ、これまで挙げてきた要件をより素直に満たせるのではないかと考えています。データストアの実体が明確である分、コスト構造や挙動も把握しやすく、プロダクト要件に応じた調整もしやすくなります。

もちろん、これは「フルマネージドサービスを使うべきではない」という話ではありません。
**実際、最初に SageMaker Feature Store を試験運用した判断は非常に良かったと感じています。**AWS 上で稼働する NewsPicks のシステムと親和性が高く、少ない開発コストで特徴量ストアを素早く立ち上げることができましたし、抽象化された特徴量管理基盤として、多くの学びを得ることができました。
現在検討している自前 Feature Store の設計も、SageMaker Feature Store を通じて得た理解を強く反映しています。S3 上の Iceberg テーブルを用いたオフラインストア、DynamoDB を用いたオンラインストア、timestamp カラムを活用した履歴特徴量の管理など、その多くは試験運用の経験があったからこそ自然に導かれた選択です。

## まとめ

本記事では、SageMaker Feature Store を約4ヶ月試験運用した経験をもとに、NewsPicksの文脈で特徴量ストアが真に価値を発揮するために重要だと感じた観点を整理しました。具体的には、以下の4つの観点を紹介しました。

1. リアルタイム推論に必要な特徴量を低レイテンシーで取得できること
2. 履歴特徴量の バックフィル が容易であること
3. ストリーミング/マイクロバッチでの高頻度の読み書きに対応できること
4. 日常的に使われている DWH / BI ツールからアクセスしやすいこと

最後までお読みいただき、ありがとうございました！
もし気になる点や感想などありましたらお気軽にコメントいただけると嬉しいです！
またイベントなどでお会いできた際には、ぜひ気軽に情報交換させてください〜:)

---

最後の最後に、特徴量ストアのようなMLプラットフォーム基盤への投資に関する、最近の自分のお気持ちを記述して締めくくりたいと思います:)

元NetflixのVP of Data Science and EngieeringのEric Colson氏は、「**機械学習プロジェクトは不確実性が高いから、実践しながら学びながら改善し続けるために、分業制ではなくフルサイクルのデータサイエンスゼネラリスト人材であるべき**」と述べています。そして続けて「これらの人材の活躍は、**作業するための堅牢で適度に抽象化されたデータプラットフォームの前提に大きく依存**している」とも主張しています（参考: [Beware the data science pin factory: The power of the full-stack data science generalist and the perils of division of labor through function](https://multithreaded.stitchfix.com/blog/2019/03/11/FullStackDS-Generalists/)）

また、「[Rules of Machine Learning](https://developers.google.com/machine-learning/guides/rules-of-ml)」でも、**MLプロジェクトで直面する問題の多くはエンジニアリングの問題であり、優れた特徴量の重要性や堅牢なデータパイプラインの優先度の高さが強調**されています。

MLOps（ビジネスで機械学習の成果をスケールさせる）のために、特徴量ストアも含めたMLプラットフォーム基盤も頑張るし、フルサイクルなデータサイエンスゼネラリスト的な役割も頑張っていくぞ！やっていくぞ〜！

## 参考文献

- [Sagemaker Feature Store 公式ドキュメント](https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store.html)
- [Feature Store: The Definitive Guide](https://www.hopsworks.ai/dictionary/feature-store)
- [Rules of Machine Learning: Best Practices for ML Engineering](https://developers.google.com/machine-learning/guides/rules-of-ml?hl=ja)
- [Practical Lessons from Predicting Clicks on Ads at Facebook](https://research.facebook.com/publications/practical-lessons-from-predicting-clicks-on-ads-at-facebook/)
- [From MLOps to ML Systems with Feature/Training/Inference Pipelines](https://www.hopsworks.ai/post/mlops-to-ml-systems-with-fti-pipelines)
- [5 Minimum Requirements of an Operational Feature Store](https://medium.com/data-for-ai/5-minimum-requirements-of-an-operational-feature-store-ab1436ca1a2c)
- [Beware the data science pin factory: The power of the full-stack data science generalist and the perils of division of labor through function](https://multithreaded.stitchfix.com/blog/2019/03/11/FullStackDS-Generalists/)
