## refs:

- https://techblog.zozo.com/entry/zozoresearch-bandit-overviews

# どんな話だった??

1. ざっくり:
  1. ZOZOTOWNのトップページのレコメンドにcontexual banditを導入した話。主にシステム設計面の話。
2. contextual banditのシステム構成。
   1. インフラ基盤: GCP。推論・ログ収集・バッチ系はGKE上で動かしている。
   2. コンポーネント間の通信: gRPCを採用。
   3. Gatewayサーバ (クライアントからのリクエストを受け取るプロキシサーバ):
      1. HTTPリクエストを受け取り、gRPCで推薦サーバーへプロキシする。
      2. ABテストの際にはここで振り分けて、推薦サーバーを切り替える。
   4. 推薦サーバ(推薦アイテムの選択と配信):
      1. Goで実装。
      2. 推論に必要なデータ(モデルパラメータやコンテキスト)はGCS Cloud DataStoreから取得。
         1. 多分Cloud DataStoreってオンラインアクセス用のDB...??:thinking:
      3. 推薦サーバのデプロイごとにgRPCサーバを立ち上げて、Gatewayサーバからのリクエストを待ち受ける。
   5. イベントログの収集(トラッキングサーバ & Dataflow):
      1. **推薦サーバーが返却したアイテム毎にユニークなID（以下、配信ID）を付与**しておく。
      2. 配信IDに紐づく形で、以下のような推論時の詳細情報を記録(これは推薦サーバからトラッキングサーバに非同期で送信されるみたいな感じかな...!:thinking:)。:
         1. 配信対象(=ユーザid?)
         2. 配信名(=出面idとか?)
         3. 配信データのバージョン(=モデルのバージョンとか?)
         4. 配信アイテムのid
         5. 予測したclick確率 (=期待報酬の推定値...!)
         6. 表示あたりの予測収益 (=これも期待報酬の推定値...??:thinking:)
         7. アイテムに関するメタデータ (=推論に使ったアイテム特徴量?)
         8. 予測時に用いたユーザのコンテキスト情報 (=推論に使ったユーザ特徴量?)
      3. 配信IDは、impression, click, conversion、その他の関連するユーザ行動があるたびに、トラッキングサーバに送信される。
      4. 送信された配信IDを元に、記録済みの詳細情報と紐付けてPub/Subに送信される。Cloud Dataflowを介してBigQueryに保存される。
   6. バッチ集計:
      1. k8sのCronJobとして、BigQuery上のイベントログを集計するバッチ処理を定期実行している。
      2. context-freeなバンディットの場合は、このタイミングでパラメータ更新を行うらしい。
   7. 半オンラインなcontextual banditのモデル学習:
      1. 更新間隔を早めるために、Cloud Dataflowを用いた半オンライン処理を採用している。(ストリーミング処理というか、マイクロバッチ的なイメージ...??:thinking:)
         1. 同様の枠組みでCVRの予測なども可能だが、**CVは遅れて来ることも多いためストリーミングでの学習は現状CTRのみ**行ってる。(なるほど、**即時にfeedbackが得られるケースじゃないと半オンライン学習を動かすモチベーションが低い**のか...!:thinking:)
      2. Dataflowを用いた学習の流れ:
         1. ログの書き込み: トラッキングサーバからcontext情報を含むimpressionとclickのログをPub/Subに書き込む。
         2. 配信IDをキーに、session windowをかけて(i.e. 時間を絞って) group byして、impressionとclickのペアを作成する。
         3. ミニバッチの学習データセットの作成。指定したサイズ以上のチャンクになるまで待つ。
         4. GCSから前回までのモデルパラメータを取得し、チャンク内のログを用いてパラメータ更新を行い、再度GCSに保存する。
            1. モデルレジストリはGCSなのね :thinking:
      
