## これは何?

- Text2SQLサービスの実現のために、個人的に情報収集した内容を雑多にまとめたものです。
- ２回目は、Text2SQLの既存の事例を調べてみています。

## Linkedinさんの事例

### 導入

- モチベーション
  - **テック企業のデータ専門家は、同僚が必要とするデータを見つける手助けに多くの時間を費やす**。
  - このボトルネックはデータチームを苛立たせるだけでなく、**重要な洞察を待っているビジネスパートナーに遅延**を引き起こす。
- 解決策
  - データ民主化の取り組みの一環として、Text2SQLのBotを開発・導入した。
  - 導入されたBotは、**LangChainとLangGraphで実装されたマルチエージェントシステム**。
    - ここでマルチエージェントっていうのは、SQLのgeneratorとreviewerがいて、それぞれがAgenticにアクションを決定する、みたいな感じなんだろうか...!:thinking:
- 本ブログで記述されるのは、**実用的なText2SQLソリューションをデプロイするために採用した重要な戦略たち**。
  - 現在は、LinkedInの多様なビジネス分野で数百人の従業員がこのBotを使用してるらしい。(ちゃんとPoCで終わらせずに普及させてるのが凄い...!:thinking:)

### 戦略1: 高品質なテーブルメタデータとパーソナライズされたretreival

- Embedding-Based Retrieval(EBR)に基づくRAGを採用
  - **Text2SQLタスクはしばしばRAGアプリケーションとして位置付けられる**。
    - なんで??
      - Text2SQLのタスクを精度高く解くためには、テーブルスキーマ、サンプルクエリ、その他のドメイン知識などが必要。
      - よって、LLM自身の内部知識のみでは不十分であり、Context Constructionが必要。
      - Context Constructionの一番有名な手法がRAG(Retriever-Reader-Generator)
    - 本事例では特に、**EBRに基づくRAGを採用して、Context Constructionを実装してる**みたい。
- RAGの精度を高めるための工夫たち。
  - 課題1: テーブルの説明文の頻繁な欠如や不完全さ。
    - 対応策: 数百の重要なテーブルの包括的な説明を収集するための、dataset certificationという取り組み。
      - **各ドメインエキスパートに依頼して、自分の分野内の重要なテーブルを特定**し、必須のテーブル説明と任意のフィールド説明を書いてもらった。
      - 説明文は、既存の文書やSlackの履歴に基づいたLLMによる注釈で補完された。
        - (人手でメタデータを整備してから、LLMに整形させるパターン??:thinking:)
  - 課題2: とにかくテーブル数の膨大さと、ユーザの質問に含まれる暗黙的なコンテキスト。
    - 前者への対応: **アクセスの人気を見ることで、テーブルの数を数千に簡単に絞り込める**。
    - 後者への対応: **組織図に基づいてユーザのデフォルトデータセット(=たぶんテーブル集合!)を推測**するようにした。
      - ex. 「昨日の平均CTRは何でしたか？」という質問は、ユーザがメール通知、広告、または検索品質に興味があるかどうかによって異なる答えが必要。
      - たぶんEBRに基づくRAGをする前のテーブル集合を、パーソナライズするような感じ!
        - ユーザは必要に応じてデフォルトのフィルタ値(RAG対象のテーブル集合)を変更することができる。
- 新しいテーブルやフィールドを自動で取り込むための工夫。
  - 実務上、テーブルやフィールドは時間とともに廃止されたり追加されたりする。
  - 新しいテーブルを取得するプロセスを自動化するために、**人気のあるテーブルを自動的にベクターストアに取り込む**ようにした。
  - また、**ユーザがテーブルやフィールドを「deprecated」マークできる**ようにした。
    - →このフラグを元に、テーブルやフィールドを自動的にオフボード(退職)させるプロセスを実装した。

### 戦略2: 知識グラフとLLMsによるランキング、生成、自己修正

- 知識グラフの活用
- LLM re-ranking
- 段階的なクエリ生成
- 自動エラーチェック & 修正

### 戦略3: リッチなチャット機能を用いたユーザ体験

- Text2SQL Bot と 分析プラットフォームの統合
- クイックアクションの提供
- ガイド付きモードの提供
- テーブル & クエリのリッチ表示

### 戦略4: ユーザカスタマイズのオプション

- 利用するデータセットのカスタマイズ
- カスタム指示
- ユーザによるサンプルクエリの追加

### 戦略5: 継続的なbenchmarking

- LLM-as-a-Judgeによる評価
- 130以上のベンチマーク質問
- 再ランキングやメタデータ追加による改善

### まとめ & 今後の展望
