## Quick Startãƒ¡ãƒ¢

### ã‚°ãƒ©ãƒ•å®šç¾©ã®ã–ã£ãã‚Šã—ãŸæµã‚Œ

- ã‚°ãƒ©ãƒ•ã‚’å®šç¾©ã™ã‚‹éš›ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€**ã‚°ãƒ©ãƒ•ã®çŠ¶æ…‹(state)ã‚’å®šç¾©ã™ã‚‹**ã“ã¨ã€‚
  - stateã«ã¯ã€ã‚¹ã‚­ãƒ¼ãƒã¨ã€**çŠ¶æ…‹æ›´æ–°ã‚’å‡¦ç†ã™ã‚‹reduceré–¢æ•°**ãŒå«ã¾ã‚Œã‚‹ã€‚
  - reduceré–¢æ•°ã«ã¤ã„ã¦ã€‚
    - reducerã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ãªã„ã‚­ãƒ¼ã¯ã€ä»¥å‰ã®å€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚
    - reduceré–¢æ•°`add_messages`ãŒã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æŒ‡å®šã•ã‚Œã¦ã‚‹å ´åˆã€æ–°ã—ã„å€¤ãŒlistã«è¿½åŠ ã•ã‚Œã¦ã„ãã€ä¸Šæ›¸ãã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ã€‚

```python
class State(TypedDict):
    messages: Annotated[list, add_messages] 
    is_ask_human: bool

graph_builder = StateGraph(State)
```

- ç¬¬äºŒã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ãƒãƒ¼ãƒ‰(Node)ã‚’è¿½åŠ ã™ã‚‹ã€‚
  - **ãƒãƒ¼ãƒ‰ã¯ã€ä½œæ¥­ã®å˜ä½ã‚’è¡¨ã™**ã€‚
  - ãƒãƒ¼ãƒ‰ã¯é€šå¸¸ã€**stateã‚’å—ã‘å–ã‚Šstateã‚’è¿”ã™Pythoné–¢æ•°**ã¨ã—ã¦å®šç¾©ã•ã‚Œã‚‹ã€‚
    - ä¸‹ã®ä¾‹ã§ã¯ã€`chatbot`ãƒãƒ¼ãƒ‰é–¢æ•°ã¯ã€stateã‚’å—ã‘å–ã‚Šã€`messages`ã‚­ãƒ¼ã«æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¹ãƒˆå‹ã§æŒ‡å®šã—ã¦è¿”ã—ã¦ã„ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰è¿°ã®`add_messages`reduceré–¢æ•°ãŒ`messages`ã‚­ãƒ¼ã«æ–°ã—ã„å€¤ã‚’è¿½åŠ ã—ã¦ãã‚Œã‚‹ã£ã½ã„...!:thinking: 
      - ã¤ã¾ã‚Šã€**ãƒãƒ¼ãƒ‰é–¢æ•°å†…ã§æ˜ç¤ºçš„ã«ã€state["messages"] + [response] ã¿ãŸã„ãªã“ã¨ã‚’ã™ã‚‹å¿…è¦ã¯ãªã„ã£ã½ã„...!**
- ãƒãƒ¼ãƒ‰é–¢æ•°ã‚’å®šç¾©å¾Œã€`graph_builder.add_node`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ãƒãƒ¼ãƒ‰ã‚’ã‚°ãƒ©ãƒ•ã«ç™»éŒ²ã™ã‚‹ã€‚
  - ç¬¬ä¸€å¼•æ•°ã¯ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒãƒ¼ãƒ‰åã€‚
  - ç¬¬äºŒå¼•æ•°ã¯ã€ãƒãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°orã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚

```python

llm = ChatOpenAI(model="gpt-4o-mini")

def chatbot(state: State) -> State:
    response = llm.invoke(state["messages"])
    return {"messages": [response], "is_ask_human": False}

graph_builder.add_node("chatbot", chatbot)
```

- ç¬¬ä¸‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ã€‚
  - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯ã€**ã‚°ãƒ©ãƒ•ãŒèµ·å‹•ã™ã‚‹ãŸã³ã«ä½œæ¥­ã‚’é–‹å§‹ã™ã‚‹å ´æ‰€(ãƒãƒ¼ãƒ‰)**ã®ã“ã¨ã€‚
    - STARTã¨ã„ã†ç‰¹åˆ¥ãªãƒãƒ¼ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã§ãã‚‹ã€‚
  - ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã¯ã€**ã“ã®ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ã‚°ãƒ©ãƒ•ã®ä½œæ¥­ã‚’çµ‚äº†ã™ã‚‹å ´æ‰€(ãƒãƒ¼ãƒ‰)**ã®ã“ã¨ã€‚
    - ENDã¨ã„ã†ç‰¹åˆ¥ãªãƒãƒ¼ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã§ãã‚‹ã€‚

```python
from langgraph.graph import END, START

# STARTãƒãƒ¼ãƒ‰ã‹ã‚‰chatbotãƒãƒ¼ãƒ‰ã¸ã®ã‚¨ãƒƒã‚¸ã‚’è¿½åŠ 
graph_builder.add_edge(START, "chatbot")
# chatbotãƒãƒ¼ãƒ‰ã‹ã‚‰ENDãƒãƒ¼ãƒ‰ã¸ã®ã‚¨ãƒƒã‚¸ã‚’è¿½åŠ 
graph_builder.add_edge("chatbot", END)
```

- æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ã‚°ãƒ©ãƒ•ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
  - ã‚°ãƒ©ãƒ•ãƒ“ãƒ«ãƒ€ãƒ¼ã®`compile()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã“ã¨ã§ã€ã‚°ãƒ©ãƒ•ã‚’å®Ÿè¡Œå¯èƒ½ãªé–¢æ•°ã«å¤‰æ›ã§ãã‚‹ã€‚
    - compile()ã®è¿”ã‚Šå€¤ã¨ã—ã¦ã€ã€ŒCompiledGraphã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹ã€‚
    - CompiledGraphã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**stateã‚’å…¥åŠ›ã¨ã—ãŸ`invoke()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚„`stream()`ãƒ¡ã‚½ãƒƒãƒ‰**ã‚’æŒã¤ã€‚
      - ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ä¾‹ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’stateã«è©°ã‚ã¦ã€`invoke()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚„`stream()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å¿œç­”ã‚’å–å¾—ã§ãã‚‹ã€‚

```python
graph = graph_builder.compile()
```

### ã‚°ãƒ©ãƒ•ã«toolã‚’è¿½åŠ ã™ã‚‹

- ã¾ãšLLMã«ã€ã©ã‚“ãªtoolãŒåˆ©ç”¨ã§ãã‚‹ã‹ã‚’çŸ¥ã‚‰ã›ã‚‹æ–¹æ³•ã¨ã—ã¦ã€`bind_tools`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã€‚
  - ã“ã‚Œã«ã‚ˆã‚Šã€**LLMã¯å„ç¨®toolã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã®æ­£ã—ã„JSONå½¢å¼ã‚’çŸ¥ã‚‹**ã“ã¨ãŒã§ãã‚‹ã€‚
  - `bind_tools`ã¯toolä»¥å¤–ã«ã‚‚è‰²ã€…llmã«æƒ…å ±ã‚’æ¸¡ã›ã‚‹ã£ã½ã„ãŒã€ä»Šå›ã§ã¯ã€å½¼ã‚‰ãŒã©ã‚“ãªtoolã‚’å‘¼ã³å‡ºã›ã‚‹ã‹ã‚’çŸ¥ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚

```python
llm = ChatOpenAI(model="gpt-4o-mini")
llm_with_tools = llm.bind_tools(tools)
```

- æ¬¡ã«ã€**toolãŒå‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã«å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°**ã‚’ä½œæˆã™ã‚‹ã€‚
  - toolã¯ã€langchainã®toolãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã£ã¦è‡ªå‰ã§å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚Œã°ã€`TavilySearchResults`ãªã©ã®`langchain_community.tools`ã§äº‹å‰ã«å®šç¾©ã•ã‚ŒãŸã‚‚ã®ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ã€‚
- toolé–¢æ•°ã‚’ãƒãƒ¼ãƒ‰ã«ã—ã¦ã€ã‚°ãƒ©ãƒ•ã«ç™»éŒ²ã™ã‚‹ã€‚
  - å®Ÿéš›ã«ã¯ã€LangGraphå´ã§pre-buildã•ã‚ŒãŸ`ToolNode`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ãˆã°ã‚ˆã„!!
    - chatbotã¨ã¯åˆ¥ã®ã€**ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹çš„ãªãƒãƒ¼ãƒ‰ã‚’å®šç¾©**ã™ã‚‹æ„Ÿã˜...!
    - å¼•æ•°ãŒ`tools`ãªã®ã§ã€1ã¤ã®toolã§1ã¤ã®ãƒãƒ¼ãƒ‰ã§ã¯ãªãã€è¤‡æ•°ã®toolã‚»ãƒƒãƒˆã«å¯¾ã—ã¦1ã¤ã®ãƒãƒ¼ãƒ‰ã«ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸...!:thinking:

```python
from langchain_community.tools.tavily_search import TavilySearchResults

# TavilySearchResultsã‚’ä½¿ã£ã¦ã€æ¤œç´¢ç”¨toolã‚’å®šç¾©
tool = TavilySearchResults(max_results=2)

# ToolNodeã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã€ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹çš„ãªãƒãƒ¼ãƒ‰ã‚’å®šç¾©
tool_node = ToolNode(tools=[tool])
# ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒ‰ã‚’ã‚°ãƒ©ãƒ•ã«ç™»éŒ²
graph_builder.add_node("tools", tool_node)
```

### ã‚°ãƒ©ãƒ•ã«æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã‚’è¿½åŠ ã™ã‚‹

- ã‚¨ãƒƒã‚¸ã¯ã€1ã¤ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¬¡ã®ãƒãƒ¼ãƒ‰ã¸ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚
  - å‰è¿°ã§ã¯ã€ã‚°ãƒ©ãƒ•ãƒ“ãƒ«ãƒ€ãƒ¼ã®`add_edge()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ`START`ã¨`chatbot`ãƒãƒ¼ãƒ‰ã®é–“ã«ã‚¨ãƒƒã‚¸ã‚’è¿½åŠ ã—ã¦ã„ãŸã€‚
  - **æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã¯ã€é€šå¸¸ã€Œifã€æ–‡ã‚’å«ã¿ã€ç¾åœ¨ã®ã‚°ãƒ©ãƒ•çŠ¶æ…‹ã«å¿œã˜ã¦ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**ã™ã‚‹ã€‚
- æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã‚’è¿½åŠ ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
  - ã¾ãšã€**ifæ–‡ã‚’å«ã‚€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°**ã‚’å®šç¾©ã™ã‚‹ã€‚
    - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°ã¯ã€**ç¾åœ¨ã®ã‚°ãƒ©ãƒ•ã®stateã‚’å…¥åŠ›ã¨ã—ã€æ¬¡ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ã‚’ç¤ºã™`str`ã‚‚ã—ãã¯`list[str]`ã‚’è¿”ã™**ã€‚
  - æ¬¡ã«ã€ã‚°ãƒ©ãƒ•ãƒ“ãƒ«ãƒ€ãƒ¼ã®`add_conditional_edges()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°ã‚’æ¸¡ã—ã¦ã€æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã‚’ã‚°ãƒ©ãƒ•ã«ç™»éŒ²ã™ã‚‹ã€‚
    - ã“ã‚Œã«ã‚ˆã‚Š**ã‚½ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰ãŒå®Œäº†ã™ã‚‹ãŸã³ã«ã€ã‚°ãƒ©ãƒ•ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€æ¬¡ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ã‚’æ±ºå®šã™ã‚‹ã‚ˆã†ã«ãªã‚‹**...!
    - å¼•æ•°:
      - `source`: æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã®å§‹ç‚¹ã¨ãªã‚‹ãƒãƒ¼ãƒ‰å
      - `path`: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°(ã‚°ãƒ©ãƒ•ã®stateã‚’å¼•æ•°ã«ã¨ã‚Šã€`str`ã‚‚ã—ãã¯`list[str]`ã‚’è¿”ã™)
      - `path_map`: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°ã®è¿”ã‚Šå€¤ã®`str`ã«å¯¾å¿œã™ã‚‹ã€ãƒãƒ¼ãƒ‰åã®mapã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€æ’ç­‰é–¢æ•°(i.e. key=valueã®map!)ã«ãªã‚‹ã€‚

```python
def route_tools(state: State) -> str | list[str]:
    """
    ç¾åœ¨ã®ã‚°ãƒ©ãƒ•çŠ¶æ…‹ã‚’å—ã‘å–ã‚Šã€æ¬¡ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ã‚’ç¤ºã™ æ–‡å­—åˆ—oræ–‡å­—åˆ—ã®list ã‚’è¿”ã™ã€‚
    """
    # ã¾ãšã‚°ãƒ©ãƒ•ã®stateã‹ã‚‰ã€æ¡ä»¶åˆ†å²ã«å¿…è¦ãªæƒ…å ±ã‚’å–å¾—(ã“ã®ä¾‹ã§ã¯ã€æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
    if isinstance(state, list):
        # stateã‚’listå½¢å¼ã§å®šç¾©ã—ã¦ã„ã‚‹å ´åˆã¯ã€æœ€å¾Œå°¾ã®è¦ç´ ã‚’å–å¾—
        ai_message = state[-1]
    elif messages := state.get("messages", []):
        # stateã‚’dictå½¢å¼ã§å®šç¾©ã—ã¦ã„ã‚‹å ´åˆã¯ã€messagesã‚­ãƒ¼ã®æœ€å¾Œå°¾ã®è¦ç´ ã‚’å–å¾—
        ai_message: AIMessage = messages[-1]
    else:
        raise ValueError(f"No messages found in input state to tool_edge: {state}")
    
    # ifæ–‡ã‚’ä½¿ã£ã¦ã€æ¬¡ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ã‚’æ±ºå®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
    if hasattr(ai_message, "tool_calls") and len(ai_message.tool_calls) > 0:
        return "tools" # æ¬¡ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ã‚’è¡¨ã™strã‚’è¿”ã™ã€‚
    return END

graph_builder.add_conditional_edges(
    source="chatbot", # æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã®å§‹ç‚¹
    path=route_tools, # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°
    path_map={"tools": "tools", END: END}, # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢æ•°ã®è¿”ã‚Šå€¤ã«å¯¾å¿œã™ã‚‹ãƒãƒ¼ãƒ‰åã®map
```

- ãªãŠã€ä¸Šã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯ã€**stateå†…ã®æœ€æ–°ã®AI Messageã«`tool_calls`ãŒã‚ã‚‹ã‹å¦ã‹ã§ã€toolsãƒãƒ¼ãƒ‰ã«é·ç§»ã™ã‚‹ã‹ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã«é·ç§»ã™ã‚‹ã‹ã‚’æ±ºå®š**ã—ã¦ã„ã‚‹ã€‚
  - ã“ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯é »å‡ºãªã®ã§ã€LangGraphã§ã¯`tools_condition`é–¢æ•°ã¨ã—ã¦å®Ÿè£…ãšã¿ã€‚
  - `tools_condition()`é–¢æ•°ã¯ã€ã‚°ãƒ©ãƒ•ã®stateã‚’å¼•æ•°ã«ã¨ã‚Šã€æœ€æ–°ã®AI Messageã«`tool_calls`ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã€`"tools"`ã‚’è¿”ã—ã€ãã‚Œä»¥å¤–ã®å ´åˆã¯`END`ã‚’è¿”ã™ã€‚(ã¾ã•ã«ä¸Šã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¨æŒ¯ã‚‹èˆã„ãŒåŒã˜é–¢æ•°!:thinking:)
  - ã‚‚ã—ä»®ã«ãƒãƒ¼ãƒ‰åã‚’`"my_tools"`ãªã©ã«ã—ãŸå ´åˆã¯ã€path_mapå¼•æ•°ã«ã¦`{"tools": "my_tools", END: END}`ã¨æŒ‡å®šã™ã‚Œã°OK!

### ã‚°ãƒ©ãƒ•ã«ãƒ¡ãƒ¢ãƒª(ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ)ã‚’è¿½åŠ ã™ã‚‹

- å‰è¿°ã¾ã§ã®æŠ€è¡“ã§ã€ãƒãƒ£ãƒƒãƒˆbotãŒãƒ¦ãƒ¼ã‚¶ã®è³ªå•ã«ç­”ãˆã‚‹ãŸã‚ã«toolã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ã—ã‹ã—ã€ä»¥å‰ã®ã‚„ã‚Šå–ã‚Šã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨˜æ†¶ã—ã¦ã„ãªã„ã€‚
- LangGraphã¯ã€**æ°¸ç¶šçš„ãªãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**ã‚’ä½¿ç”¨ã—ã¦ã€ã“ã®å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã€‚
  - **ã‚°ãƒ©ãƒ•ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹éš›ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿(thread_id)ã‚’æä¾›ã—ã€ã‚°ãƒ©ãƒ•ã‚’å‘¼ã³å‡ºã™éš›ã«thread_idã‚’æŒ‡å®šã™ã‚‹**ã¨ã€LangGraphã¯å„ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«è‡ªå‹•çš„ã«çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ã€‚
  - åŒã˜thread_idã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ©ãƒ•ã‚’å†åº¦å‘¼ã³å‡ºã™ã¨ã€**ã‚°ãƒ©ãƒ•ã¯ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã€ä»¥å‰ã®ã‚„ã‚Šå–ã‚Šã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¶­æŒ**ã§ãã‚‹ã€‚
- å¾Œè¿°ã•ã‚Œã‚‹ã‹ã‚‚ã ãŒã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯å˜ç´”ãªãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ¢ãƒªã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«å¼·åŠ›ã€‚
  - ã‚¨ãƒ©ãƒ¼å›å¾©ã‚„äººé–“ã®ä»‹å…¥ãŒå¿…è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã®ãŸã‚ã«ã€**ã„ã¤ã§ã‚‚è¤‡é›‘ãªçŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦å†é–‹ã§ãã‚‹**...!

- ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€ã¾ãš**checkpointã®ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–**ã™ã‚‹ã€‚
  - ä¸‹ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯ã€in-memoryã®checkpointerã§ã‚ã‚‹`MemorySaver()`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚(=**å…¨ã¦ã‚’ãƒ¡ãƒ¢ãƒªå†…ã«ä¿å­˜ã™ã‚‹!**)
  - ãŠãã‚‰ãæœ¬ç•ªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€`SqliteSaver()`ã‚„`PostgresSaver()`ãªã©ã‚’ä½¿ã£ã¦æœ¬ç•ªDBã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒå¤šã„ã‹ã‚‚ã€‚

```python
from langgraph.checkpoint.memory import MemorySaver
memory = MemorySaver()
```

- æ¬¡ã«ã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚°ãƒ©ãƒ•ã«æ¸¡ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹
  - å…·ä½“çš„ã«ã¯ã€`checkpointer` å¼•æ•°ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹ã€‚
  - ã‚°ãƒ©ãƒ•ã®å½¢ã¯å¤‰ã‚ã‚‰ãªã„ã€‚
  - ã“ã®æŒ‡å®šã«ã‚ˆã£ã¦å¤‰ã‚ã£ãŸã®ã¯ã€**ã‚°ãƒ©ãƒ•ãŒå„ãƒãƒ¼ãƒ‰ã‚’é€šéã™ã‚‹éš›ã«Stateã‚’checkpoint(è¨˜éŒ²)ã™ã‚‹ã“ã¨ã ã‘**ã€‚
    - (å„ãƒãƒ¼ãƒ‰ã®å‡¦ç†ãŒã‚ˆã°ã‚Œã‚‹ãŸã³ã«ã€ãã®æ™‚ç‚¹ã®Stateã‚’ãã‚Œãã‚Œä¿å­˜ã—ã¦ãŠãã£ã¦ã“ã¨ã€‚å†åˆ©ç”¨ã‚„ã‚¨ãƒ©ãƒ¼æ™‚ã®å†é–‹ã«ä¾¿åˆ©ãã†...!:thinking:)

```python
graph = graph_builder.compile(checkpointer=memory)
```

- æœ€å¾Œã«ã€ã‚°ãƒ©ãƒ•ã®å®Ÿè¡Œæ™‚ã«ã¯ã€stateã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
  - `config`ã¯ã€ã‚°ãƒ©ãƒ•ã®`invoke()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚„`stream()`ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬äºŒä½ç½®å¼•æ•°ã¨ã—ã¦æŒ‡å®šã§ãã‚‹ã€‚

```python
config = {"configurable": {"thread_id": "1"}}

events = graph.stream({"messages": [("user", "My name is Will.")]}, config, stream_mode="values")

# ã‚„ã‚Šå–ã‚Šã®çµæœã‚’è¡¨ç¤º
for event in events:
    event["messages"][-1].pretty_print()
# ================================[1m Human Message [0m=================================
# My name is Will.
# ==================================[1m Ai Message [0m==================================
# Hello Will! It's nice to meet you. How can I assist you today? Is there anything specific you'd like to know or discuss?
```

- å‹•ä½œç¢ºèªã¨ã—ã¦ã€å†åº¦ã‚°ãƒ©ãƒ•ã‚’`invoke()`ã—ã¦ã€å‰å›ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦šãˆã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  - (ç¶šã‘ã¦ä¸Šã®ã‚³ãƒ¼ãƒ‰ã®ä¸‹ã«æ›¸ã! ä»Šå›ã¯ãƒ¡ãƒ¢ãƒªä¸Šã«checkpointingã—ã¦ã‚‹ã®ã§ã€ä¸€å›ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è½ã¨ã™ã¨ãƒ¡ãƒ¢ãƒªãŒè§£æ”¾ã•ã‚Œã¦ã—ã¾ã†...! :thinking:)
  - (ã¡ãªã¿ã«ã€æŒ‡å®šã™ã‚‹thread_idã‚’å¤‰ãˆã‚‹ã¨ã€å…ƒã®thread_idã®ãƒ¡ãƒ¢ãƒªã¯èª­ã¿è¾¼ã¾ã‚Œãªã„ã®ã§ã€åå‰ã‚’è¦šãˆã¦ã„ãªã„çŠ¶æ…‹ã«ãªã‚‹...!:thinking_face:)

```python
user_input = "Remember my name?"
events = graph.stream({"messages": [("user", user_input)]}, config, 
streammode="values")

# ã‚„ã‚Šå–ã‚Šã®çµæœã‚’è¡¨ç¤º
for event in events:
    event["messages"][-1].pretty_print()
# ================================[1m Human Message [0m=================================
# Remember my name?
# ==================================[1m Ai Message [0m==================================
# Of course, I remember your name, Will. I always try to pay attention to important details that users share with me. Is there anything else you'd like to talk about or any questions you have? I'm here to help with a wide range of topics or tasks.
```

ä¸Šè¨˜ã¾ã§ã®æŠ€è¡“ã§ã€**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è·¨ã„ã§ã‚°ãƒ©ãƒ•ã®stateã‚’ç¶­æŒã§ãã‚‹**ã‚ˆã†ã«ãªã£ãŸ!
ã§ã¯**checkpointã«ã¯ã©ã‚“ãªæƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹??**

- æŒ‡å®šã—ãŸconfigã«å¯¾ã—ã¦ã€ã‚°ãƒ©ãƒ•ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€`graph.get_state(config)`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã€‚è¿”ã‚Šå€¤ã¨ã—ã¦`StateSnapshot`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹ã€‚
  - `StateSnapshot`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®fieldã‚’æŒã¤ã€‚
    - `values`: ç¾åœ¨ã®ã‚°ãƒ©ãƒ•ã®stateã‚’è¡¨ã™ã€‚
    - `next`: æ¬¡ã®stateã‚’è¡¨ã™ã€‚
      - æœ€æ–°ã®stateã®`StateSnapshot`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ã€ç©ºã€‚
    - `config`: è¨­å®šã‚„snapshotã®é–¢é€£æƒ…å ±ã‚’è¨˜éŒ²ã€‚
    - `metadata`: snapshotã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã€‚(ã‚ˆãã‚ã‹ã£ã¦ãªã„!)
    - `created_at`: snapshotã®ä½œæˆæ—¥æ™‚ã‚’è¨˜éŒ²ã€‚
    - `parent_config`: è¦ªsnapshotã®configã€‚(ã‚ˆãã‚ã‹ã£ã¦ãªã„!)
    - `tasks`: snapshotã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ãƒªã‚¹ãƒˆã€‚(ã‚ˆãã‚ã‹ã£ã¦ãªã„!)

```python
# ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€ã‚°ãƒ©ãƒ•ã®stateã‚’å–å¾—
snapshot = graph.get_state(config)
prin(snapshot)

# StateSnapshot(values={'messages': [HumanMessage(content='My name is Will.', additional_kwargs={}, response_metadata={}, id='8c1ca919-c553-4ebf-95d4-b59a2d61e078'), AIMessage(content="Hello Will! It's nice to meet you. How can I assist you today? Is there anything specific you'd like to know or discuss?", additional_kwargs={}, response_metadata={'id': 'msg_01WTQebPhNwmMrmmWojJ9KXJ', 'model': 'claude-3-5-sonnet-20240620', 'stop_reason': 'end_turn', 'stop_sequence': None, 'usage': {'input_tokens': 405, 'output_tokens': 32}}, id='run-58587b77-8c82-41e6-8a90-d62c444a261d-0', usage_metadata={'input_tokens': 405, 'output_tokens': 32, 'total_tokens': 437}), ... 'is_ask_human': False}, thread_id='1')
```

### ã‚°ãƒ©ãƒ•ã«ã€Human-in-the-Loopçš„ã«ã€äººé–“ã®æ‰¿èªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹1

- LangGraphã®`interrupt_before`æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã®å®Ÿè¡Œæ™‚ã«ã‚°ãƒ©ãƒ•å®Ÿè¡Œã‚’ä¸­æ–­ã—ã€äººé–“ã®æ‰¿èªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ã™ã‚‹ã€‚
  - å…·ä½“çš„ã«ã¯ã€ã‚°ãƒ©ãƒ•ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«`interrupt_before`å¼•æ•°ã‚’æŒ‡å®šã™ã‚Œã°è‰¯ã„ã€‚

```python
graph = graph_builder.compile(
    checkpointer=memory,
    # toolsãƒãƒ¼ãƒ‰ã®å®Ÿè¡Œå‰ã«ã€å¿…ãšã‚°ãƒ©ãƒ•ã®å®Ÿè¡Œã‚’ä¸­æ–­ã™ã‚‹
    interrupt_before=["tools"], 
    # interrupt_after=["tools"]
)
```

- å‹•ä½œç¢ºèªã—ã¦ã¿ã‚‹ã¨...

```python
user_input = "I'm learning LangGraph. Could you do some research on it for me?"
config = {"configurable": {"thread_id": "1"}}
events = graph.stream({"messages": [("user", user_input)]}, config, stream_mode="values")

# ã‚°ãƒ©ãƒ•ã®ä¸€é€£ã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
for event in events:
    if "messages" in event:
        event["messages"][-1].pretty_print()
# ä»¥ä¸‹ã®å‡ºåŠ›ã‚’è¦‹ã‚‹ã¨ã€chatbotãƒãƒ¼ãƒ‰ã®å®Ÿè¡Œå¾Œã«ã€toolsãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ã€ã‚°ãƒ©ãƒ•ã®å®Ÿè¡ŒãŒä¸­æ–­ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

# ================================[1m Human Message [0m=================================

# I'm learning LangGraph. Could you do some research on it for me?
# ==================================[1m Ai Message [0m==================================

# [{'text': "Certainly! I'd be happy to research LangGraph for you. To get the most up-to-date and comprehensive information, I'll use the Tavily search engine to look this up. Let me do that for you now.", 'type': 'text'}, {'id': 'toolu_01R4ZFcb5hohpiVZwr88Bxhc', 'input': {'query': 'LangGraph framework for building language model applications'}, 'name': 'tavily_search_results_json', 'type': 'tool_use'}]
# Tool Calls:
#   tavily_search_results_json (toolu_01R4ZFcb5hohpiVZwr88Bxhc)
#  Call ID: toolu_01R4ZFcb5hohpiVZwr88Bxhc
#   Args:
#     query: LangGraph framework for building language model applications

# ã¡ãªã¿ã«snapshotã‚’å–å¾—ã—ã¦ã€æ¬¡ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã¨...
snapshot = graph.get_state(config)
snapshot.next
# >>> ('tools',)

# ã¡ãªã¿ã«snapshotã‹ã‚‰ã€ç¾åœ¨ã®stateã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã™ã‚‹ã¨...
existing_message = snapshot.values["messages"][-1]
existing_message.tool_calls
# [{'name': 'tavily_search_results_json', 'args': {'query': 'LangGraph framework for building language model applications'}, 'id': 'toolu_01R4ZFcb5hohpiVZwr88Bxhc', 'type': 'tool_call'}]
```

- ã•ã¦ã€äººé–“ã®æ‰‹ã«ã‚ˆã£ã¦ã€ä¸­æ–­ã—ãŸã‚°ãƒ©ãƒ•ã®å®Ÿè¡Œã‚’å†é–‹ã•ã›ã¦ã¿ã‚‹ã€‚
  - **stateã¨ã—ã¦`None`ã‚’æ¸¡ã™ã“ã¨ã§ã€ã‚°ãƒ©ãƒ•ã¯æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãªãã€å…ƒã®ä½ç½®ã‹ã‚‰ç¶šè¡Œã™ã‚‹**ã€‚
    - Noneã¯ç¾åœ¨ã®stateã«ä½•ã‚‚è¿½åŠ ã—ãªã„ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚
  - checkpointerã‚’è¿½åŠ æ¸ˆã¿ã§ã‚ã‚Œã°ã€ã‚°ãƒ©ãƒ•ã¯ç„¡æœŸé™ã«ä¸€æ™‚åœæ­¢ã§ãã€ã„ã¤ã§ã‚‚å†é–‹ã§ãã‚‹ã€‚

```python
# stream()ãƒ¡ã‚½ãƒƒãƒ‰ã«Noneã‚’æ¸¡ã—ã¦ã€ç¾åœ¨ã®çŠ¶æ…‹ã‹ã‚‰å†é–‹ã™ã‚‹
events = graph.stream(None, config, stream_mode="values")

for event in events:
    if "messages" in event:
        event["messages"][-1].pretty_print()
# æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå†åº¦è¡¨ç¤ºã•ã‚Œã¦...
# ãã®å¾Œã«ã€toolsãƒãƒ¼ãƒ‰ã®å®Ÿè¡Œçµæœã‚‚è¡¨ç¤ºã•ã‚Œã¦...
# æœ€çµ‚çš„ã«ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ³ãƒˆã«åˆ°é”ã™ã‚‹
```
