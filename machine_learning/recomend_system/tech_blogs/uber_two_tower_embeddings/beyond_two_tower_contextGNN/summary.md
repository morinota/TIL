# Two-Towerモデルを超えていけ! GNNでペアワイズモデル×Two-Towerモデルを組み合わせた手法 ContextGNNを提案する論文を読んだ!

## ざっくり論文概要!

- hoge

## 背景、本論文のモチベーション

- 背景: 推薦システムでTwo-Towerモデルが人気!
  - 推薦システムはユーザとアイテムのマッチングを最適化するようなML応用分野で、長年発展してきた。
  - 特に、**Two-Tower モデル（ユーザタワー＋アイテムタワー）**が主流。
    - 事前に埋め込みを計算できて、MIPS(Maximum Inner Product Search)で高速ランキング可能！
    - 実運用しやすく、スケーラビリティも◎（例：AmazonやNetflixで活躍）
- 課題: Two-Towerモデルの限界
  - **ペア非依存な表現しか学べない**（pair-agnostic）
    - ユーザ埋め込みはアイテムの情報を知らないし、逆にアイテム埋め込みもユーザの情報を知らない。
    - 結果として、ユーザ*アイテムのペアワイズな情報を反映できない。
  - 具体的には...
    - 馴染みのある再購入(ex. 定期的な化粧品購入) vs 探索的購入(ex. 新商品開拓) を区別できない。
- 既存の課題解決策とその問題:
  - 全部のユーザ×アイテムにペアワイズ表現を作る → 計算コストが**O(N×M)**で現実的じゃない...!
  - 事前に候補絞る(pre-filtering)
    - ex. CBやCFで候補を絞る
    - ただしRecallに依存。フィルタ精度が低いと全体の性能が落ちる。
- そこで...本論文の提案手法 「ContextGNN」!
  - GNNを使って、**Two-TowerとPairwiseモデルの良いとこどり**!
    - ローカル: 近傍のペアに対してはGNNベースのペアワイズ表現を活用!
    - グローバル: 遠くのアイテムはGNNベースのTwo-Tower埋め込みで対応!
    - 融合ネットワーク: ユーザごとに両者を動的に合成!

## GNNを用いたSequential Recommendation

### グラフを用いたSequential Recommendationの問題設定:

- 「ユーザが次にどのアイテムと相互作用するかを予測すること」(=next-item prediction)
- データは時系列付きの異株グラフ(Heterogeneous graph)で表現される。
  - ノード $V$: ユーザ、アイテム、その他のエンティティ 
    - ユーザ集合 $L \subset V$
    - アイテム集合 $R \subset V$
  - エッジ $E$: 行動(クリック、購入、タグ付けなど)
  - ノードタイプ $\phi(v)$, エッジタイプ $\phi(e)$が定義される。
- time step $T$ までの履歴グラフ $G^{(-\infty, T)}$ を使って、time step $(T, T+i)$ に登場するground-truthアイテム集合 $Y_{v}^{(T, T+i)}$ を予測する。

### 静的 vs 時系列グラフの違い

- time stepがないと、静的なリンク予測問題になる。
- でも、現実の推薦タスクは時間依存が重要（直近の行動が大事！）なので、時系列グラフで扱いたい。
- この設定は新規ユーザ・新規アイテムも扱える!

### 重要な指標 Locality Score!

- Locality Scoreとは??
  - 将来のground-truthな相互作用アイテムが、**過去のユーザ近傍（$k$-hop）にどれだけ存在してるか？**を測る指標!
  - $k$-hop近傍とは、ユーザ $v$ を中心に$k$ステップで到達可能なノードの集合。
  - **スコアが高いと「次にユーザが相互作用するアイテムは、過去の近傍に多く存在する = 再訪傾向あり」**

- Locality Scoreの計算式は以下。
  - ここで...
    - $L$ はユーザノードの集合。$R$ はアイテムノードの集合。
    - $N_{k}^{(-\infty,T]}(v)$ はユーザ $v$ の $k$-hop近傍ノード集合。
    - $Y_{v}^{(T,T+i]}$ はユーザ $v$ が $(T, T+i]$ にて相互作用したアイテム集合。
  - 日本語にすると...「ユーザ $v$ の $k$-hop近傍にあるアイテムのうち、$(T, T+i]$ に相互作用したアイテムの割合、の全ユーザ平均」。

$$
s_{k}^{(T, T+i]} = \frac{1}{|L|} 
\sum_{v \in L} \frac{N_{k}^{(-\infty,T]}(v) \cap R \cap Y_{v}^{(T,T+i]}}{|Y_{v}^{(T,T+i]}|}
$$

- kの値ごとのlocality Scoreの解釈
  - $k=1$: 自分が以前に相互作用したアイテム(リピート傾向)
  - $k=2$: 友人・近傍ユーザの行動 (CF的な傾向)
  - $k=3$: 類似ユーザが見たアイテム (CF的な傾向)
  - $k>3$: 計算コストが重すぎて現実的じゃない.
- 実験を経て観察されたLocality Scoreの傾向:
  - $s_k \leq 0.5$ → 探索的（exploratory）な推薦が多数派！
  - ただし：
    - rel-hm（ファッションEC）や rel-stack（Q&A）では $k=1$でもスコア高い → リピート傾向強い
    - rel-amazon では $k$ 増やすとスコア上昇 → CFっぽい構造あり
  - **データやユースケースによって再訪/探索の傾向が大きく異なる**。

### ペアワイズモデルの限界!

- ペアワイズGNNモデルは、ローカルに強い ($k < 3$ くらい)
- しかし locality Score < 0.5 のケースが多い。**つまり全体の半分以上のground-truthアイテムはローカルにない。**
- よって、ペアワイズモデル単独では不十分! グローバル表現との統合が必要!

## 提案手法 ContextGNN

### 全体像:
  - ContextGNNは、**同じGNNバックボーン**の上に2つの別々なアーキテクチャ（ペアワイズ＋ツータワー）を組み合わせたハイブリッド構造。
  - **ペアワイズ表現** → ローカルなユーザ中心のサブグラフで候補アイテムを評価。
  - **ツータワー表現** → ユーザのサブグラフ外にある全ユーザ×全アイテムのペアをランキング。
  - 最終スコアは**MLPで学習されたユーザ固有の融合スコア**を使って、両者をうまくブレンド。

### ペアワイズ表現

- ベースはZhuらのNBFNetを拡張。
- 特徴
  - hoge



### ツータワー表現

- 目的: ユーザのサブグラフ外にあるアイテム評価を補完するためのフォールバック


