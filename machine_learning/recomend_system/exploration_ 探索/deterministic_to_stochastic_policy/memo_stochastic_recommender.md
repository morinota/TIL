# 確率的な方策 (stochastic policy) による推薦システムを考える

## プラケット・ルースモデル(Plackett-Luce model, PLモデル)を使って、ランキング方策をstochasticにする

- ランキング方策 (ランキング集合 $\Pi(A)$ 上の条件付き確率分布) をパラメータ化する際は、ランキング内で同一アイテムの重複を生まないような工夫が必要。
- よく用いられる方法として「反実仮想機械学習」で紹介されてたのが、**プラケット・ルースモデル(Plackett-Luce model, PLモデル)**という方法。

PLモデルがやりたいことは以下:
  
- まず、特徴量 $x$ ごとに個別のアイテム $a \in A$ にスコアを割り当てる関数 $f_{\theta}: X \times A -> \mathbb{R}$ を線形モデルやNNを用いて用意しておく。
- そして、 $\theta$ でパラメータ化されたスコア関数 $f_{\theta}$ に基づいて、ランキング $\mathbf{a}$ を確率的にサンプリングすること。

### PLモデルのアルゴリズム

PLモデルに基づくランキングの確率的サンプリングは以下のように行う:

```python
def plackett_luce_sampling(f_theta: ScoreFunction, x: FeatureVector)->list[Item]:
    """
    PLモデルに基づくランキングの確率的サンプリング
    """
    A_1 = A
    K = 50 # ランキングの長さ
    ranking = []
    for k in range(K):
        # k番目のポジションに提示するアイテムを選択(softmax関数を使って条件付き確率分布を定義してサンプリング)
        a_k = plackett_luce_choice(f_theta, x, A_1)
        ranking.append(a_k)

        # 選択されたアイテム a_k を行動集合から除外
        A_1 = A_1 - {a_k}
    
    return ranking
```

PLモデルに基づいてランキング $\mathbf{a}$ を生成することは、以下のランキング方策を適用していることと等価である。

$$
\pi_{\theta}(\mathbf{a}|x)
= \prod_{k=1}^{K} \frac{exp(f_{\theta}(x, \mathbf{a}(k)))}{\sum_{a' \in A_k} exp(f_{\theta}(x,a'))}
\tag{1}
$$

しかし実際には、上記のアルゴリズムは現場の推薦・検索システムに適用するには計算量の問題で難しい。(**ソフトマックス関数を何度も計算する必要がある**ため...!:scream:)

### ガンベルソフトマックストリック(Gumbel-Softmax trick)を使って高速化

- 前述のように、originalのPLモデルのアルゴリズムは計算量が大きく、実用的ではない。(特にリアルタイム推論の上では...!)
  - ガンベルソフトマックストリック(Gumbel-Softmax trick)と呼ばれるテクニックを使うことで、**PLモデルに基づいた確率的なランキング方策を効率化して高速化できる**ことが知られている。

ガンベルソフトマックストリックが行うこと:

- 1. 各アイテムのスコア $f_{\theta}(x,a)$ を用意する。
- 2. スコアに対してガンベル分布に従うノイズを加えた値を用意する。
- 3. スコア+ノイズの値が、大きい順にアイテムを並び替えてランキングを作成する。
  
数式で表すと以下。

$$
\mathbf{a} = argsort_{a \in A} \{ f_{\theta}(x,a) + \epsilon_{a} \}
\\
\epsilon_{a} \sim Gumbel(0,1)
\tag{2}
$$

- ここで、$Gumbel(0,1)$ は標準ガンベル分布を表す。

- **実は、式(2)のガンベルソフトマックストリックでランキングを生成することは、式(1)のPLモデルに基づくランキングの確率的サンプリングと同等であることが知られている**。
- ガンベルソフトマックストリックを使うことで、ソフトマックス関数を適用することなくスコア関数に基づいたランキングを確率的に生成できるため、計算効率の意味で非常に嬉しい。

### なんで式(1)と式(2)が等価なの？？

- まずGumbel分布の性質。
  - 連続確率分布の一種。
  - さまざまな確率分布に従う確率変数の、最大値(または最小値)が漸近的に従う分布である。
    - 極値分布(=確率変数の極値が従う確率分布)のタイプI型に相当する。
Gumbel分布の累積分布関数(CDF, Cumulative Distribution Function)は以下のようになる。

$$
F(x) = e^{-e^{-x}} = exp(-exp(-x))
$$

標準
