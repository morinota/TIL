# ランキングにおけるオフ方策評価についてメモ

- 1章にて、オフ方策評価の基本的な考え方や手法を学んだ。しかし実際の現場では、**より複雑な問題設定が必要なケース**が多々ある。
  - 代表的なものの一つが、**複数の行動を同時に選択したり並び替えたりする、いわゆるランキング問題**。
- ランキング問題では...
  - **行動空間が組み合わせ爆発的に増加**するため、1章の推定量をそのまま適用することは難しい。
- 本章では、ランキング問題において正確なオフ方策評価を行うための主流なアイデアとして、ユーザ行動に仮定をおくことで問題の厳密性と解きやすさのバランスを制御するアプローチと、それがもたらす重要なバイアス・バリアンストレードオフについて学ぶ。

## 2.1 ランキング問題の定式化

- 推薦や検索などのランキング問題 = ユーザの属性情報や行動履歴などによって構成される特徴量に基づいて、アイテムのランキングを選択し提示する**意思決定の問題**、として捉えることができる。

ランキングに関する意思決定最適化問題の定式化

- まず...
  - 特徴量ベクトル $x \in \mathbb{R}^d$
  - 商品やニュース記事などの個々のアイテム $a \in \mathcal{A}$
- アイテム集合 $\mathcal{A}$ に属する**アイテムを並び替えることで構成されるランキングをベクトル $\mathbf{a} := (a_1, a_2, \ldots, a_K) \in \Pi(A)$ で表す**。
  - 注意!: この定式化ではランキング長さ $K := |A|$ と置いている。実務ではもっと小さい値になることもあるので、必要に応じて $\Pi(A)$ の部分は変わるはず...!:thinking:
- また、**あるランキング $\mathbf{a}$ を提示した結果として観測される報酬を、同じくベクトル $\mathbf{r} := (r_1, r_2, \ldots, r_K) \in \mathbb{R}^K$ で表す**。
  - 各要素 $\mathbf{r}(k)$ は、k番目に提示されたアイテムで観測される報酬を表す(ex. クリック有無、視聴有無など...!)
- ランキング方策 $\pi: \mathcal{X} \to \Delta(\Pi(A))$ を、ランキング集合 $\Pi(A)$ 上の条件付き確率分布として定義する。
  - つまり、$\pi(\mathbf{a} | x)$ は、ある特徴量ベクトル $x$ が与えられたときに、特定のランキング $\mathbf{a}$ を選択する確率を意味する。

定式化された問題設定に基づくと、ランキング方策 $\pi$ による一連の意思決定プロセスは以下のようになる。
(添え字 $i$ はログデータの識別子)

- まず、未知の確率分布 $p(x)$ に従うユーザ情報などの特徴量 $x_i$ を観測する。（ここは1章と同じ！）
- 次に、観測した特徴量 $x$ に基づき、ランキング方策 $\pi(\mathbf{a} | x)$ が特定のランキング $\mathbf{a}_i$ を選択する。
- 最後に、特徴量 $x_i$ とランキング $\mathbf{a}_i$ に依存して、報酬ベクトル $\mathbf{r}_i$ が未知の確率分布 $p(\mathbf{r} | x, \mathbf{a})$ に従い観測される。

また、ランキング方策 $\pi$ の性能を次のように定義する:

$$
V(\pi) := E_{p(x) \pi(\mathbf{a} | x) p(\mathbf{r} | x, \mathbf{a})} [ \sum_{k=1}^K \alpha_k \mathbf{r}(k) ]
\\
= E_{p(x) \pi(\mathbf{a} | x)} [ \sum_{k=1}^K \alpha_k q_k(x, \mathbf{a}) ]
\tag{2.1}
$$

- ここで、
  - $q_k(x, \mathbf{a}) := E_{p(\mathbf{r} | x, \mathbf{a})} [ \mathbf{r}(k) ]$ は、特徴量 $x$ とランキング $\mathbf{a}$ が与えられた時にk番目のポジションで発生する報酬 $r(k)$ の期待値を表し、**ポジションレベルでの期待報酬関数 (position-level expected reward function)** と呼ぶ。(うんうん、わかる...!:thinking:)
  - また、$\alpha_k$ は、分析者によって事前に定義される k 番目のポジションの重要度を表すハイパーパラメータ。
- ランキング方策の性能 $V(\pi)$ は、その方策を環境に実装した際に得られる**ポジションごとの報酬の重み付き和の期待値**で定義されるのが通例らしい。
  - まあ我々が最適化したい報酬の定義によっても異なるだろうけど、だいたいこの定義で一般化できるのかも...!:thinking:

(メモ)ポジションの重要度ハイパーパラメータ $\alpha_k$ は、**既存のランキング指標を一般化したもの**としても理解できる...!:thinking:

- 前提として、分析者が自由に設定できる! (別に有名なランキング指標を知ってなくてもOK...!:)
- ex.) 
  - $\alpha_k = \mathbb{I}[k <= K] / K$ と定義すると... $V(\pi)$ は**有名なランキング指標 Precision@K に一致**する！
  - $\alpha_k = \mathbb{I}[k <= K]/ \log_{2}(k+1)$ と定義すると... $V(\pi)$ は**NDCG@K に一致**する！


