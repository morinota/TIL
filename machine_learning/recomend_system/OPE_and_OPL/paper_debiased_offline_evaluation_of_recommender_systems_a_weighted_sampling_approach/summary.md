# Debiased offline evaluation of recommender systems: a weighted-sampling approach

published date: 30 March 2020,
authors: Diego Carraro, Derek Bridge
url(paper): https://dl.acm.org/doi/10.1145/3341105.3375759
(勉強会発表者: morinota)

---

## どんなもの?

LINEさんの推薦システムのアルゴリズム評価にてこの論文のアプローチを活用してる、との話を聞き読んでみました...!! (参考: [LINEサービス向けの効率的かつ効果的な推薦システム開発に向けて -日本語版-](https://www.youtube.com/watch?v=GgfsclpdSjY))

- 推薦システムのオフライン評価は、多くの場合、様々な交絡因子によって生成されたbiasを含む過去のデータに依存するよ.
  - このようなデータは、**ユーザとアイテムの interaction はMNAR（Missing Not At Random）**だよ. (i.e. 評価行列内の欠損値の発生傾向がランダムではない、という事だよ!)
- MNARテストデータによる推薦システムの性能測定は、biasを軽減するための工夫がない限り、オンライン環境での性能を正しく反映しない事が多いよ.
  - biasを除去する一つのアプローチは、**MNARテストデータで使用するための新しい不偏の性能推定量**を設計する事だよ. (i.e. 損失関数やmetricの形を、真に求めたいオンライン性能の不偏推定量になるように変形させる事だよ.)
- ただ本論文では、別のアプローチとして**サンプリングアプローチ**を対象に調査しているよ.
  - サンプリングアプローチの一般的なアイデアは、MNARデータに対してサンプリング戦略を用いて、よりbiasの少ない **intervened(=介入) test set**を生成する事だよ.
    - intervened(=介入) test set は、u&iのinteractionが**MAR(Missing At Random)**であるデータ、もしくは少なくともよりMARに近いデータを目指すよ.
  - 例えば **SKEW** という手法では、**"アイテムの人気度"がinteractionの観測されやすさに与える影響**(交絡効果)を調整する事を目的としてサンプリング戦略を工夫しているよ.
- 本論文では、SKEWの拡張ver.として、サンプリングアプローチの為の新しい定式化を提案しているよ.
  - ざっくり説明すると、MNARデータにおけるユーザとアイテムの分布と、目指すべき不偏のMAR分布との**乖離**を考慮して重みを計算する、**重み付けサンプリング戦略**だよ.
- 提案した戦略は、**高い汎用性(ex. 推薦システムの学習にも利用可能!)** と **低いoverheads(ex. 事前の学習を必要としない)**の利点があるよ.
- 本論文で提案した手法は、Implicit feedbackにもexplicit feedbackにも適用可能...!!(フレームワークのgenerality、素晴らしい...!)

## 先行研究と比べて何がすごい?

MNARな観測データセットを用いた古典的なオフライン評価は、実質的に、観測データセットから欠落したinteraction(i.e. 評価行列内のゼロ要素だよ!)は、**MCAR(Missing Completely At Random)**または**MAR(Missing At Random)**のいずれかであると仮定しているよ.
MNARデータをMCARやMARであるかのように推薦アルゴリズムの評価で使用すると、真の推薦システム性能の偏った推定結果になるよ.

### MNARデータによる推薦アルゴリズム評価に対処する3種のアプローチ

- 1. 最も簡単なアプローチは(少なくとも理論的には)、オフライン評価のためにMNARデータセットの代わりにMARデータセットを収集し採用することだよ.
  - 評価に（偏りのない）MARデータを使用することで、レコメンダーの性能を偏りなく推定することができるよ.
  - ドメインによっては、小さなMARのようなデータセットを収集する方法があるよ.
  - しかし、多くのドメインでは、MARのようなデータセットを入手するのは非現実的であったり、コストがかかりすぎたりして困難だよ.
  - よって、他の2つの方法では、入手可能で量も多いMNARデータを使用しつつ、そのバイアスを軽減する事に焦点を当てているよ.
- 2. MNARテストデータのバイアスを補正する推定量(＝evaluation metrics)を設計することだよ. (MNARデータによる学習時の目的関数も同様に補正するよ.)
  - バイアス軽減の目的をある程度達成する事ができるよ.
  - ただ不偏推定量には2つの潜在的な欠点があるよ.
    - 欠点1: バイアスのすべての原因を克服するのに十分な汎用性がないかもだよ. (全ての原因に対応する推定量を設計するのはかなり難しくてかつ複雑になりそう...!)
    - 欠点2: 観測データがいくつかの特定の仮定・条件を満たす場合にのみ、不偏性が証明される推定量が多いよ. (ex. 推薦結果が決定的ではなく確率的に生成されている必要がある、etc.)
- 3. 評価(や学習?)に使う前に、MNARのテストデータ(や学習データ?)にintervene(介入)することだよ.
  - 実際には、この"介入"は、利用可能なMNARテストデータからサンプリングするサンプリング戦略によって実行されるよ.
    - サンプリング戦略は、介在するテストセットが偏りにくく(よりMARに近づくように...!)、レコメンダーの性能評価に適していると考えられるように選択されるよ.
  - 有名なサンプリング戦略の一つに、SKEWがあるよ.
    - アイテムの人気度に反比例してユーザとアイテムの interaction をサンプリングし、人気バイアスを低減したテストデータを作成するよ.

本論文では、第三のアプローチに関連して、intervenedデータ を生成するためのSKEWサンプリング戦略に代わる新しい方法を調査・提案するよ.
本手法は一般的であり、**レコメンダーのトレーニングに使用するデータをdebiasする**ためにも採用できるよ.
あと、本論文では、SKEWの有効性を実証的に検証するよ...!

### MNAR, MAR, MCARと欠損データメカニズム

MNAR, MAR, MCARの区分は欠損データ分析理論(missing data analysis theory)に基づいており、最初に[16]によって提案され、後に[18]によって推薦者システムの文献に紹介されたよ.

- 元論文[16,18]によるMARとMCARの区分:
  - MCAR:
    - ユーザとアイテムのinteractionが欠損しているかどうかは、interaction value(ratingの星の数の違いや、clickとpurchaseの違いなど)に全く依存しない、つまり、**観測された interaction value にも欠損した interaction value にも依存しないこと**を意味するよ.
  - MAR:
    - ユーザとアイテムのinteractionが欠損しているかどうかは、**観測されたinteraction valueには依存するかもしれないが、欠損したinteraction valueには依存しないこと**を意味するよ.
      - 欠損値の発生はランダムだが、非ゼロ要素の中の分布はランダムではない...!(ex. ユーザは星5の方が、星1よりもratingをつけやすい...!)

## 技術や手法の肝は？

- メモ: 推薦システムの文脈でいう"交絡因子"の解釈について.
  - 因果推論の文脈で"交絡因子"とは、「交絡因子->原因変数, 交絡因子->結果変数」の向きに因果関係が存在する場合に、「原因変数->結果変数」の間に擬似的な相関関係を発生させるような第三の因子。
  - 推薦システムだとどう解釈したらいいんだろう...?以下の様な感じ?
    - 原因: ユーザuがアイテムiを好き!
    - 結果: ユーザuとアイテムiの間にInteraction(ex. click, purchase, rating)が記録される.
    - 交絡因子: (ex. アイテムの表示される位置、人気なアイテムはユーザの目につきやすい、過去に推薦したアイテムがユーザに見られやすい、星1のアイテムよりも星5のアイテムの方がratingをつけやすい、etc.)
      - 推薦システムの文脈における"交絡因子"は、必ずしも因果関係の矢印の向きは気にする必要なさそう...! ざっくり「原因->結果」の間に擬似的な相関関係を発生させるような第三の因子、みたいな.

### MARとMNARのデータセットの特性を分析する為の確率的フレームワークを定義

サンプリング戦略を決定する前に、MARデータやMNARデータの性質はかくあるべき、というような内容を定義する.

以下は本研究において定義されたnotationだよ.

- 観測データセット$D$:
  - $D = {O \in {0, 1}^{U \times I}, Y \in \mathbb{R}^{U \times I}}$
- $O$:
  - ユーザとアイテムにおいて、interactionが観測された場合は$O_{u,i} = 1$、そうでない場合は $O_{u,i} = 0$ となるbinary行列.
- $Y \in R^{U \times I}$ :
  - Oの対応する観測entryのinteraction value を記録する関連行列.
  - $O_{u,i} = 1$のとき$Y*{u,i} \neq 0$、それ以外は $Y\_{u,i} = 0$.
  - $Y$ について議論するとき、**本フレームワークの一般性を強調するため**に、"rating"ではなく、「**interaction value(相互作用値)**」という一般的な用語を使用する： Yは、評価、クリック数、閲覧数、聴取頻度など、 $\mathbb{R}$ のあらゆる種類の値を取ることができる. (フレームワークの一般性、素晴らしい...!!)
- binary確率変数$Q$:
  - 行列Oに含まれるユーザアイテム対の集合を対象とした二値確率変数 $Q: U \times I → {0, 1}$.
  - ユーザアイテム間のinteractionが観測された場合にQ = 1、それ以外の場合にQ = 0と定義.
  - 本論文では、P(Q = 1)の代わりにP(Q)という略語を使う.

これらの表記(notation)を用いると、同じU×I空間上の2種類のデータセット、$D_{mnar} = {O^{mnar},Y^{mna}}$と $D_{mar} = {O^{mar} ,Y^{mar}}$ を、それぞれMNARとMARの特性を持つものとして参照する事ができるよ.

#### MARデータセットの特性を定義

MARデータ $D_{mar}$ の生成過程についてモデル化を試みるよ.

既存研究のアプローチ1であるforced ratings approachを考慮して定義するよ.
まず、ユーザとアイテムのペアをランダムにサンプリングして、$O^{mar}$を生成するよ.
そして、$O^{mar}$の各ペアのプリファレンス(Interaction value)を収集すると、$Y^{mar}$を得ることができるよ.
なお、**MAR特性を満たすために、$O^{mar}$の生成は$Y^{mar}$から完全に独立しており、特定のユーザとアイテムのペア（u,i）からも独立していること**を特徴とするよ.
また、O marが決まれば、O marに含まれるすべてのユーザとアイテムのペアのinteraction value $Y^{mar}$を得ることができると仮定するよ. (ただし実際のforced ratings approachでは、ユーザが協力を断ったり、一部のアイテムの評価を拒否したりするので、現実世界では必ずしもこの仮定は成立しないよ.)

空間U×I上で定義される確率分布$P_{mar}(Q|u,i)$ を利用し、$O^{mar}$を導出するよ.
シンプルな選択は、$P_{mar}(Q|u,i) = P(Q) = \rho_{mar}$ と仮定する事だよ(=u,iで条件付けられたQの分布と、Qの周辺分布が等しい=>観測されやすさQはu,iに依存しない設定...!).
ここで$\rho_{mar}$ は、U×Iから観測されたエントリーの望ましい比率(=評価行列内の何割が観測されているべきか...!)を表すよ.

さて、このような手法で収集されたデータセット $D_{mar}$ を想定して、**ユーザとアイテムの事後確率が（ほぼ）一様に分布していることを経験的に検証する**必要があるよ.

$$
P_{mar}(u|Q) = \frac{|O_{u}^{mar}|}{O^{mar}} \sim \frac{1}{|U|}, \forall u \in U
\tag{1}
$$

$$
P_{mar}(i|Q) = \frac{|O_{i}^{mar}|}{O^{mar}} \sim \frac{1}{|I|}, \forall i \in I
\tag{2}
$$

ここで、$O^{mar}_{u}$と$O^{mar}_{i}$はそれぞれ、ユーザuとアイテムiのO marで観測されたInteractionか否かのbinary値だよ.
また、ユーザとアイテムは独立なはずため、それらの事後分布は独立であることがわかるので、以下のように書くことができるよ:

$$
P_{mar}(u,i|Q) = P_{mar}(u|Q) \cdot P_{mar}(i|Q) \in \frac{1}{|U||I|}, \forall(u,i) \in U \times I
\tag{3}
$$

ここで、$P_{mar}(u,i|Q)$は、特定のユーザとアイテムのペアの共同事後分布(=事後分布の同時分布、みたいな?)を表す。(Q=1のあるinteractionが得られた場合、それがユーザu & アイテムiである確率、のイメージ...!)

#### MNARデータセットの特性を定義

MNARデータは推薦システムの運用中に収集されるけど、**MARデータの生成過程をモデル化**したのと同様に、最初に$O^{mnar}$、その後に$Y^{mnar}$を決定する方法でモデル化するよ.

MARシナリオとは異なり，バイアスが存在するため，**サンプリング分布**$P_{mnar}$がinteraction value $Y^{mnar}$（あるいは特定のユーザーとアイテム（u,i）を含む他の交絡因子からも）から独立していると仮定することはできないよ.
つまりMNARデータセットは、一般的に未知の確率 $P_{mnar}(Q|u,i,Y,X)$ によって生成されるよ.
ここで、$Y⊃Y^{mnar}$は**ユーザとアイテムのinteractionの完全なセット**(答えって事だろうか...??ゼロ要素が存在しない評価行列)を表すよ.
また、Xはサンプリング確率に影響を与える特徴(共変量、交絡因子)のセット(例えば、ユーザのデモグラフィック、アイテムの特徴、アイテムをユーザに公開する方法などのシステムの特徴など)を意味するよ.

MNARデータセット $D_{mnar}$ が収集されている場合、MARデータセットで行ったように、 $O^{mnar}$ のユーザとアイテムの事後確率を調べることができるよ.
今度は一般的に、次のことが分かるよ:
(ここでいう事後確率は、O=1のinteractionをランダムに取得した時に、それがユーザuのinteractionである確率、みたいなイメージ...??)

$$
P_{mnar}(u|Q) = \frac{|O^{mnar}_{u}|}{O^{mnar}} \neq = \frac{1}{|U|}, \forall u \in U
\tag{4}
$$

$$
P_{mnar}(i|Q) = \frac{|O^{mnar}_{u}|}{O^{mnar}} \neq = \frac{1}{|U|}, \forall u \in U
\tag{5}
$$

一般に、**行列Oの非ゼロ要素についてユーザとアイテムは一様に分布しているわけではない**ので、特定のエントリーが観測された場合、すなわち$Q = 1$の場合、共同事後確率$P_{mnar}(u,i|Q)$ に対してユーザとアイテムの事後独立性は仮定できないよ.

$$
P_{mnar}(u,i|Q) \neq P_{mnar}(u|Q) \cdot P_{mnar}(i|Q), \forall (u,i) \in U \times I
\tag{6}
$$

(なるほど...?これらの事後確率の定式化をサンプリング戦略で使うのか!)
(このセクションは、MARデータやMNARデータの性質はかくあるべき、というような話だっけ??)

### サンプリング戦略によるIntervened Testデータの生成

**偏ったデータから偏りのない評価を行うため**に、古典的なhold-outテストセットの代わりに、**intervenedテストセット**を生成して使用するよ.

## どうやって有効だと検証した?

提案したサンプリング手法をSKEWと比較するよ.
この実験により、SKEWの有効性を初めて実証的に評価することができたよ.

## 議論はある？

## 次に読むべき論文は？

## お気持ち実装
